<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ê–¥–º–∏–Ω–∫–∞ ‚Äî –°–µ–º–µ–π–Ω–æ–µ –¥–µ—Ä–µ–≤–æ</title>
<style>
body {
  font-family: sans-serif;
  max-width: 800px;
  margin: 40px auto;
}
#editor { display: none; }
textarea { width: 100%; height: 400px; }
input { margin: 5px 0; padding: 5px; width: 100%; }
button { padding: 8px 16px; margin-top: 8px; cursor: pointer; }
</style>
</head>
<body>

<h2>–ê–¥–º–∏–Ω–∫–∞ ‚Äî –°–µ–º–µ–π–Ω–æ–µ –¥–µ—Ä–µ–≤–æ</h2>

<div id="login">
  <p>–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:</p>
  <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å">
  <button onclick="login()">–í–æ–π—Ç–∏</button>
</div>

<div id="editor">
  <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ data.json</h3>
  <label>GitHub Token:</label>
  <input id="token" placeholder="github_pat_..." />
  <textarea id="json"></textarea>
  <button onclick="save()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ GitHub</button>
</div>

<script>
const PASSWORD_HASH = "8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918"; // hash –æ—Ç "admin"
const OWNER = "m1zalk";
const REPO = "familytree";
const FILE_PATH = "data.json";

async function sha256(str) {
  const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(str));
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, "0")).join("");
}

async function login() {
  const pass = document.getElementById('password').value;
  if (await sha256(pass) !== PASSWORD_HASH) {
    alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å");
    return;
  }
  document.getElementById('login').style.display = 'none';
  document.getElementById('editor').style.display = 'block';
  const saved = localStorage.getItem('gh_token');
  if (saved) document.getElementById('token').value = saved;
  const jsonText = await fetch(FILE_PATH, { cache: "no-store" }).then(r => r.text());
  document.getElementById('json').value = jsonText;
}

async function getFileSha(token) {
  const url = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE_PATH}`;
  const res = await fetch(url, {
    headers: { "Authorization": "Bearer " + token }
  });
  const data = await res.json();
  return data.sha;
}

async function save() {
  try {
    const token = document.getElementById('token').value.trim();
    if (!token) { alert("–í—Å—Ç–∞–≤—å GitHub token"); return; }
    localStorage.setItem('gh_token', token);
    const raw = document.getElementById('json').value;
    JSON.parse(raw);
    const sha = await getFileSha(token);
    const content = btoa(unescape(encodeURIComponent(raw)));
    const url = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE_PATH}`;
    const res = await fetch(url, {
      method: "PUT",
      headers: {
        "Authorization": "Bearer " + token,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        message: "update data.json",
        content,
        sha
      })
    });
    if (!res.ok) throw new Error(await res.text());
    alert("‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ GitHub! –ß–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥ –æ–±–Ω–æ–≤–∏—Ç—Å—è —Å–∞–π—Ç.");
  } catch (e) {
    alert("–û—à–∏–±–∫–∞: " + e.message);
  }
}
</script>
</body>
</html>


