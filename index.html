<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FamilyTree ‚Äî –≤–∏–∑—É–∞–ª—å–Ω–æ–µ –¥–µ—Ä–µ–≤–æ</title>

  <!-- React -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* ‚Äú–ö–∞–∫ —Ä–∞–Ω—å—à–µ‚Äù –ª–∏–Ω–∏–∏ (CSS) */
    .ft-children { position: relative; padding-top: 18px; margin-top: 12px; }
    .ft-children:before{
      content:""; position:absolute; left:50%; top:0; width:0; height:18px;
      border-left:2px solid rgba(100,116,139,.55); transform: translateX(-1px);
    }
    .ft-children-row{
      position:relative; display:flex; gap:16px; justify-content:center; flex-wrap:wrap; padding-top:14px;
    }
    .ft-children-row:before{
      content:""; position:absolute; left:12px; right:12px; top:0;
      border-top:2px solid rgba(100,116,139,.55);
    }
    .ft-child-wrap{ position:relative; padding-top:14px; }
    .ft-child-wrap:before{
      content:""; position:absolute; left:50%; top:0; width:0; height:14px;
      border-left:2px solid rgba(100,116,139,.55); transform: translateX(-1px);
    }

    /* –°–∫—Ä–æ–ª–ª –Ω–∞ –¥–µ—Ä–µ–≤–µ */
    .soft-scroll::-webkit-scrollbar { height: 10px; width: 10px; }
    .soft-scroll::-webkit-scrollbar-thumb { background: rgba(148,163,184,.7); border-radius: 999px; }
    .soft-scroll::-webkit-scrollbar-track { background: rgba(226,232,240,.8); border-radius: 999px; }
  </style>
</head>

<body class="bg-slate-950">
  <div id="root"></div>

<script type="text/babel">
const { useEffect, useMemo, useState } = React;

/* =========================
   –ù–ê–°–¢–†–û–ô–ö–ò
========================= */
const ADMIN_PASSWORD = "1234"; // –ø–æ–º–µ–Ω—è–π –ø–∞—Ä–æ–ª—å –∑–¥–µ—Å—å

/* =========================
   DEFAULT DATA (–∑–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–∏)
========================= */
const DEFAULT_PEOPLE = [
  { id:"p1", firstName:"–ò–≤–∞–Ω", lastName:"–ò–≤–∞–Ω–æ–≤", gender:"M", birthDate:"1960-01-01", deathDate:"", notes:"" },
  { id:"p2", firstName:"–ê–Ω–Ω–∞", lastName:"–ò–≤–∞–Ω–æ–≤–∞", gender:"F", birthDate:"1962-05-15", deathDate:"", notes:"" },
  { id:"p3", firstName:"–ü—ë—Ç—Ä", lastName:"–ò–≤–∞–Ω–æ–≤", gender:"M", birthDate:"1990-09-09", deathDate:"", notes:"" },
  { id:"p4", firstName:"–ú–∞—Ä–∏—è", lastName:"–°–º–∏—Ä–Ω–æ–≤–∞", gender:"F", birthDate:"1992-11-20", deathDate:"", notes:"" },
  { id:"p5", firstName:"–°–æ—Ñ–∏—è", lastName:"–ò–≤–∞–Ω–æ–≤–∞", gender:"F", birthDate:"2018-03-02", deathDate:"", notes:"" }
];

const DEFAULT_RELATIONSHIPS = [
  { id:"r1", type:"marriage", person1Id:"p1", person2Id:"p2", marriageDate:"1985-07-01", divorceDate:"" },
  { id:"r2", type:"parent-child", parentId:"p1", childId:"p3" },
  { id:"r3", type:"parent-child", parentId:"p2", childId:"p3" },

  { id:"r4", type:"marriage", person1Id:"p3", person2Id:"p4", marriageDate:"2016-08-10", divorceDate:"" },
  { id:"r5", type:"parent-child", parentId:"p3", childId:"p5" },
  { id:"r6", type:"parent-child", parentId:"p4", childId:"p5" }
];

const DEFAULT_COMMENTS = [];

/* =========================
   STORAGE ADAPTER
   (—Å–µ–π—á–∞—Å localStorage; –ø–æ—Ç–æ–º –∑–∞–º–µ–Ω–∏–º –Ω–∞ Firebase/Supabase)
========================= */
const Storage = {
  _keys: {
    people: "ft3_people",
    rels: "ft3_rels",
    comments: "ft3_comments"
  },
  async load() {
    const p = localStorage.getItem(this._keys.people);
    const r = localStorage.getItem(this._keys.rels);
    const c = localStorage.getItem(this._keys.comments);
    return {
      people: p ? safeJsonParse(p, DEFAULT_PEOPLE) : DEFAULT_PEOPLE,
      relationships: r ? safeJsonParse(r, DEFAULT_RELATIONSHIPS) : DEFAULT_RELATIONSHIPS,
      comments: c ? safeJsonParse(c, DEFAULT_COMMENTS) : DEFAULT_COMMENTS
    };
  },
  async save({ people, relationships, comments }) {
    localStorage.setItem(this._keys.people, JSON.stringify(people));
    localStorage.setItem(this._keys.rels, JSON.stringify(relationships));
    localStorage.setItem(this._keys.comments, JSON.stringify(comments));
  }
};

/* =========================
   UTILS
========================= */
function safeJsonParse(v, fallback){ try { return JSON.parse(v); } catch { return fallback; } }
function uid(prefix="id"){ return prefix+"_"+Math.random().toString(16).slice(2)+"_"+Date.now().toString(16); }
function fmtDate(d){
  if(!d) return "";
  try{ const dt=new Date(d); if(Number.isNaN(dt.getTime())) return d; return dt.toLocaleDateString("ru-RU"); }
  catch{ return d; }
}
function fullName(p){
  const ln=(p?.lastName||"").trim();
  const fn=(p?.firstName||"").trim();
  return [ln,fn].filter(Boolean).join(" ").trim() || "(–±–µ–∑ –∏–º–µ–Ω–∏)";
}
function genderLabel(g){ if(g==="M") return "–ú"; if(g==="F") return "–ñ"; return "‚Äî"; }
function sortByName(a,b){ return fullName(a).toLowerCase().localeCompare(fullName(b).toLowerCase(),"ru"); }

function Badge({children}){
  return <span className="inline-flex items-center rounded-full border border-white/10 bg-white/5 px-2 py-0.5 text-xs text-white/80">{children}</span>;
}
function Btn({children, onClick, variant="primary", className=""}){
  const base="px-3 py-2 rounded-xl text-sm font-medium transition border";
  const styles={
    primary:"bg-indigo-500/90 hover:bg-indigo-500 text-white border-white/10",
    ghost:"bg-white/5 hover:bg-white/10 text-white border-white/10",
    danger:"bg-rose-500/85 hover:bg-rose-500 text-white border-white/10",
    ok:"bg-emerald-500/85 hover:bg-emerald-500 text-white border-white/10"
  };
  return <button onClick={onClick} className={base+" "+styles[variant]+" "+className}>{children}</button>;
}
function Card({children, className=""}){
  return <div className={"rounded-2xl border border-white/10 bg-slate-900/60 shadow-[0_0_0_1px_rgba(255,255,255,0.03)] "+className}>{children}</div>;
}

/* =========================
   VISUAL TREE (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)
========================= */
function FamilyTree({ people, relationships, selectedPersonId, onSelect }) {
  const peopleById = useMemo(() => {
    const m=new Map(); for(const p of people) m.set(p.id,p); return m;
  },[people]);

  const marriages = useMemo(()=>relationships.filter(r=>r.type==="marriage"),[relationships]);
  const parentLinks = useMemo(()=>relationships.filter(r=>r.type==="parent-child"),[relationships]);

  const childrenOf = (pid)=> parentLinks.filter(r=>r.parentId===pid).map(r=>r.childId);
  const spousesOf = (pid)=>
    marriages
      .filter(r=>r.person1Id===pid || r.person2Id===pid)
      .map(r=>({ rel:r, spouseId:(r.person1Id===pid ? r.person2Id : r.person1Id) }));

  const roots = useMemo(()=>{
    const hasParent=new Set(parentLinks.map(r=>r.childId));
    const r=people.filter(p=>!hasParent.has(p.id)).map(p=>p.id);
    return r.length ? r : people.map(p=>p.id);
  },[people,parentLinks]);

  const childrenOfUnion = (a,b=null)=>{
    const ca=new Set(childrenOf(a));
    if(!b) return Array.from(ca);
    const cb=new Set(childrenOf(b));
    const both=[]; for(const id of ca) if(cb.has(id)) both.push(id);
    return both;
  };

  function PersonNode({p}){
    const sel = p.id===selectedPersonId;
    return (
      <button
        onClick={()=>onSelect(p.id)}
        className={
          "min-w-[180px] max-w-[240px] text-left px-3 py-2 rounded-2xl border transition " +
          (sel
            ? "bg-indigo-500/15 border-indigo-400/60"
            : "bg-white/5 border-white/10 hover:bg-white/10")
        }
        title={fullName(p)}
      >
        <div className="flex items-center gap-2">
          <div className="font-semibold text-white truncate">{fullName(p)}</div>
          <span className="ml-auto text-xs text-white/70">{genderLabel(p.gender)}</span>
        </div>
        <div className="mt-1 text-xs text-white/60">
          {p.birthDate ? `—Ä. ${fmtDate(p.birthDate)}` : "–¥–∞—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞"}
          {p.deathDate ? ` ‚Ä¢ —É–º. ${fmtDate(p.deathDate)}` : ""}
        </div>
      </button>
    );
  }

  const FamilyNode = ({ parentAId, parentBId=null, visitedUnions }) => {
    const a=peopleById.get(parentAId);
    const b=parentBId ? peopleById.get(parentBId) : null;
    if(!a) return null;

    const unionKey = parentBId ? [parentAId,parentBId].sort().join("|") : parentAId+"|solo";
    if(visitedUnions.has(unionKey)) return null;
    visitedUnions.add(unionKey);

    const kids = childrenOfUnion(parentAId,parentBId)
      .map(id=>peopleById.get(id))
      .filter(Boolean)
      .sort(sortByName);

    return (
      <div className="flex flex-col items-center">
        <div className="flex items-center gap-3 flex-wrap justify-center">
          <PersonNode p={a}/>
          {b && (<><div className="text-white/35 text-sm">‚Äî</div><PersonNode p={b}/></>)}
        </div>

        {kids.length>0 && (
          <div className="ft-children w-full">
            <div className="ft-children-row">
              {kids.map(child=>{
                const childSpouses = spousesOf(child.id)
                  .filter(x=>peopleById.get(x.spouseId))
                  .sort((x,y)=>fullName(peopleById.get(x.spouseId)).toLowerCase()
                    .localeCompare(fullName(peopleById.get(y.spouseId)).toLowerCase(),"ru"));

                return (
                  <div key={child.id} className="ft-child-wrap">
                    {childSpouses.length ? (
                      <div className="flex flex-col items-center gap-8">
                        {childSpouses.map(({spouseId})=>(
                          <FamilyNode
                            key={child.id+"_"+spouseId}
                            parentAId={child.id}
                            parentBId={spouseId}
                            visitedUnions={visitedUnions}
                          />
                        ))}
                      </div>
                    ) : (
                      <FamilyNode
                        parentAId={child.id}
                        parentBId={null}
                        visitedUnions={visitedUnions}
                      />
                    )}
                  </div>
                );
              })}
            </div>
          </div>
        )}
      </div>
    );
  };

  // –ö–æ—Ä–Ω–µ–≤—ã–µ –±–ª–æ–∫–∏: –µ—Å–ª–∏ –æ–±–∞ –∫–æ—Ä–Ω—è –≤ –±—Ä–∞–∫–µ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–¥–∏–Ω —Ä–∞–∑
  const rootUnionKeys = new Set();
  const rootBlocks = [];
  for(const rid of roots){
    const rSp = spousesOf(rid).map(x=>x.spouseId).filter(sid=>roots.includes(sid));
    if(rSp.length){
      for(const sid of rSp){
        const key=[rid,sid].sort().join("|");
        if(rootUnionKeys.has(key)) continue;
        rootUnionKeys.add(key);
        rootBlocks.push({a:rid,b:sid});
      }
    } else {
      rootBlocks.push({a:rid,b:null});
    }
  }

  return (
    <div className="soft-scroll overflow-auto">
      <div className="min-w-[980px] py-6 px-4">
        <div className="flex items-center gap-2 mb-4">
          <div className="text-white font-semibold text-lg">–í–∏–∑—É–∞–ª—å–Ω–æ–µ –¥–µ—Ä–µ–≤–æ</div>
          <Badge>–∫–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–µ</Badge>
          <Badge>–ø–∞—Ä–∞ —Å–≤–µ—Ä—Ö—É ‚Üí –¥–µ—Ç–∏ —Å–Ω–∏–∑—É</Badge>
        </div>

        <div className="flex flex-col items-center gap-12">
          {rootBlocks.map((blk,idx)=>(
            <FamilyNode
              key={(blk.b?[blk.a,blk.b].sort().join("|"):blk.a)+"_"+idx}
              parentAId={blk.a}
              parentBId={blk.b}
              visitedUnions={new Set()}
            />
          ))}
        </div>
      </div>
    </div>
  );
}

/* =========================
   APP
========================= */
function App(){
  const [people,setPeople]=useState([]);
  const [relationships,setRelationships]=useState([]);
  const [comments,setComments]=useState([]);

  const [selectedPersonId,setSelectedPersonId]=useState(null);
  const selectedPerson=useMemo(()=>people.find(p=>p.id===selectedPersonId)||null,[people,selectedPersonId]);

  const [tab,setTab]=useState("tree"); // tree | people | admin
  const [toast,setToast]=useState("");

  // auth
  const [isAdmin,setIsAdmin]=useState(sessionStorage.getItem("ft3_admin") === "1");
  const [loginOpen,setLoginOpen]=useState(false);
  const [pwd,setPwd]=useState("");

  // forms
  const [personForm,setPersonForm]=useState({ id:"", firstName:"", lastName:"", gender:"U", birthDate:"", deathDate:"", notes:"" });
  const [marriageForm,setMarriageForm]=useState({ person1Id:"", person2Id:"", marriageDate:"", divorceDate:"" });
  const [pcForm,setPcForm]=useState({ parentId:"", childId:"" });

  // comments
  const [newComment,setNewComment]=useState("");
  const [commentAuthor,setCommentAuthor]=useState("");

  const peopleById=useMemo(()=>{ const m=new Map(); for(const p of people) m.set(p.id,p); return m; },[people]);
  const marriages=useMemo(()=>relationships.filter(r=>r.type==="marriage"),[relationships]);
  const parentLinks=useMemo(()=>relationships.filter(r=>r.type==="parent-child"),[relationships]);

  const peopleSorted=useMemo(()=>[...people].sort(sortByName),[people]);

  useEffect(()=>{
    (async()=>{
      const data = await Storage.load();
      setPeople(Array.isArray(data.people)?data.people:DEFAULT_PEOPLE);
      setRelationships(Array.isArray(data.relationships)?data.relationships:DEFAULT_RELATIONSHIPS);
      setComments(Array.isArray(data.comments)?data.comments:DEFAULT_COMMENTS);
    })();
  },[]);

  useEffect(()=>{
    Storage.save({ people, relationships, comments });
  },[people,relationships,comments]);

  useEffect(()=>{
    if(!toast) return;
    const t=setTimeout(()=>setToast(""),2000);
    return ()=>clearTimeout(t);
  },[toast]);

  function login(){
    if(pwd===ADMIN_PASSWORD){
      setIsAdmin(true);
      sessionStorage.setItem("ft3_admin","1");
      setLoginOpen(false);
      setPwd("");
      setToast("–ê–¥–º–∏–Ω –≤–∫–ª—é—á—ë–Ω");
      setTab("admin");
    } else alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å");
  }
  function logout(){
    setIsAdmin(false);
    sessionStorage.removeItem("ft3_admin");
    setToast("–ê–¥–º–∏–Ω –≤—ã–∫–ª—é—á–µ–Ω");
    if(tab==="admin") setTab("tree");
  }

  function pickPerson(id){
    setSelectedPersonId(id);
  }

  function addComment(){
    if(!selectedPerson) return;
    const t=newComment.trim();
    if(!t) return;
    const author=(commentAuthor.trim() || (isAdmin?"–ê–¥–º–∏–Ω":"–ì–æ—Å—Ç—å")).slice(0,40);
    setComments(prev=>[...prev,{ id:uid("c"), personId:selectedPerson.id, text:t, author, dateISO:new Date().toISOString() }]);
    setNewComment("");
    setToast("–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–æ–±–∞–≤–ª–µ–Ω");
  }
  function deleteComment(id){
    if(!isAdmin) return;
    if(!confirm("–£–¥–∞–ª–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π?")) return;
    setComments(prev=>prev.filter(c=>c.id!==id));
    setToast("–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —É–¥–∞–ª—ë–Ω");
  }

  const selectedComments=useMemo(()=>{
    if(!selectedPerson) return [];
    return comments
      .filter(c=>c.personId===selectedPerson.id)
      .slice()
      .sort((a,b)=>(a.dateISO||"").localeCompare(b.dateISO||""));
  },[comments,selectedPerson]);

  // Admin ops
  function startCreatePerson(){
    if(!isAdmin) return;
    setPersonForm({ id:"", firstName:"", lastName:"", gender:"U", birthDate:"", deathDate:"", notes:"" });
  }
  function startEditPerson(p){
    if(!isAdmin || !p) return;
    setPersonForm({ id:p.id, firstName:p.firstName||"", lastName:p.lastName||"", gender:p.gender||"U", birthDate:p.birthDate||"", deathDate:p.deathDate||"", notes:p.notes||"" });
  }
  function savePerson(){
    if(!isAdmin) return;
    const firstName=(personForm.firstName||"").trim();
    const lastName=(personForm.lastName||"").trim();
    const gender=personForm.gender||"U";
    if(!firstName && !lastName){ alert("–£–∫–∞–∂–∏ –∏–º—è –∏–ª–∏ —Ñ–∞–º–∏–ª–∏—é"); return; }

    if(personForm.id){
      setPeople(prev=>prev.map(p=>p.id===personForm.id?{...p,...personForm,firstName,lastName,gender}:p));
      setToast("–ß–µ–ª–æ–≤–µ–∫ –æ–±–Ω–æ–≤–ª—ë–Ω");
    } else {
      const id=uid("p");
      setPeople(prev=>[...prev,{...personForm,id,firstName,lastName,gender}]);
      setSelectedPersonId(id);
      setToast("–ß–µ–ª–æ–≤–µ–∫ –¥–æ–±–∞–≤–ª–µ–Ω");
    }
  }
  function deletePerson(id){
    if(!isAdmin) return;
    const p=peopleById.get(id);
    if(!p) return;
    if(!confirm(`–£–¥–∞–ª–∏—Ç—å "${fullName(p)}"? –£–¥–∞–ª—è—Ç—Å—è —Å–≤—è–∑–∏ –∏ –∫–æ–º–º–µ–Ω—Ç—ã.`)) return;

    setPeople(prev=>prev.filter(x=>x.id!==id));
    setRelationships(prev=>prev.filter(r=>{
      if(r.type==="marriage") return r.person1Id!==id && r.person2Id!==id;
      if(r.type==="parent-child") return r.parentId!==id && r.childId!==id;
      return true;
    }));
    setComments(prev=>prev.filter(c=>c.personId!==id));
    if(selectedPersonId===id) setSelectedPersonId(null);
    setToast("–£–¥–∞–ª–µ–Ω–æ");
  }
  function addMarriage(){
    if(!isAdmin) return;
    const a=marriageForm.person1Id, b=marriageForm.person2Id;
    if(!a || !b || a===b){ alert("–í—ã–±–µ—Ä–∏ –¥–≤—É—Ö —Ä–∞–∑–Ω—ã—Ö –ª—é–¥–µ–π"); return; }
    const exists=marriages.some(r=>(r.person1Id===a && r.person2Id===b)||(r.person1Id===b && r.person2Id===a));
    if(exists){ alert("–¢–∞–∫–æ–π –±—Ä–∞–∫ —É–∂–µ –µ—Å—Ç—å"); return; }

    setRelationships(prev=>[...prev,{ id:uid("r"), type:"marriage", person1Id:a, person2Id:b, marriageDate:marriageForm.marriageDate||"", divorceDate:marriageForm.divorceDate||"" }]);
    setMarriageForm({ person1Id:"", person2Id:"", marriageDate:"", divorceDate:"" });
    setToast("–ë—Ä–∞–∫ –¥–æ–±–∞–≤–ª–µ–Ω");
  }
  function addParentChild(){
    if(!isAdmin) return;
    const parentId=pcForm.parentId, childId=pcForm.childId;
    if(!parentId || !childId || parentId===childId){ alert("–í—ã–±–µ—Ä–∏ —Ä–æ–¥–∏—Ç–µ–ª—è –∏ —Ä–µ–±—ë–Ω–∫–∞ (—Ä–∞–∑–Ω—ã—Ö)"); return; }
    const exists=parentLinks.some(r=>r.parentId===parentId && r.childId===childId);
    if(exists){ alert("–¢–∞–∫–∞—è —Å–≤—è–∑—å —É–∂–µ –µ—Å—Ç—å"); return; }

    setRelationships(prev=>[...prev,{ id:uid("r"), type:"parent-child", parentId, childId }]);
    setPcForm({ parentId:"", childId:"" });
    setToast("–°–≤—è–∑—å –¥–æ–±–∞–≤–ª–µ–Ω–∞");
  }
  function deleteRelationship(id){
    if(!isAdmin) return;
    if(!confirm("–£–¥–∞–ª–∏—Ç—å —Å–≤—è–∑—å?")) return;
    setRelationships(prev=>prev.filter(r=>r.id!==id));
    setToast("–°–≤—è–∑—å —É–¥–∞–ª–µ–Ω–∞");
  }

  function exportJson(){
    const payload={ people, relationships, comments, exportedAt:new Date().toISOString() };
    const text=JSON.stringify(payload,null,2);
    const blob=new Blob([text],{type:"application/json"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url; a.download="family-tree-export.json"; a.click();
    URL.revokeObjectURL(url);
  }
  function importJsonFile(file){
    if(!isAdmin) return;
    const reader=new FileReader();
    reader.onload=()=>{
      try{
        const data=JSON.parse(reader.result);
        if(!data || !Array.isArray(data.people) || !Array.isArray(data.relationships) || !Array.isArray(data.comments)){
          alert("–§–∞–π–ª –Ω–µ –ø–æ—Ö–æ–∂ –Ω–∞ —ç–∫—Å–ø–æ—Ä—Ç"); return;
        }
        if(!confirm("–ó–∞–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ —Ñ–∞–π–ª–∞?")) return;
        setPeople(data.people); setRelationships(data.relationships); setComments(data.comments);
        setSelectedPersonId(null);
        setToast("–ò–º–ø–æ—Ä—Ç –≥–æ—Ç–æ–≤");
      } catch { alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å JSON"); }
    };
    reader.readAsText(file,"utf-8");
  }
  function resetToDefaults(){
    if(!isAdmin) return;
    if(!confirm("–°–±—Ä–æ—Å–∏—Ç—å –∫ —É–º–æ–ª—á–∞–Ω–∏—é?")) return;
    setPeople(DEFAULT_PEOPLE);
    setRelationships(DEFAULT_RELATIONSHIPS);
    setComments(DEFAULT_COMMENTS);
    setSelectedPersonId(null);
    setToast("–°–±—Ä–æ—à–µ–Ω–æ");
  }

  return (
    <div className="min-h-screen text-white">
      {/* top bar */}
      <div className="sticky top-0 z-30 border-b border-white/10 bg-slate-950/70 backdrop-blur">
        <div className="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
          <div className="font-semibold text-lg">FamilyTree</div>
          <Badge>–Ω–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞</Badge>
          <div className="ml-auto flex items-center gap-2">
            <div className="hidden sm:flex items-center gap-2">
              <Btn variant={tab==="tree"?"primary":"ghost"} onClick={()=>setTab("tree")}>üå≥ –î–µ—Ä–µ–≤–æ</Btn>
              <Btn variant={tab==="people"?"primary":"ghost"} onClick={()=>setTab("people")}>üë• –õ—é–¥–∏</Btn>
              {isAdmin && <Btn variant={tab==="admin"?"primary":"ghost"} onClick={()=>setTab("admin")}>üõ† –ê–¥–º–∏–Ω</Btn>}
            </div>

            {isAdmin ? (
              <Btn variant="ghost" onClick={logout}>–í—ã–π—Ç–∏ (–∞–¥–º–∏–Ω)</Btn>
            ) : (
              <Btn variant="primary" onClick={()=>setLoginOpen(true)}>–í–æ–π—Ç–∏ (–∞–¥–º–∏–Ω)</Btn>
            )}
          </div>
        </div>
      </div>

      {/* toast */}
      {toast && (
        <div className="fixed bottom-4 left-1/2 -translate-x-1/2 z-40">
          <div className="rounded-2xl bg-white/10 border border-white/10 px-4 py-2 text-sm">{toast}</div>
        </div>
      )}

      {/* login modal */}
      {loginOpen && (
        <div className="fixed inset-0 z-50 bg-black/60 flex items-center justify-center p-4">
          <Card className="w-full max-w-sm p-5">
            <div className="flex items-center gap-2">
              <div className="font-semibold text-lg">–í—Ö–æ–¥ –∞–¥–º–∏–Ω–∞</div>
              <button className="ml-auto text-white/60 hover:text-white" onClick={()=>{setLoginOpen(false);setPwd("");}}>‚úï</button>
            </div>
            <div className="mt-2 text-sm text-white/70">
              –ê–¥–º–∏–Ω –Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ª—é–¥–µ–π –∏ —Å–≤—è–∑–µ–π.
            </div>
            <input
              className="mt-4 w-full rounded-xl bg-white/5 border border-white/10 px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500/40"
              type="password"
              placeholder="–ü–∞—Ä–æ–ª—å"
              value={pwd}
              onChange={(e)=>setPwd(e.target.value)}
              onKeyDown={(e)=>{ if(e.key==="Enter") login(); }}
            />
            <div className="mt-3 flex gap-2">
              <Btn onClick={login} className="flex-1">–í–æ–π—Ç–∏</Btn>
              <Btn variant="ghost" onClick={()=>{setLoginOpen(false);setPwd("");}}>–û—Ç–º–µ–Ω–∞</Btn>
            </div>
          </Card>
        </div>
      )}

      {/* main */}
      <div className="max-w-7xl mx-auto px-4 py-4 grid grid-cols-1 lg:grid-cols-12 gap-4">
        {/* left main content */}
        <div className="lg:col-span-8 space-y-4">
          {tab==="tree" && (
            <Card className="p-3">
              <FamilyTree
                people={people}
                relationships={relationships}
                selectedPersonId={selectedPersonId}
                onSelect={pickPerson}
              />
            </Card>
          )}

          {tab==="people" && (
            <Card className="p-4">
              <div className="flex items-center gap-2">
                <div className="font-semibold text-lg">–õ—é–¥–∏</div>
                <Badge>{people.length}</Badge>
                {isAdmin && <Btn variant="ok" className="ml-auto" onClick={()=>{startCreatePerson(); setTab("admin");}}>+ –î–æ–±–∞–≤–∏—Ç—å</Btn>}
              </div>
              <div className="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-2">
                {peopleSorted.map(p=>(
                  <button
                    key={p.id}
                    onClick={()=>pickPerson(p.id)}
                    className={
                      "rounded-2xl border px-3 py-3 text-left transition " +
                      (p.id===selectedPersonId ? "bg-indigo-500/15 border-indigo-400/60" : "bg-white/5 border-white/10 hover:bg-white/10")
                    }
                  >
                    <div className="flex items-center gap-2">
                      <div className="font-semibold">{fullName(p)}</div>
                      <span className="ml-auto text-xs text-white/70">{genderLabel(p.gender)}</span>
                    </div>
                    <div className="mt-1 text-xs text-white/60">
                      {p.birthDate ? `—Ä. ${fmtDate(p.birthDate)}` : "–¥–∞—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞"}
                      {p.deathDate ? ` ‚Ä¢ —É–º. ${fmtDate(p.deathDate)}` : ""}
                    </div>
                  </button>
                ))}
              </div>
            </Card>
          )}

          {tab==="admin" && (
            <Card className="p-4">
              {!isAdmin ? (
                <div className="text-white/70">–ù—É–∂–µ–Ω –≤—Ö–æ–¥ –∞–¥–º–∏–Ω–∞.</div>
              ) : (
                <div className="space-y-4">
                  <div className="flex items-center gap-2">
                    <div className="font-semibold text-lg">–ê–¥–º–∏–Ω</div>
                    <Badge>—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</Badge>
                    <div className="ml-auto flex gap-2">
                      <Btn variant="ghost" onClick={exportJson}>–≠–∫—Å–ø–æ—Ä—Ç</Btn>
                      <label className="px-3 py-2 rounded-xl text-sm font-medium transition border bg-white/5 hover:bg-white/10 text-white border-white/10 cursor-pointer">
                        –ò–º–ø–æ—Ä—Ç
                        <input type="file" accept="application/json" className="hidden"
                          onChange={(e)=>{const f=e.target.files?.[0]; if(f) importJsonFile(f); e.target.value="";}}
                        />
                      </label>
                      <Btn variant="danger" onClick={resetToDefaults}>–°–±—Ä–æ—Å</Btn>
                    </div>
                  </div>

                  {/* person form */}
                  <Card className="p-4">
                    <div className="flex items-center gap-2">
                      <div className="font-semibold">–ß–µ–ª–æ–≤–µ–∫</div>
                      <Badge>{personForm.id ? "edit" : "new"}</Badge>
                      {selectedPerson && <Btn variant="ghost" className="ml-auto" onClick={()=>startEditPerson(selectedPerson)}>–í —Ñ–æ—Ä–º—É: –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ</Btn>}
                    </div>

                    <div className="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-2">
                      <input className="rounded-xl bg-white/5 border border-white/10 px-3 py-2 outline-none"
                        placeholder="–§–∞–º–∏–ª–∏—è" value={personForm.lastName} onChange={(e)=>setPersonForm(f=>({...f,lastName:e.target.value}))}/>
                      <input className="rounded-xl bg-white/5 border border-white/10 px-3 py-2 outline-none"
                        placeholder="–ò–º—è" value={personForm.firstName} onChange={(e)=>setPersonForm(f=>({...f,firstName:e.target.value}))}/>

                      <select className="rounded-xl bg-white/5 border border-white/10 px-3 py-2 outline-none"
                        value={personForm.gender} onChange={(e)=>setPersonForm(f=>({...f,gender:e.target.value}))}>
                        <option value="U">–ü–æ–ª –Ω–µ —É–∫–∞–∑–∞–Ω</option>
                        <option value="M">–ú</option>
                        <option value="F">–ñ</option>
                      </select>

                      <input className="rounded-xl bg-white/5 border border-white/10 px-3 py-2 outline-none"
                        type="date" value={personForm.birthDate} onChange={(e)=>setPersonForm(f=>({...f,birthDate:e.target.value}))}/>

                      <input className="rounded-xl bg-white/5 border border-white/10 px-3 py-2 outline-none"
                        type="date" value={personForm.deathDate} onChange={(e)=>setPersonForm(f=>({...f,deathDate:e.target.value}))}/>

                      <textarea className="sm:col-span-2 rounded-xl bg-white/5 border border-white/10 px-3 py-2 outline-none"
                        rows="3" placeholder="–ó–∞–º–µ—Ç–∫–∏"
                        value={personForm.notes} onChange={(e)=>setPersonForm(f=>({...f,notes:e.target.value}))}/>
                    </div>

                    <div className="mt-3 flex gap-2">
                      <Btn variant="ok" onClick={savePerson}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</Btn>
                      <Btn variant="ghost" onClick={startCreatePerson}>–û—á–∏—Å—Ç–∏—Ç—å</Btn>
                      {personForm.id && <Btn variant="danger" onClick={()=>deletePerson(personForm.id)}>–£–¥–∞–ª–∏—Ç—å</Btn>}
                    </div>
                  </Card>

                  {/* relationships */}
                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <Card className="p-4">
                      <div className="font-semibold">–ë—Ä–∞–∫</div>
                      <div className="mt-3 grid grid-cols-1 gap-2">
                        <select className="rounded-xl bg-white/5 border border-white/10 px-3 py-2 outline-none"
                          value={marriageForm.person1Id} onChange={(e)=>setMarriageForm(f=>({...f,person1Id:e.target.value}))}>
                          <option value="">–ß–µ–ª–æ–≤–µ–∫ 1</option>
                          {peopleSorted.map(p=><option key={p.id} value={p.id}>{fullName(p)}</option>)}
                        </select>
                        <select className="rounded-xl bg-white/5 border border-white/10 px-3 py-2 outline-none"
                          value={marriageForm.person2Id} onChange={(e)=>setMarriageForm(f=>({...f,person2Id:e.target.value}))}>
                          <option value="">–ß–µ–ª–æ–≤–µ–∫ 2</option>
                          {peopleSorted.map(p=><option key={p.id} value={p.id}>{fullName(p)}</option>)}
                        </select>
                        <div className="grid grid-cols-2 gap-2">
                          <input className="rounded-xl bg-white/5 border border-white/10 px-3 py-2 outline-none"
                            type="date" value={marriageForm.marriageDate} onChange={(e)=>setMarriageForm(f=>({...f,marriageDate:e.target.value}))}/>
                          <input className="rounded-xl bg-white/5 border border-white/10 px-3 py-2 outline-none"
                            type="date" value={marriageForm.divorceDate} onChange={(e)=>setMarriageForm(f=>({...f,divorceDate:e.target.value}))}/>
                        </div>
                        <Btn variant="ok" onClick={addMarriage}>–î–æ–±–∞–≤–∏—Ç—å –±—Ä–∞–∫</Btn>
                      </div>
                    </Card>

                    <Card className="p-4">
                      <div className="font-semibold">–†–æ–¥–∏—Ç–µ–ª—å ‚Üí —Ä–µ–±—ë–Ω–æ–∫</div>
                      <div className="mt-3 grid grid-cols-1 gap-2">
                        <select className="rounded-xl bg-white/5 border border-white/10 px-3 py-2 outline-none"
                          value={pcForm.parentId} onChange={(e)=>setPcForm(f=>({...f,parentId:e.target.value}))}>
                          <option value="">–†–æ–¥–∏—Ç–µ–ª—å</option>
                          {peopleSorted.map(p=><option key={p.id} value={p.id}>{fullName(p)}</option>)}
                        </select>
                        <select className="rounded-xl bg-white/5 border border-white/10 px-3 py-2 outline-none"
                          value={pcForm.childId} onChange={(e)=>setPcForm(f=>({...f,childId:e.target.value}))}>
                          <option value="">–†–µ–±—ë–Ω–æ–∫</option>
                          {peopleSorted.map(p=><option key={p.id} value={p.id}>{fullName(p)}</option>)}
                        </select>
                        <Btn variant="ok" onClick={addParentChild}>–î–æ–±–∞–≤–∏—Ç—å —Å–≤—è–∑—å</Btn>
                      </div>

                      <div className="mt-4 border-t border-white/10 pt-3 space-y-2 max-h-56 overflow-auto soft-scroll pr-1">
                        {parentLinks.map(r=>{
                          const parent=peopleById.get(r.parentId);
                          const child=peopleById.get(r.childId);
                          if(!parent || !child) return null;
                          return (
                            <div key={r.id} className="flex items-center gap-2 text-sm">
                              <button className="text-indigo-300 hover:underline" onClick={()=>pickPerson(parent.id)}>{fullName(parent)}</button>
                              <span className="text-white/30">‚Üí</span>
                              <button className="text-indigo-300 hover:underline" onClick={()=>pickPerson(child.id)}>{fullName(child)}</button>
                              <button className="ml-auto text-rose-300 hover:underline text-xs" onClick={()=>deleteRelationship(r.id)}>—É–¥–∞–ª–∏—Ç—å</button>
                            </div>
                          );
                        })}
                        {!parentLinks.length && <div className="text-white/60 text-sm">–ü–æ–∫–∞ –Ω–µ—Ç —Å–≤—è–∑–µ–π.</div>}
                      </div>
                    </Card>
                  </div>

                  <div className="text-xs text-white/55">
                    –°–µ–π—á–∞—Å –≤—Å—ë —Ö—Ä–∞–Ω–∏—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ (localStorage). –°–ª–µ–¥—É—é—â–∏–º —à–∞–≥–æ–º –∑–∞–º–µ–Ω–∏–º Storage –Ω–∞ Firebase/Supabase, –∏ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –æ–±—â–∏–º–∏ –¥–ª—è –≤—Å–µ—Ö.
                  </div>
                </div>
              )}
            </Card>
          )}
        </div>

        {/* right panel */}
        <div className="lg:col-span-4 space-y-4">
          <Card className="p-4">
            <div className="flex items-center gap-2">
              <div className="font-semibold text-lg">–ü–∞–Ω–µ–ª—å</div>
              {selectedPerson ? <Badge>–≤—ã–±—Ä–∞–Ω</Badge> : <Badge>–Ω–µ—Ç –≤—ã–±–æ—Ä–∞</Badge>}
              <div className="ml-auto">
                {selectedPerson && <Btn variant="ghost" onClick={()=>setSelectedPersonId(null)}>–°–Ω—è—Ç—å –≤—ã–±–æ—Ä</Btn>}
              </div>
            </div>

            {!selectedPerson ? (
              <div className="mt-3 text-white/70 text-sm">
                –í—ã–±–µ—Ä–∏ —á–µ–ª–æ–≤–µ–∫–∞ –≤ –¥–µ—Ä–µ–≤–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–µ—Ç–∞–ª–∏ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏.
              </div>
            ) : (
              <div className="mt-3 space-y-3">
                <div className="rounded-2xl border border-white/10 bg-white/5 p-3">
                  <div className="text-white font-semibold text-lg">{fullName(selectedPerson)}</div>
                  <div className="mt-1 text-sm text-white/70">
                    –ü–æ–ª: {genderLabel(selectedPerson.gender)}
                    {selectedPerson.birthDate ? ` ‚Ä¢ —Ä. ${fmtDate(selectedPerson.birthDate)}` : ""}
                    {selectedPerson.deathDate ? ` ‚Ä¢ —É–º. ${fmtDate(selectedPerson.deathDate)}` : ""}
                  </div>
                  {selectedPerson.notes?.trim() && (
                    <div className="mt-2 text-sm text-white/75 whitespace-pre-wrap">{selectedPerson.notes}</div>
                  )}
                </div>

                {/* comments */}
                <div className="rounded-2xl border border-white/10 bg-white/5 p-3">
                  <div className="flex items-center gap-2">
                    <div className="font-semibold">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</div>
                    <Badge>{selectedComments.length}</Badge>
                  </div>

                  <div className="mt-2 grid grid-cols-1 gap-2">
                    <input className="rounded-xl bg-white/5 border border-white/10 px-3 py-2 outline-none text-sm"
                      placeholder="–ò–º—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"
                      value={commentAuthor} onChange={(e)=>setCommentAuthor(e.target.value)} />
                    <textarea className="rounded-xl bg-white/5 border border-white/10 px-3 py-2 outline-none text-sm"
                      rows="3"
                      placeholder="–ù–∞–ø–∏—Å–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π‚Ä¶"
                      value={newComment} onChange={(e)=>setNewComment(e.target.value)} />
                    <Btn onClick={addComment}>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</Btn>
                  </div>

                  <div className="mt-3 space-y-2 max-h-64 overflow-auto soft-scroll pr-1">
                    {selectedComments.map(c=>(
                      <div key={c.id} className="rounded-2xl border border-white/10 bg-slate-950/40 p-3">
                        <div className="flex items-center gap-2">
                          <div className="text-sm font-semibold text-white">{c.author || "–ì–æ—Å—Ç—å"}</div>
                          <div className="text-xs text-white/55">{new Date(c.dateISO).toLocaleString("ru-RU")}</div>
                          {isAdmin && (
                            <button className="ml-auto text-xs text-rose-300 hover:underline" onClick={()=>deleteComment(c.id)}>—É–¥–∞–ª–∏—Ç—å</button>
                          )}
                        </div>
                        <div className="mt-2 text-sm text-white/80 whitespace-pre-wrap">{c.text}</div>
                      </div>
                    ))}
                    {!selectedComments.length && <div className="text-white/60 text-sm">–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.</div>}
                  </div>
                </div>

                {isAdmin && (
                  <div className="grid grid-cols-2 gap-2">
                    <Btn variant="ghost" onClick={()=>{startEditPerson(selectedPerson); setTab("admin");}}>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</Btn>
                    <Btn variant="danger" onClick={()=>deletePerson(selectedPerson.id)}>–£–¥–∞–ª–∏—Ç—å</Btn>
                  </div>
                )}
              </div>
            )}
          </Card>

          <Card className="p-4">
            <div className="font-semibold">–î–∞–ª—å—à–µ: —Å–µ—Ä–≤–µ—Ä</div>
            <div className="mt-2 text-sm text-white/70">
              –ö–æ–≥–¥–∞ –¥–∏–∑–∞–π–Ω –æ–∫ ‚Äî –ø–æ–¥–∫–ª—é—á–∏–º Firebase/Supabase, –∏ –¥–µ—Ä–µ–≤–æ+–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —Å—Ç–∞–Ω—É—Ç –æ–±—â–∏–º–∏ –¥–ª—è –≤—Å–µ—Ö.
            </div>
          </Card>
        </div>
      </div>

      {/* mobile tabs */}
      <div className="sm:hidden fixed bottom-3 left-1/2 -translate-x-1/2 z-30">
        <div className="flex gap-2 rounded-2xl border border-white/10 bg-slate-950/70 backdrop-blur px-2 py-2">
          <Btn variant={tab==="tree"?"primary":"ghost"} onClick={()=>setTab("tree")}>üå≥</Btn>
          <Btn variant={tab==="people"?"primary":"ghost"} onClick={()=>setTab("people")}>üë•</Btn>
          <Btn variant={isAdmin && tab==="admin"?"primary":"ghost"} onClick={()=>{ if(isAdmin) setTab("admin"); else setLoginOpen(true); }}>üõ†</Btn>
        </div>
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>
