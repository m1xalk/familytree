<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–†–æ–¥–æ—Å–ª–æ–≤–Ω–æ–µ –¥–µ—Ä–µ–≤–æ</title>

  <!-- React (UMD) + Babel –¥–ª—è GitHub Pages -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min. js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js"></script>

  <style>
    /* –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –¥–µ—Ä–µ–≤–æ —Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑ —Å –ª–∏–Ω–∏—è–º–∏ (ul/li —Ç—Ä—é–∫) */
    .tree { padding: 12px; overflow: auto; }
    .tree ul { padding-top: 24px; position: relative; }
    .tree li {
      float: left;
      text-align: center;
      list-style: none;
      position: relative;
      padding: 24px 10px 0 10px;
      min-width: 220px;
    }

    /* –ª–∏–Ω–∏–∏ –º–µ–∂–¥—É —Å–æ—Å–µ–¥–Ω–∏–º–∏ —É–∑–ª–∞–º–∏ */
    .tree li::before,
    .tree li::after {
      content: "";
      position: absolute;
      top: 0;
      right: 50%;
      border-top: 2px solid #cbd5e1;
      width: 50%;
      height: 24px;
    }
    .tree li::after {
      right: auto;
      left: 50%;
      border-left: 2px solid #cbd5e1;
    }

    /* –æ–¥–∏–Ω–æ—á–Ω—ã–π —Ä–µ–±–µ–Ω–æ–∫ */
    .tree li: only-child::before,
    .tree li:only-child::after { display: none; }
    .tree li:only-child { padding-top: 0; }

    /* –∫—Ä–∞–π–Ω–∏–µ –¥–µ—Ç–∏ */
    .tree li:first-child::before { border:  0 none; }
    .tree li:last-child::after { border: 0 none; }
    .tree li:last-child:: before { border-right: 2px solid #cbd5e1; border-radius: 0 10px 0 0; }
    .tree li:first-child::after { border-radius: 10px 0 0 0; }

    /* –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è –≤–Ω–∏–∑ –∫ –¥–µ—Ç—è–º */
    .tree ul ul:: before {
      content: "";
      position: absolute;
      top: 0;
      left:  50%;
      border-left: 2px solid #cbd5e1;
      width: 0;
      height:  24px;
    }

    /* –∫–∞—Ä—Ç–æ—á–∫–∞ —á–µ–ª–æ–≤–µ–∫–∞ */
    .personCard {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border: 1px solid #e2e8f0;
      border-radius: 16px;
      background: #fff;
      box-shadow: 0 8px 22px rgba(15,23,42,. 06);
      max-width: 280px;
      cursor: pointer;
      user-select: none;
    }
    .personCard:hover { box-shadow: 0 12px 28px rgba(15,23,42,.10); }

    . avatar {
      width: 44px;
      height: 44px;
      border-radius:  999px;
      object-fit: cover;
      background: #e0e7ff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      color: #3730a3;
      flex:  0 0 auto;
      overflow: hidden;
    }

    /* –ø–∞—Ä–∞ (–¥–≤–∞ —á–µ–ª–æ–≤–µ–∫–∞ + —Å–µ—Ä–¥–µ—á–∫–æ/—Ä–∞–∑–≤–æ–¥ –≤ —Ü–µ–Ω—Ç—Ä–µ) */
    .coupleRow {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      position: relative;
    }
    .coupleMid {
      width: 36px;
      height: 36px;
      border-radius:  999px;
      border: 1px solid #e2e8f0;
      background: #fff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      box-shadow: 0 6px 16px rgba(15,23,42,.08);
      cursor: pointer;
      user-select: none;
    }
    .coupleMid[aria-disabled="true"] { cursor: default; opacity: . 65; }

    /* –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è "—É–∑–ª–∞ —Å–µ–º—å–∏" –≤–Ω–∏–∑ */
    .coupleDownLine {
      position: relative;
      display: inline-block;
    }
    .coupleDownLine::after {
      content: "";
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: -16px;
      height: 16px;
      border-left: 2px solid #cbd5e1;
    }

    . clearfix:: after { content: ""; display: table; clear: both; }
  </style>
</head>

<body class="bg-slate-50">
  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useState } = React;

    // =========================
    // FIREBASE CONFIG
    // =========================
    const firebaseConfig = {
      apiKey: "AIzaSyDJKvh7T9MJGXHWoA3LsESEXWsQxiIbFd4",
      authDomain: "familytree-ee339.firebaseapp.com",
      projectId: "familytree-ee339",
      storageBucket: "familytree-ee339.firebasestorage.app",
      messagingSenderId:  "986703703890",
      appId: "1:986703703890:web: 71ea30a750e7867dd1548b"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // =========================
    // utils
    // =========================
    const uid = () => String(Date.now()) + "_" + Math.floor(Math.random() * 100000);

    const yearRange = (birthDate, deathDate) => {
      const y = (d) => d ?  new Date(d).getFullYear() : "";
      const b = y(birthDate);
      const dd = y(deathDate);
      if (! b && !dd) return "‚Äî";
      if (b && !dd) return String(b);
      if (b && dd) return `${b}‚Äì${dd}`;
      return `‚Äî‚Äì${dd}`;
    };

    const safeName = (p) => {
      const ln = (p?. lastName || "").trim();
      const fn = (p?.firstName || "").trim();
      return (ln + " " + fn).trim() || "–ë–µ–∑ –∏–º–µ–Ω–∏";
    };

    // =========================
    // App
    // =========================
    function App() {
      // auth state
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);
      const [isAdmin, setIsAdmin] = useState(false);
      const [showLogin, setShowLogin] = useState(false);
      const [password, setPassword] = useState("");
      const [email, setEmail] = useState("");

      // data from firestore
      const [people, setPeople] = useState([]);
      const [couples, setCouples] = useState([]);
      const [comments, setComments] = useState([]);

      // UI state
      const [selectedPersonId, setSelectedPersonId] = useState(null);
      const selectedPerson = useMemo(() => people.find(p => p.id === selectedPersonId) || null, [people, selectedPersonId]);

      const [expanded, setExpanded] = useState(new Set());
      const [showPersonForm, setShowPersonForm] = useState(false);
      const [editingPerson, setEditingPerson] = useState(null);

      const [showCoupleForm, setShowCoupleForm] = useState(false);

      const [addChildModal, setAddChildModal] = useState({ open: false, coupleId: null });
      const [newComment, setNewComment] = useState("");

      // -------------------------
      // Firebase Auth Listener
      // -------------------------
      useEffect(() => {
        const unsubscribe = auth.onAuthStateChanged(async (currentUser) => {
          setUser(currentUser);
          setLoading(false);

          if (currentUser) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–¥–º–∏–Ω—Å–∫–∏–π —Å—Ç–∞—Ç—É—Å
            try {
              const adminDoc = await db.collection("admins").doc(currentUser.uid).get();
              setIsAdmin(adminDoc.exists);
            } catch (err) {
              setIsAdmin(false);
            }

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Firestore
            loadDataFromFirestore();
          }
        });

        return () => unsubscribe();
      }, []);

      // -------------------------
      // Load Data from Firestore
      // -------------------------
      const loadDataFromFirestore = () => {
        // –ó–∞–≥—Ä—É–∑–∫–∞ people
        db.collection("people").onSnapshot((snapshot) => {
          const data = snapshot.docs.map(doc => ({ id: doc.id, ... doc.data() }));
          setPeople(data);
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ couples
        db.collection("couples").onSnapshot((snapshot) => {
          const data = snapshot. docs.map(doc => ({ id: doc.id, ...doc. data() }));
          setCouples(data);
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ comments
        db.collection("comments").onSnapshot((snapshot) => {
          const data = snapshot.docs. map(doc => ({ id: doc.id, ...doc.data() }));
          setComments(data);
        });
      };

      // -------------------------
      // auth
      // -------------------------
      const handleAdminLogin = async () => {
        try {
          await auth.signInWithEmailAndPassword(email, password);
          setShowLogin(false);
          setEmail("");
          setPassword("");
        } catch (err) {
          alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: " + err.message);
        }
      };

      const handleGuestLogin = async () => {
        try {
          await auth.signInAnonymously();
          setShowLogin(false);
          setEmail("");
          setPassword("");
        } catch (err) {
          alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: " + err.message);
        }
      };

      const handleLogout = async () => {
        await auth.signOut();
        setIsAdmin(false);
      };

      // -------------------------
      // CRUD people (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω)
      // -------------------------
      const addPerson = async (data) => {
        if (!isAdmin) return;
        const newId = uid();
        const p = {
          firstName: data.firstName || "",
          lastName: data.lastName || "",
          middleName: data.middleName || "",
          gender: data.gender || "M",
          birthDate: data. birthDate || "",
          deathDate: data.deathDate || "",
          description: data.description || "",
          mainPhoto: data.mainPhoto || "",
          photos: data.mainPhoto ? [data.mainPhoto] : [],
        };
        await db.collection("people").doc(newId).set(p);
        setShowPersonForm(false);
      };

      const updatePerson = async (data) => {
        if (!isAdmin) return;
        await db.collection("people").doc(data.id).update({
          firstName: data.firstName,
          lastName: data.lastName,
          middleName: data. middleName,
          gender:  data.gender,
          birthDate: data.birthDate,
          deathDate: data.deathDate,
          description: data. description,
          mainPhoto: data.mainPhoto,
          photos: data.photos
        });
        setEditingPerson(null);
        setShowPersonForm(false);
        setSelectedPersonId(data.id);
      };

      const deletePerson = async (personId) => {
        if (!isAdmin) return;
        if (! confirm("–£–¥–∞–ª–∏—Ç—å —á–µ–ª–æ–≤–µ–∫–∞?  –°–≤—è–∑–∏ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –±—É–¥—É—Ç –æ—á–∏—â–µ–Ω—ã.")) return;

        await db.collection("people").doc(personId).delete();

        // –æ—á–∏—â–∞–µ–º –ø–∞—Ä—ã
        const couplesSnap = await db.collection("couples").get();
        for (const coupleDoc of couplesSnap.docs) {
          const couple = coupleDoc.data();
          if (couple.partner1Id === personId || couple.partner2Id === personId) {
            await db.collection("couples").doc(coupleDoc.id).delete();
          } else if (couple.childrenIds?. includes(personId)) {
            await db.collection("couples").doc(coupleDoc.id).update({
              childrenIds: couple.childrenIds.filter(id => id !== personId)
            });
          }
        }

        // –æ—á–∏—â–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
        const commentsSnap = await db.collection("comments").where("personId", "==", personId).get();
        for (const commentDoc of commentsSnap.docs) {
          await db.collection("comments").doc(commentDoc.id).delete();
        }

        if (selectedPersonId === personId) setSelectedPersonId(null);
      };

      // -------------------------
      // CRUD couples (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω)
      // -------------------------
      const addCouple = async (data) => {
        if (!isAdmin) return;
        const newId = uid();
        const c = {
          partner1Id: data.partner1Id,
          partner2Id: data. partner2Id,
          status: data.status,
          childrenIds: [],
        };
        await db. collection("couples").doc(newId).set(c);
        setShowCoupleForm(false);
        setExpanded(prev => new Set([...prev, data.partner1Id, data.partner2Id, newId]));
      };

      const deleteCouple = async (coupleId) => {
        if (!isAdmin) return;
        if (! confirm("–£–¥–∞–ª–∏—Ç—å –ø–∞—Ä—É? –î–µ—Ç–∏ –æ—Å—Ç–∞–Ω—É—Ç—Å—è –∫–∞–∫ –ª—é–¥–∏.")) return;
        await db.collection("couples").doc(coupleId).delete();
      };

      const updateCoupleChildren = async (coupleId, childrenIds) => {
        if (!isAdmin) return;
        await db.collection("couples").doc(coupleId).update({ childrenIds });
      };

      // -------------------------
      // comments (–∞–¥–º–∏–Ω –∏ –≥–æ—Å—Ç–∏)
      // -------------------------
      const addComment = async () => {
        if (!selectedPerson || !user) return;
        const text = (newComment || "").trim();
        if (!text) return;

        const newId = uid();
        await db.collection("comments").doc(newId).set({
          personId: selectedPerson.id,
          author: isAdmin ? "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä" : (user. email || "–ì–æ—Å—Ç—å"),
          text,
          date: new Date().toISOString(),
          userId: user.uid
        });

        setNewComment("");
      };

      const deleteComment = async (commentId) => {
        if (!isAdmin) return;
        await db.collection("comments").doc(commentId).delete();
      };

      // -------------------------
      // photos (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω)
      // -------------------------
      const addPhotoToAlbum = async (personId, file) => {
        if (!isAdmin || !file) return;
        const reader = new FileReader();
        reader.onloadend = async () => {
          const dataUrl = String(reader.result || "");
          const person = people.find(p => p.id === personId);
          const nextPhotos = [... (person?.photos || []), dataUrl];
          await db.collection("people").doc(personId).update({ photos: nextPhotos });
          setSelectedPersonId(personId);
        };
        reader.readAsDataURL(file);
      };

      const deleteAlbumPhoto = async (personId, index) => {
        if (!isAdmin) return;
        const person = people.find(p => p.id === personId);
        const next = (person?.photos || []).filter((_, i) => i !== index);
        await db.collection("people").doc(personId).update({ photos: next });
      };

      // -------------------------
      // tree helpers
      // -------------------------
      const personIsChild = useMemo(() => {
        const s = new Set();
        for (const c of couples) for (const ch of (c.childrenIds || [])) s.add(ch);
        return s;
      }, [couples]);

      const rootCouples = useMemo(() => {
        const roots = couples.filter(c =>
          ! personIsChild.has(c.partner1Id) && !personIsChild.has(c.partner2Id)
        );
        return roots. length ?  roots : couples;
      }, [couples, personIsChild]);

      const couplesByPerson = useMemo(() => {
        const map = new Map();
        for (const c of couples) {
          if (!map.has(c.partner1Id)) map.set(c.partner1Id, []);
          if (!map.has(c.partner2Id)) map.set(c.partner2Id, []);
          map.get(c.partner1Id).push(c);
          map.get(c.partner2Id).push(c);
        }
        return map;
      }, [couples]);

      const toggleExpanded = (key) => {
        setExpanded(prev => {
          const next = new Set(prev);
          next.has(key) ? next.delete(key) : next.add(key);
          return next;
        });
      };

      // -------------------------
      // add child workflow
      // -------------------------
      const openAddChild = (coupleId) => {
        if (!isAdmin) return;
        setAddChildModal({ open: true, coupleId });
      };

      const closeAddChild = () => setAddChildModal({ open: false, coupleId: null });

      const createChildAndAttach = async (coupleId, childData) => {
        if (!isAdmin) return;
        const child = {
          firstName: childData.firstName || "–ù–æ–≤—ã–π",
          lastName: childData.lastName || "",
          middleName: childData.middleName || "",
          gender: childData.gender || "M",
          birthDate: childData.birthDate || "",
          deathDate: childData.deathDate || "",
          description:  childData.description || "",
          mainPhoto: childData.mainPhoto || "",
          photos: childData.mainPhoto ? [childData.mainPhoto] : [],
        };

        const childId = uid();
        await db.collection("people").doc(childId).set(child);

        const couple = couples.find(c => c.id === coupleId);
        await db.collection("couples").doc(coupleId).update({
          childrenIds: [... new Set([.. .(couple?.childrenIds || []), childId])]
        });

        setExpanded(prev => new Set([... prev, coupleId]));
        closeAddChild();
      };

      const attachExistingChild = async (coupleId, childId) => {
        if (!isAdmin) return;
        const couple = couples.find(c => c.id === coupleId);
        await db.collection("couples").doc(coupleId).update({
          childrenIds: [...new Set([...(couple?.childrenIds || []), childId])]
        });
        setExpanded(prev => new Set([...prev, coupleId]));
        closeAddChild();
      };

      // -------------------------
      // UI
      // -------------------------

      if (loading) {
        return (
          <div className="min-h-screen bg-slate-50 flex items-center justify-center">
            <div className="text-lg text-slate-600">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
          </div>
        );
      }

      if (! user) {
        return (
          <div className="min-h-screen bg-slate-50 flex items-center justify-center">
            <div className="bg-white rounded-2xl p-8 w-full max-w-sm shadow-lg">
              <div className="text-2xl font-bold mb-6 text-center text-slate-900">–†–æ–¥–æ—Å–ª–æ–≤–Ω–æ–µ –¥–µ—Ä–µ–≤–æ</div>

              <div className="mb-6 text-sm text-slate-600 text-center">
                –í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –≤—Ö–æ–¥–∞:
              </div>

              <div className="space-y-3">
                <button
                  onClick={() => setShowLogin(true)}
                  className="w-full px-4 py-3 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 font-semibold"
                >
                  –í—Ö–æ–¥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
                </button>

                <button
                  onClick={handleGuestLogin}
                  className="w-full px-4 py-3 rounded-lg bg-slate-300 text-slate-800 hover:bg-slate-400 font-semibold"
                >
                  –ü—Ä–æ—Å–º–æ—Ç—Ä –∫–∞–∫ –≥–æ—Å—Ç—å
                </button>
              </div>
            </div>

            {/* Admin Login Modal */}
            {showLogin && (
              <Modal onClose={() => setShowLogin(false)}>
                <div className="text-lg font-semibold mb-4">–í—Ö–æ–¥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</div>

                <div className="space-y-3">
                  <Field label="Email">
                    <input
                      className="w-full border rounded-xl px-3 py-2"
                      type="email"
                      placeholder="admin@example.com"
                      value={email}
                      onChange={(e) => setEmail(e.target.value)}
                    />
                  </Field>

                  <Field label="–ü–∞—Ä–æ–ª—å">
                    <input
                      className="w-full border rounded-xl px-3 py-2"
                      type="password"
                      placeholder="–ü–∞—Ä–æ–ª—å"
                      value={password}
                      onChange={(e) => setPassword(e.target. value)}
                      onKeyDown={(e) => e.key === "Enter" && handleAdminLogin()}
                    />
                  </Field>
                </div>

                <div className="text-xs text-slate-500 mt-3">
                  –ò—Å–ø–æ–ª—å–∑—É–π —Å–≤–æ–∏ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ Firebase Authentication
                </div>

                <div className="mt-4 flex gap-2">
                  <button
                    onClick={handleAdminLogin}
                    className="flex-1 px-3 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700"
                  >
                    –í–æ–π—Ç–∏
                  </button>
                  <button
                    onClick={() => setShowLogin(false)}
                    className="flex-1 px-3 py-2 rounded-xl bg-slate-200 text-slate-800 hover:bg-slate-300"
                  >
                    –û—Ç–º–µ–Ω–∞
                  </button>
                </div>
              </Modal>
            )}
          </div>
        );
      }

      return (
        <div className="min-h-screen">
          <header className="bg-white border-b">
            <div className="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between gap-3">
              <div className="flex items-center gap-3">
                <div className="w-9 h-9 rounded-xl bg-indigo-600 text-white flex items-center justify-center font-extrabold">FT</div>
                <div>
                  <div className="text-xl font-semibold text-slate-900">–†–æ–¥–æ—Å–ª–æ–≤–Ω–æ–µ –¥–µ—Ä–µ–≤–æ</div>
                  <div className="text-xs text-slate-500">
                    {isAdmin ? "–ê–¥–º–∏–Ω" : "–ì–æ—Å—Ç—å"} ‚Ä¢ Cloud Firestore
                  </div>
                </div>
              </div>

              <div className="flex items-center gap-2">
                <div className="text-sm text-slate-600">
                  {isAdmin ? "üë§ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä" : "üëÅÔ∏è –ì–æ—Å—Ç—å"} ‚Ä¢ {user. email || "–ê–Ω–æ–Ω–∏–º–Ω–æ"}
                </div>
                <button
                  onClick={handleLogout}
                  className="px-3 py-2 rounded-lg bg-rose-600 text-white hover:bg-rose-700"
                >
                  –í—ã—Ö–æ–¥
                </button>
              </div>
            </div>
          </header>

          <main className="max-w-6xl mx-auto px-4 py-6 space-y-4">
            {isAdmin && (
              <div className="flex flex-wrap gap-2">
                <button
                  onClick={() => { setEditingPerson(null); setShowPersonForm(true); }}
                  className="px-3 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700"
                >
                  + –î–æ–±–∞–≤–∏—Ç—å —á–µ–ª–æ–≤–µ–∫–∞
                </button>

                <button
                  onClick={() => setShowCoupleForm(true)}
                  className="px-3 py-2 rounded-lg bg-sky-600 text-white hover: bg-sky-700"
                >
                  + –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä—É
                </button>
              </div>
            )}

            <section className="bg-white border rounded-2xl p-3">
              <div className="px-2 py-2 flex items-start justify-between gap-3">
                <div>
                  <div className="text-lg font-semibold text-slate-900">–î–µ—Ä–µ–≤–æ —Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑</div>
                  <div className="text-xs text-slate-500">
                    {isAdmin && "–°–µ—Ä–¥—Ü–µ/üíî ‚Äî —É–∑–µ–ª –ø–∞—Ä—ã.  –ö–ª–∏–∫ ‚Üí –¥–æ–±–∞–≤–∏—Ç—å —Ä–µ–±—ë–Ω–∫–∞. "}
                  </div>
                </div>
                <div className="text-xs text-slate-500">
                  {people.length} –ª—é–¥–µ–π ‚Ä¢ {couples.length} –ø–∞—Ä
                </div>
              </div>

              {people.length === 0 ?  (
                <div className="p-6 text-slate-600">
                  –ü–æ–∫–∞ –ø—É—Å—Ç–æ.  {isAdmin && "–î–æ–±–∞–≤—å—Ç–µ –ª—é–¥–µ–π –∏ –ø–∞—Ä—ã.  "}
                </div>
              ) : couples.length === 0 ? (
                <div className="p-6 text-slate-600">
                  –ï—Å—Ç—å –ª—é–¥–∏, –Ω–æ –Ω–µ—Ç –ø–∞—Ä. {isAdmin && "–î–æ–±–∞–≤—å—Ç–µ –ø–∞—Ä—É, —á—Ç–æ–±—ã –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –¥–µ—Ä–µ–≤–æ. "}
                </div>
              ) : (
                <div className="tree">
                  <ul className="clearfix">
                    {rootCouples.map(c => (
                      <TreeCoupleNode
                        key={c.id}
                        couple={c}
                        people={people}
                        couplesByPerson={couplesByPerson}
                        expanded={expanded}
                        toggleExpanded={toggleExpanded}
                        onSelectPerson={(id) => setSelectedPersonId(id)}
                        isAdmin={isAdmin}
                        onOpenAddChild={() => openAddChild(c.id)}
                      />
                    ))}
                  </ul>
                </div>
              )}
            </section>

            {/* Detail Modal */}
            {selectedPerson && (
              <PersonDetailModal
                person={selectedPerson}
                isAdmin={isAdmin}
                onClose={() => setSelectedPersonId(null)}
                onEdit={() => { setEditingPerson(selectedPerson); setShowPersonForm(true); setSelectedPersonId(null); }}
                onDelete={() => { const id = selectedPerson.id; setSelectedPersonId(null); deletePerson(id); }}
                couples={couples}
                people={people}
                comments={comments. filter(c => c.personId === selectedPerson.id)}
                onDeleteComment={deleteComment}
                newComment={newComment}
                setNewComment={setNewComment}
                onAddComment={addComment}
                onAddAlbumPhoto={(file) => addPhotoToAlbum(selectedPerson.id, file)}
                onDeleteAlbumPhoto={(idx) => deleteAlbumPhoto(selectedPerson.id, idx)}
              />
            )}
          </main>

          {/* Person Form */}
          {showPersonForm && (
            <PersonFormModal
              person={editingPerson}
              onClose={() => { setShowPersonForm(false); setEditingPerson(null); }}
              onSave={(data) => {
                if (editingPerson) updatePerson(data);
                else addPerson(data);
              }}
            />
          )}

          {/* Couple Form */}
          {showCoupleForm && (
            <CoupleFormModal
              people={people}
              onClose={() => setShowCoupleForm(false)}
              onSave={(data) => addCouple(data)}
            />
          )}

          {/* Add Child Modal */}
          {addChildModal. open && (
            <AddChildModal
              people={people}
              couple={couples. find(c => c.id === addChildModal.coupleId) || null}
              onClose={closeAddChild}
              onCreate={(childData) => createChildAndAttach(addChildModal.coupleId, childData)}
              onAttachExisting={(childId) => attachExistingChild(addChildModal.coupleId, childId)}
            />
          )}
        </div>
      );
    }

    // =========================
    // Tree Components
    // =========================
    function TreeCoupleNode({
      couple,
      people,
      couplesByPerson,
      expanded,
      toggleExpanded,
      onSelectPerson,
      isAdmin,
      onOpenAddChild
    }) {
      const p1 = people.find(p => p.id === couple.partner1Id) || null;
      const p2 = people.find(p => p. id === couple.partner2Id) || null;
      const statusIcon = couple.status === "divorced" ? "üíî" : "‚ù§Ô∏è";

      const children = (couple.childrenIds || [])
        .map(id => people.find(p => p.id === id))
        .filter(Boolean);

      const isExpanded = expanded.has(couple.id);

      return (
        <li>
          <div className="coupleDownLine">
            <div className="coupleRow">
              <PersonCardMini person={p1} onClick={() => p1 && onSelectPerson(p1.id)} />
              <div
                className="coupleMid"
                title={isAdmin ? "–î–æ–±–∞–≤–∏—Ç—å —Ä–µ–±—ë–Ω–∫–∞" : "–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω"}
                aria-disabled={! isAdmin}
                onClick={() => isAdmin && onOpenAddChild()}
              >
                {statusIcon}
              </div>
              <PersonCardMini person={p2} onClick={() => p2 && onSelectPerson(p2.id)} />
            </div>

            {children.length > 0 && (
              <div className="mt-2">
                <button
                  className="text-xs px-2 py-1 rounded-lg bg-slate-100 hover:bg-slate-200 text-slate-700"
                  onClick={() => toggleExpanded(couple.id)}
                >
                  {isExpanded ? "–°–≤–µ—Ä–Ω—É—Ç—å ‚ñ≤" : `–ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–µ–π (${children.length}) ‚ñº`}
                </button>
              </div>
            )}
          </div>

          {children.length > 0 && isExpanded && (
            <ul className="clearfix">
              {children.map(ch => (
                <TreePersonDescNode
                  key={ch.id}
                  person={ch}
                  people={people}
                  couplesByPerson={couplesByPerson}
                  expanded={expanded}
                  toggleExpanded={toggleExpanded}
                  onSelectPerson={onSelectPerson}
                  isAdmin={isAdmin}
                />
              ))}
            </ul>
          )}
        </li>
      );
    }

    function TreePersonDescNode({
      person,
      people,
      couplesByPerson,
      expanded,
      toggleExpanded,
      onSelectPerson,
      isAdmin
    }) {
      const personCouples = couplesByPerson. get(person.id) || [];
      const firstCouple = personCouples[0] || null;
      const hasOwnCouple = Boolean(firstCouple);
      const isExpanded = expanded.has("person_" + person.id);

      return (
        <li>
          <div className="flex flex-col items-center gap-2">
            <PersonCardMini person={person} onClick={() => onSelectPerson(person. id)} />

            {hasOwnCouple && (
              <button
                className="text-xs px-2 py-1 rounded-lg bg-slate-100 hover:bg-slate-200 text-slate-700"
                onClick={() => toggleExpanded("person_" + person.id)}
              >
                {isExpanded ? "–°–≤–µ—Ä–Ω—É—Ç—å ‚ñ≤" : "–ü–æ–∫–∞–∑–∞—Ç—å –≤–µ—Ç–∫—É ‚ñº"}
              </button>
            )}
          </div>

          {hasOwnCouple && isExpanded && (
            <ul className="clearfix">
              <TreeCoupleNode
                couple={firstCouple}
                people={people}
                couplesByPerson={couplesByPerson}
                expanded={expanded}
                toggleExpanded={toggleExpanded}
                onSelectPerson={onSelectPerson}
                isAdmin={isAdmin}
                onOpenAddChild={() => {}}
              />
            </ul>
          )}
        </li>
      );
    }

    function PersonCardMini({ person, onClick }) {
      if (! person) {
        return (
          <div className="personCard opacity-60 cursor-not-allowed">
            <div className="avatar">? </div>
            <div className="text-left min-w-0">
              <div className="font-semibold text-slate-900 truncate">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
              <div className="text-xs text-slate-500">‚Äî</div>
            </div>
          </div>
        );
      }

      const initials = ((person.firstName? .[0] || "? ") + (person.lastName?.[0] || "")).toUpperCase();
      const genderIcon = person.gender === "F" ? "‚ôÄ" : "‚ôÇ";

      return (
        <div className="personCard" onClick={onClick} title="–û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É">
          {person.mainPhoto ?  (
            <img className="avatar" src={person.mainPhoto} alt="–§–æ—Ç–æ" />
          ) : (
            <div className="avatar">{initials}</div>
          )}

          <div className="text-left min-w-0">
            <div className="font-semibold text-slate-900 truncate">{person.lastName} {person.firstName}</div>
            <div className="text-xs text-slate-500 truncate">{person.middleName || " "}</div>
            <div className="text-xs text-slate-600 flex items-center gap-2">
              <span>{genderIcon}</span>
              <span>{yearRange(person.birthDate, person. deathDate)}</span>
            </div>
          </div>
        </div>
      );
    }

    // =========================
    // Modals
    // =========================
    function Modal({ children, onClose }) {
      return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-2xl w-full max-w-lg p-5 shadow-xl">
            <div className="flex justify-end">
              <button onClick={onClose} className="px-3 py-1 rounded-lg bg-slate-200 hover: bg-slate-300 text-slate-800 text-sm">
                –ó–∞–∫—Ä—ã—Ç—å
              </button>
            </div>
            <div className="mt-3">{children}</div>
          </div>
        </div>
      );
    }

    function Field({ label, children, className = "" }) {
      return (
        <div className={className}>
          <label className="block text-sm font-medium text-slate-900 mb-1">{label}</label>
          {children}
        </div>
      );
    }

    function PersonFormModal({ person, onClose, onSave }) {
      const [form, setForm] = useState(person || {
        id: uid(),
        firstName: "",
        lastName: "",
        middleName: "",
        gender:  "M",
        birthDate: "",
        deathDate: "",
        description: "",
        mainPhoto: "",
        photos: []
      });

      const handleMainPhoto = (file) => {
        if (! file) return;
        const reader = new FileReader();
        reader.onloadend = () => {
          const dataUrl = String(reader.result || "");
          setForm(prev => ({
            ...prev,
            mainPhoto: dataUrl,
            photos: prev.photos?. length ? prev.photos :  (dataUrl ?  [dataUrl] : [])
          }));
        };
        reader.readAsDataURL(file);
      };

      const submit = () => {
        if (!form.lastName. trim() || !form.firstName. trim()) {
          alert("–ò–º—è –∏ —Ñ–∞–º–∏–ª–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã");
          return;
        }
        onSave(form);
      };

      return (
        <Modal onClose={onClose}>
          <div className="text-lg font-semibold mb-3">
            {person ? "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —á–µ–ª–æ–≤–µ–∫–∞" : "–î–æ–±–∞–≤–∏—Ç—å —á–µ–ª–æ–≤–µ–∫–∞"}
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
            <Field label="–§–∞–º–∏–ª–∏—è *">
              <input className="w-full border rounded-xl px-3 py-2"
                     value={form.lastName}
                     onChange={(e) => setForm(prev => ({...prev, lastName: e.target.value}))} />
            </Field>
            <Field label="–ò–º—è *">
              <input className="w-full border rounded-xl px-3 py-2"
                     value={form.firstName}
                     onChange={(e) => setForm(prev => ({...prev, firstName: e.target.value}))} />
            </Field>

            <Field label="–û—Ç—á–µ—Å—Ç–≤–æ" className="md:col-span-2">
              <input className="w-full border rounded-xl px-3 py-2"
                     value={form.middleName}
                     onChange={(e) => setForm(prev => ({...prev, middleName: e.target. value}))} />
            </Field>

            <Field label="–ü–æ–ª">
              <select className="w-full border rounded-xl px-3 py-2"
                      value={form.gender}
                      onChange={(e) => setForm(prev => ({...prev, gender: e.target.value}))}>
                <option value="M">–ú—É–∂—Å–∫–æ–π</option>
                <option value="F">–ñ–µ–Ω—Å–∫–∏–π</option>
              </select>
            </Field>

            <Field label="–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è">
              <input type="date" className="w-full border rounded-xl px-3 py-2"
                     value={form.birthDate}
                     onChange={(e) => setForm(prev => ({...prev, birthDate: e.target.value}))} />
            </Field>

            <Field label="–î–∞—Ç–∞ —Å–º–µ—Ä—Ç–∏">
              <input type="date" className="w-full border rounded-xl px-3 py-2"
                     value={form.deathDate}
                     onChange={(e) => setForm(prev => ({...prev, deathDate: e.target.value}))} />
            </Field>

            <Field label="–û–ø–∏—Å–∞–Ω–∏–µ" className="md:col-span-2">
              <textarea rows="3" className="w-full border rounded-xl px-3 py-2"
                        value={form.description}
                        onChange={(e) => setForm(prev => ({...prev, description: e. target.value}))} />
            </Field>

            <Field label="–ì–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ" className="md:col-span-2">
              <input type="file" accept="image/*" className="w-full border rounded-xl px-3 py-2"
                     onChange={(e) => handleMainPhoto(e.target. files? .[0])} />
              {form.mainPhoto && (
                <img src={form.mainPhoto} className="mt-2 w-28 h-28 rounded-xl object-cover border" alt="preview" />
              )}
            </Field>
          </div>

          <div className="mt-4 flex gap-2">
            <button onClick={submit} className="flex-1 px-3 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700">
              –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
            </button>
            <button onClick={onClose} className="flex-1 px-3 py-2 rounded-xl bg-slate-200 text-slate-800 hover:bg-slate-300">
              –û—Ç–º–µ–Ω–∞
            </button>
          </div>
        </Modal>
      );
    }

    function CoupleFormModal({ people, onClose, onSave }) {
      const [form, setForm] = useState({
        partner1Id: "",
        partner2Id:  "",
        status: "married"
      });

      const submit = () => {
        if (!form.partner1Id || !form.partner2Id) {
          alert("–í—ã–±–µ—Ä–∏ –¥–≤—É—Ö –ª—é–¥–µ–π");
          return;
        }
        if (form.partner1Id === form.partner2Id) {
          alert("–ù—É–∂–Ω—ã –¥–≤–∞ —Ä–∞–∑–Ω—ã—Ö —á–µ–ª–æ–≤–µ–∫–∞");
          return;
        }
        onSave(form);
      };

      return (
        <Modal onClose={onClose}>
          <div className="text-lg font-semibold mb-3">–î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä—É</div>

          <div className="space-y-3">
            <Field label="–ü–∞—Ä—Ç–Ω—ë—Ä 1">
              <select className="w-full border rounded-xl px-3 py-2"
                      value={form. partner1Id}
                      onChange={(e) => setForm(prev => ({...prev, partner1Id: e.target.value}))}>
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ‚Ä¶</option>
                {people. map(p => (
                  <option key={p.id} value={p.id}>{safeName(p)}</option>
                ))}
              </select>
            </Field>

            <Field label="–ü–∞—Ä—Ç–Ω—ë—Ä 2">
              <select className="w-full border rounded-xl px-3 py-2"
                      value={form.partner2Id}
                      onChange={(e) => setForm(prev => ({...prev, partner2Id: e.target.value}))}>
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ‚Ä¶</option>
                {people.map(p => (
                  <option key={p.id} value={p.id}>{safeName(p)}</option>
                ))}
              </select>
            </Field>

            <Field label="–°—Ç–∞—Ç—É—Å">
              <select className="w-full border rounded-xl px-3 py-2"
                      value={form.status}
                      onChange={(e) => setForm(prev => ({...prev, status: e. target.value}))}>
                <option value="married">–ë—Ä–∞–∫ ‚ù§Ô∏è</option>
                <option value="divorced">–†–∞–∑–≤–æ–¥ üíî</option>
              </select>
            </Field>
          </div>

          <div className="mt-4 flex gap-2">
            <button onClick={submit} className="flex-1 px-3 py-2 rounded-xl bg-sky-600 text-white hover: bg-sky-700">
              –î–æ–±–∞–≤–∏—Ç—å
            </button>
            <button onClick={onClose} className="flex-1 px-3 py-2 rounded-xl bg-slate-200 text-slate-800 hover:bg-slate-300">
              –û—Ç–º–µ–Ω–∞
            </button>
          </div>
        </Modal>
      );
    }

    function AddChildModal({ people, couple, onClose, onCreate, onAttachExisting }) {
      const [mode, setMode] = useState("create");
      const [existingId, setExistingId] = useState("");
      const [child, setChild] = useState({
        firstName: "",
        lastName:  "",
        middleName: "",
        gender: "M",
        birthDate: "",
        deathDate: "",
        description:  "",
        mainPhoto: ""
      });

      const submit = () => {
        if (mode === "create") {
          if (!child.firstName. trim()) {
            alert("–ò–º—è —Ä–µ–±—ë–Ω–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ");
            return;
          }
          onCreate(child);
        } else {
          if (!existingId) {
            alert("–í—ã–±–µ—Ä–∏ —Ä–µ–±—ë–Ω–∫–∞");
            return;
          }
          onAttachExisting(existingId);
        }
      };

      return (
        <Modal onClose={onClose}>
          <div className="text-lg font-semibold mb-3">–î–æ–±–∞–≤–∏—Ç—å —Ä–µ–±—ë–Ω–∫–∞</div>

          <div className="mb-4 flex gap-2">
            <button
              className={"px-3 py-1 rounded-lg " + (mode === "create" ?  "bg-indigo-600 text-white" : "bg-slate-200 text-slate-800")}
              onClick={() => setMode("create")}
            >
              –ù–æ–≤—ã–π —Ä–µ–±—ë–Ω–æ–∫
            </button>
            <button
              className={"px-3 py-1 rounded-lg " + (mode === "attach" ? "bg-indigo-600 text-white" : "bg-slate-200 text-slate-800")}
              onClick={() => setMode("attach")}
            >
              –ò–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö
            </button>
          </div>

          {mode === "create" ?  (
            <div className="space-y-3">
              <Field label="–ò–º—è *">
                <input className="w-full border rounded-xl px-3 py-2"
                       value={child.firstName}
                       onChange={(e) => setChild(prev => ({... prev, firstName: e.target. value}))} />
              </Field>
              <Field label="–§–∞–º–∏–ª–∏—è">
                <input className="w-full border rounded-xl px-3 py-2"
                       value={child.lastName}
                       onChange={(e) => setChild(prev => ({...prev, lastName: e.target.value}))} />
              </Field>
              <Field label="–ü–æ–ª">
                <select className="w-full border rounded-xl px-3 py-2"
                        value={child.gender}
                        onChange={(e) => setChild(prev => ({...prev, gender: e.target.value}))}>
                  <option value="M">–ú—É–∂—Å–∫–æ–π</option>
                  <option value="F">–ñ–µ–Ω—Å–∫–∏–π</option>
                </select>
              </Field>
            </div>
          ) : (
            <Field label="–í—ã–±–µ—Ä–∏ —Ä–µ–±—ë–Ω–∫–∞">
              <select className="w-full border rounded-xl px-3 py-2"
                      value={existingId}
                      onChange={(e) => setExistingId(e.target.value)}>
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ‚Ä¶</option>
                {people.map(p => (
                  <option key={p.id} value={p.id}>{safeName(p)}</option>
                ))}
              </select>
            </Field>
          )}

          <div className="mt-4 flex gap-2">
            <button onClick={submit} className="flex-1 px-3 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700">
              –î–æ–±–∞–≤–∏—Ç—å
            </button>
            <button onClick={onClose} className="flex-1 px-3 py-2 rounded-xl bg-slate-200 text-slate-800 hover:bg-slate-300">
              –û—Ç–º–µ–Ω–∞
            </button>
          </div>
        </Modal>
      );
    }

    function PersonDetailModal({
      person,
      isAdmin,
      onClose,
      onEdit,
      onDelete,
      couples,
      people,
      comments,
      onDeleteComment,
      newComment,
      setNewComment,
      onAddComment,
      onAddAlbumPhoto,
      onDeleteAlbumPhoto
    }) {
      const personCouples = couples.filter(c => c.partner1Id === person.id || c.partner2Id === person.id);

      return (
        <Modal onClose={onClose}>
          <div className="flex items-start justify-between gap-4 mb-4">
            <div>
              <div className="text-2xl font-bold text-slate-900">{person.lastName} {person.firstName}</div>
              <div className="text-sm text-slate-600">{person.middleName}</div>
              <div className="text-xs text-slate-500 mt-1">
                {person.gender === "F" ? "‚ôÄ –ñ–µ–Ω—â–∏–Ω–∞" : "‚ôÇ –ú—É–∂—á–∏–Ω–∞"}
              </div>
            </div>
            {isAdmin && (
              <div className="flex gap-1">
                <button onClick={onEdit} className="px-2 py-1 rounded-lg bg-sky-600 text-white text-sm hover:bg-sky-700">
                  –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                </button>
                <button onClick={onDelete} className="px-2 py-1 rounded-lg bg-rose-600 text-white text-sm hover:bg-rose-700">
                  –£–¥–∞–ª–∏—Ç—å
                </button>
              </div>
            )}
          </div>

          {person.mainPhoto && (
            <img src={person.mainPhoto} className="w-full h-48 object-cover rounded-xl mb-4" alt="–§–æ—Ç–æ" />
          )}

          <div className="space-y-4 max-h-96 overflow-y-auto">
            {person. birthDate && (
              <div className="text-sm">
                <span className="font-semibold text-slate-900">–†–æ–∂–¥–µ–Ω–∏–µ:</span>
                <span className="text-slate-600 ml-2">{new Date(person.birthDate).toLocaleDateString("ru-RU")}</span>
              </div>
            )}

            {person.deathDate && (
              <div className="text-sm">
                <span className="font-semibold text-slate-900">–°–º–µ—Ä—Ç—å:</span>
                <span className="text-slate-600 ml-2">{new Date(person.deathDate).toLocaleDateString("ru-RU")}</span>
              </div>
            )}

            {person.description && (
              <div className="text-sm">
                <span className="font-semibold text-slate-900">–û–ø–∏—Å–∞–Ω–∏–µ:</span>
                <p className="text-slate-600 mt-1">{person.description}</p>
              </div>
            )}

            {personCouples.length > 0 && (
              <div className="text-sm">
                <span className="font-semibold text-slate-900">–ü–∞—Ä—Ç–Ω—ë—Ä—ã:</span>
                <ul className="mt-1 space-y-1">
                  {personCouples.map(c => {
                    const partner = c.partner1Id === person.id ? people.find(p => p.id === c.partner2Id) : people.find(p => p.id === c.partner1Id);
                    return (
                      <li key={c.id} className="text-slate-600">
                        {partner ? safeName(partner) : "?"} {c.status === "divorced" ? "üíî" : "‚ù§Ô∏è"}
                      </li>
                    );
                  })}
                </ul>
              </div>
            )}

            {person.photos?. length > 0 && (
              <div className="text-sm">
                <span className="font-semibold text-slate-900">–ê–ª—å–±–æ–º:  </span>
                <div className="grid grid-cols-3 gap-2 mt-2">
                  {person.photos.map((photo, idx) => (
                    <div key={idx} className="relative group">
                      <img src={photo} className="w-full h-24 object-cover rounded-lg" alt={`Photo ${idx + 1}`} />
                      {isAdmin && (
                        <button
                          onClick={() => onDeleteAlbumPhoto(idx)}
                          className="absolute top-1 right-1 bg-rose-600 text-white rounded px-2 py-1 text-xs opacity-0 group-hover:opacity-100"
                        >
                          ‚úï
                        </button>
                      )}
                    </div>
                  ))}
                </div>
              </div>
            )}

            {isAdmin && (
              <Field label="–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ –≤ –∞–ª—å–±–æ–º">
                <input type="file" accept="image/*" className="w-full border rounded-xl px-3 py-2"
                       onChange={(e) => onAddAlbumPhoto(e.target.files?.[0])} />
              </Field>
            )}

            <div className="border-t pt-4">
              <div className="font-semibold text-slate-900 mb-2">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ ({comments.length})</div>

              <div className="space-y-2 mb-3">
                {comments.map(c => (
                  <div key={c.id} className="bg-slate-100 rounded-lg p-2 text-sm">
                    <div className="flex items-center justify-between mb-1">
                      <span className="font-semibold text-slate-900">{c. author}</span>
                      {isAdmin && (
                        <button
                          onClick={() => onDeleteComment(c.id)}
                          className="text-rose-600 hover:text-rose-700 text-xs"
                        >
                          ‚úï
                        </button>
                      )}
                    </div>
                    <div className="text-slate-600">{c.text}</div>
                    <div className="text-xs text-slate-500 mt-1">
                      {new Date(c.date).toLocaleDateString("ru-RU", { hour: "2-digit", minute: "2-digit" })}
                    </div>
                  </div>
                ))}
              </div>

              <div className="flex gap-2">
                <input
                  type="text"
                  className="flex-1 border rounded-xl px-3 py-2 text-sm"
                  placeholder="–ù–∞–ø–∏—Å–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π‚Ä¶"
                  value={newComment}
                  onChange={(e) => setNewComment(e.target.value)}
                  onKeyDown={(e) => e.key === "Enter" && onAddComment()}
                />
                <button
                  onClick={onAddComment}
                  className="px-3 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 text-sm"
                >
                  –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                </button>
              </div>
            </div>
          </div>
        </Modal>
      );
    }

    // =========================
    // Render
    // =========================
    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
