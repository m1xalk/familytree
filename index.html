<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–†–æ–¥–æ—Å–ª–æ–≤–Ω–æ–µ –¥–µ—Ä–µ–≤–æ</title>

  <!-- React (UMD) + Babel –¥–ª—è GitHub Pages -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

  <style>
    /* –î–µ—Ä–µ–≤–æ */
    .rootTree { padding-top: 0; margin-top: 0; }

    .tree { padding: 12px; overflow: auto; }
    .tree ul { padding-top: 24px; position: relative; }
    .tree li {
      float: left;
      text-align: center;
      list-style: none;
      position: relative;
      padding: 24px 10px 0 10px;
      min-width: 260px;
    }

    .tree li::before,
    .tree li::after {
      content: "";
      position: absolute;
      top: 0;
      right: 50%;
      border-top: 2px solid #000000;
      width: 50%;
      height: 24px;
    }
    .tree li::after {
      right: auto;
      left: 50%;
      border-left: 2px solid #000000;
    }

    .tree li:only-child::before,
    .tree li:only-child::after { display: none; }
    .tree li:only-child { padding-top: 0; }

    .tree li:first-child::before { border: 0 none; }
    .tree li:last-child::after { border: 0 none; }
    .tree li:last-child::before { border-right: 2px solid #000000; border-radius: 0 10px 0 0; }
    .tree li:first-child::after { border-radius: 10px 0 0 0; }

    .tree ul ul::before {
      content: "";
      position: absolute;
      top: 0;
      left: 50%;
      border-left: 2px solid #000000;
      width: 0;
      height: 24px;
    }

    /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
    .personCard {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border: 1px solid #e2e8f0;
      border-radius: 18px;
      background: #fff;
      box-shadow: 0 10px 28px rgba(15,23,42,0.08);
      max-width: 340px;
      cursor: pointer;
      user-select: none;
      transition: transform .15s ease, box-shadow .15s ease;
    }
    .personCard:hover { transform: translateY(-2px); box-shadow: 0 16px 40px rgba(15,23,42,0.12); }

    .avatar {
      width: 46px;
      height: 46px;
      border-radius: 999px;
      object-fit: cover;
      background: linear-gradient(135deg, #4f46e5, #9333ea);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      color: #fff;
      flex: 0 0 auto;
      overflow: hidden;
      box-shadow: 0 10px 25px rgba(79,70,229,0.25);
    }

    /* –ù–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –ø–∞—Ä—ã –Ω–∞ –æ–¥–Ω–æ–π –ª–∏–Ω–∏–∏ */
    .coupleContainer {
      display: inline-block;
      position: relative;
    }

    .coupleRow { 
      display: inline-flex; 
      align-items: center; 
      gap: 16px; 
      position: relative;
      padding-bottom: 12px;
    }
    
    /* –õ–∏–Ω–∏—è –≤–Ω–∏–∑ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ –ø–∞—Ä—ã –∫ –¥–µ—Ç—è–º */
    .coupleRow::after {
      content: "";
      position: absolute;
      left: 50%;
      bottom: 0;
      transform: translateX(-50%);
      width: 2px;
      height: 12px;
      background: #000000;
    }

    /* –î–ª—è –ø–∞—Ä—ã —Ä–µ–±–µ–Ω–∫–∞ - –ª–∏–Ω–∏—è –∏–¥–µ—Ç –æ—Ç —Å–µ—Ä–¥–µ—á–∫–∞ */
    .coupleRowChild {
      display: inline-flex; 
      align-items: center; 
      gap: 16px; 
      position: relative;
      padding-bottom: 12px;
    }

    .coupleRowChild::after {
      content: "";
      position: absolute;
      left: 19px; /* –¶–µ–Ω—Ç—Ä —Å–µ—Ä–¥–µ—á–∫–∞ (38px / 2) */
      bottom: 0;
      width: 2px;
      height: 12px;
      background: #000000;
    }
    /* –Ø–∫–æ—Ä—å: –ª–∏–Ω–∏—è –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª–µ–π –∫ –∫–∞—Ä—Ç–æ—á–∫–µ —Ä–µ–±—ë–Ω–∫–∞ (–∞ –Ω–µ –∫ —Å–µ—Ä–¥–µ—á–∫—É) */
    .coupleRowAnchored{
      display: inline-flex;
      align-items: center;
      gap: 16px;
      position: relative;
      padding-top: 22px; /* –º–µ—Å—Ç–æ –¥–ª—è –≤–µ—Ä—Ö–Ω–µ–≥–æ ¬´–ø–µ—Ä–µ–≤–æ–¥–∞¬ª –ª–∏–Ω–∏–∏ */
      padding-bottom: 12px;
    }
    .coupleRowAnchored .anchorOverlay{
      position:absolute;
      left:0; top:0;
      width:100%;
      height:22px;
      pointer-events:none;
    }


    .coupleMid {
      width: 38px; height: 38px; border-radius: 999px;
      border: 2px solid #e2e8f0; background: #fff;
      display: inline-flex; align-items: center; justify-content: center;
      font-size: 18px;
      box-shadow: 0 8px 20px rgba(15,23,42,0.10);
      cursor: pointer;
      user-select: none;
      transition: transform .15s ease, box-shadow .15s ease, opacity .15s ease;
      flex-shrink: 0;
    }
    .coupleMid:not([aria-disabled="true"]):hover { transform: scale(1.08); box-shadow: 0 12px 26px rgba(15,23,42,0.16); }
    .coupleMid[aria-disabled="true"] { cursor: default; opacity: 0.55; }

    .clearfix::after { content: ""; display: table; clear: both; }

    /* –ú–æ–¥–∞–ª–∫–∏ */
    .modal-overlay { animation: fadeIn .18s ease-out; }
    .modal-content { animation: slideUp .22s ease-out; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(18px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
    @media (max-width: 640px) {
      .tree { padding: 8px; }
      .tree li { min-width: 180px; padding: 18px 4px 0 4px; }
      .tree ul { padding-top: 18px; }
      .tree ul ul::before { height: 18px; }
      .tree li::before, .tree li::after { height: 18px; }
      
      .personCard { 
        max-width: 160px; 
        padding: 6px 8px; 
        border-radius: 14px;
        gap: 6px;
        flex-direction: column;
        text-align: center;
      }
      
      .personCard .text-left {
        text-align: center !important;
      }
      
      .avatar { width: 36px; height: 36px; font-size: 14px; }
      .coupleMid { width: 30px; height: 30px; font-size: 16px; }
      .coupleRow { gap: 8px; }
      
      /* –£–º–µ–Ω—å—à–∞–µ–º —Ç–µ–∫—Å—Ç –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö */
      .personCard .font-semibold { font-size: 12px; }
      .personCard .text-xs { font-size: 10px; }
    }

    @media (max-width: 480px) {
      .tree li { min-width: 140px; }
      .personCard { max-width: 130px; padding: 5px 6px; }
      .avatar { width: 32px; height: 32px; font-size: 12px; }
      .coupleMid { width: 26px; height: 26px; font-size: 14px; }
      .personCard .font-semibold { font-size: 11px; }
      .personCard .text-xs { font-size: 9px; }
    }
  
    /* === Graph SVG links (like index211), behind cards === */
    .tree { position: relative; }
    .treeLinksSvg { position: absolute; inset: 0; width: 100%; height: 100%; pointer-events: none; overflow: visible; z-index: 0; }
    .coupleContainer, .personCard, .tree li { position: relative; z-index: 10; }
    /* hide old CSS connectors */
    .tree li::before,
    .tree li::after,
    .tree ul ul::before,
    .coupleRow::after,
    .coupleRowChild::after {
      display: none !important;
      content: none !important;
      border: 0 !important;
      background: transparent !important;
    }

  </style>
</head>

<body class="bg-gradient-to-br from-slate-50 to-slate-100">
  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useState, useRef, useLayoutEffect } = React;

    // =========================
    // FIREBASE CONFIG
    // =========================
    const firebaseConfig = {
      apiKey: "AIzaSyDJKvh7T9MJGXHWoA3LsESEXWsQxiIbFd4",
      authDomain: "familytree-ee339.firebaseapp.com",
      projectId: "familytree-ee339",
      storageBucket: "familytree-ee339.firebasestorage.app",
      messagingSenderId: "986703703890",
      appId: "1:986703703890:web:71ea30a750e7867dd1548b"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // =========================
    // utils
    // =========================
    const uid = () => String(Date.now()) + "_" + Math.floor(Math.random() * 100000);

    const yearRange = (birthDate, deathDate) => {
      const y = (d) => d ? new Date(d).getFullYear() : "";
      const b = y(birthDate);
      const dd = y(deathDate);
      if (!b && !dd) return "‚Äî";
      if (b && !dd) return String(b);
      if (b && dd) return `${b}‚Äî${dd}`;
      return `‚Äî${dd ? "‚Äî" + dd : ""}`;
    };

    const safeName = (p) => {
      const ln = (p?.lastName || "").trim();
      const fn = (p?.firstName || "").trim();
      const mn = (p?.middleName || "").trim();
      const base = (ln + " " + fn).trim() || "–ë–µ–∑ –∏–º–µ–Ω–∏";
      return mn ? (base + " " + mn).trim() : base;
    };

    const safeText = (s) => String(s || "").trim();

    const sortByDateDesc = (a, b) => {
      const da = a?.date ? new Date(a.date).getTime() : 0;
      const dbb = b?.date ? new Date(b.date).getTime() : 0;
      return dbb - da;
    };

    // =========================
    // App
    // =========================
    function App() {
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);
      const [isAdmin, setIsAdmin] = useState(false);

      const [showLogin, setShowLogin] = useState(false);
      const [email, setEmail] = useState("");
      const [password, setPassword] = useState("");

      const [people, setPeople] = useState([]);
      const [couples, setCouples] = useState([]);
      const [comments, setComments] = useState([]);

      // Root couples selection (to avoid connecting unrelated top nodes)
      const [rootCoupleIds, setRootCoupleIds] = useState([]);
      const [showRootsModal, setShowRootsModal] = useState(false);
      const [rootsDraft, setRootsDraft] = useState([]);

      const [selectedPersonId, setSelectedPersonId] = useState(null);
      const selectedPerson = useMemo(
        () => people.find(p => p.id === selectedPersonId) || null,
        [people, selectedPersonId]
      );

      const [expandedCouples, setExpandedCouples] = useState(new Set());
      const [allExpanded, setAllExpanded] = useState(true);

      const [viewMode, setViewMode] = useState("tree"); // "tree" –∏–ª–∏ "list"
      const [searchQuery, setSearchQuery] = useState("");

      const filteredPeople = useMemo(() => {
              if (!searchQuery.trim()) return people;
              
              const query = searchQuery.toLowerCase().trim();
              return people.filter(p => {
                const lastName = (p.lastName || "").toLowerCase();
                const firstName = (p.firstName || "").toLowerCase();
                const middleName = (p.middleName || "").toLowerCase();
                return lastName.includes(query) || firstName.includes(query) || middleName.includes(query);
              });
            }, [people, searchQuery]);
      
            const sortedPeopleByAge = useMemo(() => {
              return [...filteredPeople].sort((a, b) => {
                const yearA = a.birthDate ? new Date(a.birthDate).getFullYear() : 9999;
                const yearB = b.birthDate ? new Date(b.birthDate).getFullYear() : 9999;
                return yearA - yearB;
              });

      const matchesSearch = (person) => {
        const q = (searchQuery || "").toLowerCase().trim();
        if (!q) return true;
        const lastName = (person?.lastName || "").toLowerCase();
        const firstName = (person?.firstName || "").toLowerCase();
        const middleName = (person?.middleName || "").toLowerCase();
        return lastName.includes(q) || firstName.includes(q) || middleName.includes(q);
      };

      const [showPersonForm, setShowPersonForm] = useState(false);
      const [editingPerson, setEditingPerson] = useState(null);

      const [showCoupleForm, setShowCoupleForm] = useState(false);

      const [addChildModal, setAddChildModal] = useState({ open: false, coupleId: null });

      const [newComment, setNewComment] = useState("");

      const [unsubs, setUnsubs] = useState([]);

      const stopListeners = () => {
        try { unsubs.forEach(fn => fn && fn()); } catch(e) {}
        setUnsubs([]);
      };

      const loadDataFromFirestore = () => {
        stopListeners();

        const u1 = db.collection("people").onSnapshot((snapshot) => {
          const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          setPeople(data);
        });

        const u2 = db.collection("couples").onSnapshot((snapshot) => {
          const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          setCouples(data);
        });

        const u3 = db.collection("comments").onSnapshot((snapshot) => {
          const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort(sortByDateDesc);
          setComments(data);
        });

        const u4 = db.collection("settings").doc("tree").onSnapshot((doc) => {
          const d = doc.exists ? doc.data() : null;
          setRootCoupleIds(Array.isArray(d?.rootCoupleIds) ? d.rootCoupleIds : []);
        });

        setUnsubs([u1, u2, u3, u4]);
      };

      const refreshAdminFlag = async (u) => {
        if (!u) { setIsAdmin(false); return; }
        try {
          const adminDoc = await db.collection("admins").doc(u.uid).get();
          setIsAdmin(adminDoc.exists);
        } catch (err) {
          console.error("Admin check error:", err);
          setIsAdmin(false);
        }
      };

      useEffect(() => {
        const unsubscribe = auth.onAuthStateChanged(async (currentUser) => {
          setUser(currentUser || null);

          if (currentUser) {
            await refreshAdminFlag(currentUser);
            loadDataFromFirestore();
            setLoading(false);
            return;
          }

          setIsAdmin(false);
          stopListeners();
          setPeople([]);
          setCouples([]);
          setComments([]);
          setRootCoupleIds([]);
          setLoading(false);
        });

        return () => {
          unsubscribe();
          stopListeners();
        };
      }, []);

      

      // –ê–≤—Ç–æ-—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ: –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Ä–µ–Ω–¥–µ—Ä–µ –¥–µ—Ä–µ–≤–∞ –¥–µ—Ä–∂–∏–º –≤—Å–µ –ø–∞—Ä—ã —Ä–∞—Å–∫—Ä—ã—Ç—ã–º–∏,
      // —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∞ "–°–≤–µ—Ä–Ω—É—Ç—å –≤—Å—ë" —Ä–∞–±–æ—Ç–∞–ª–∞ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ.
      useEffect(() => {
        if (viewMode !== "tree") return;
        if (!allExpanded) return;
        if (!couples || couples.length === 0) return;

        // –µ—Å–ª–∏ set –ø—É—Å—Ç–æ–π –∏–ª–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ –ø–∞—Ä—ã ‚Äî –∑–∞–ø–æ–ª–Ω–∏–º
        setExpandedCouples(prev => {
          const all = new Set(couples.map(c => c.id));
          if (prev && prev.size === all.size) return prev;
          return all;
        });
      }, [viewMode, allExpanded, couples]);
// =========================
      // Auth handlers
      // =========================
      const handleAdminLogin = async () => {
        try {
          await auth.signInWithEmailAndPassword(safeText(email), safeText(password));
          setShowLogin(false);
          setEmail("");
          setPassword("");
        } catch (err) {
          alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: " + err.message);
        }
      };

      const handleGuestLogin = async () => {
        try {
          await auth.signInAnonymously();
        } catch (err) {
          alert("–û—à–∏–±–∫–∞ –≥–æ—Å—Ç–µ–≤–æ–≥–æ –≤—Ö–æ–¥–∞: " + err.message);
        }
      };

      const handleLogout = async () => {
        try { await auth.signOut(); } catch (e) {}
        setIsAdmin(false);
        setSelectedPersonId(null);
      };

      // =========================
      // CRUD: people
      // =========================
      const addPerson = async (data) => {
        if (!isAdmin) return;
        const newId = uid();
        const p = normalizePerson(data);
        await db.collection("people").doc(newId).set(p);
        setShowPersonForm(false);
      };

      const updatePerson = async (data) => {
        if (!isAdmin) return;
        const p = normalizePerson(data);
        await db.collection("people").doc(data.id).update(p);
        setEditingPerson(null);
        setShowPersonForm(false);
        setSelectedPersonId(data.id);
      };

      const deletePerson = async (personId) => {
        if (!isAdmin) return;
        if (!confirm("–£–¥–∞–ª–∏—Ç—å —á–µ–ª–æ–≤–µ–∫–∞? –°–≤—è–∑–∏ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –±—É–¥—É—Ç –æ—á–∏—â–µ–Ω—ã.")) return;

        await db.collection("people").doc(personId).delete();

        const couplesSnap = await db.collection("couples").get();
        for (const coupleDoc of couplesSnap.docs) {
          const couple = coupleDoc.data();
          const docId = coupleDoc.id;

          if (couple.partner1Id === personId || couple.partner2Id === personId) {
            await db.collection("couples").doc(docId).delete();
            continue;
          }

          if ((couple.childrenIds || []).includes(personId)) {
            await db.collection("couples").doc(docId).update({
              childrenIds: (couple.childrenIds || []).filter(id => id !== personId)
            });
          }
        }

        const commentsSnap = await db.collection("comments").where("personId", "==", personId).get();
        for (const commentDoc of commentsSnap.docs) {
          await db.collection("comments").doc(commentDoc.id).delete();
        }

        if (selectedPersonId === personId) setSelectedPersonId(null);
      };

      // =========================
      // CRUD: couples
      // =========================
      const addCouple = async (data) => {
        if (!isAdmin) return;
        const newId = uid();
        const c = {
          partner1Id: data.partner1Id,
          partner2Id: data.partner2Id,
          status: data.status || "married",
          childrenIds: [],
        };
        await db.collection("couples").doc(newId).set(c);
        setShowCoupleForm(false);
        setExpandedCouples(prev => new Set([...prev, newId]));
      };

      const deleteCouple = async (coupleId) => {
        if (!isAdmin) return;
        if (!confirm("–£–¥–∞–ª–∏—Ç—å –ø–∞—Ä—É? –î–µ—Ç–∏ –æ—Å—Ç–∞–Ω—É—Ç—Å—è –∫–∞–∫ –ª—é–¥–∏.")) return;
        await db.collection("couples").doc(coupleId).delete();
      };

      const updateCouple = async (coupleId, patch) => {
        if (!isAdmin) return;
        await db.collection("couples").doc(coupleId).update(patch);
      };

      // =========================
      // Comments
      // =========================
      const addComment = async () => {
        if (!selectedPerson || !user) return;
        const text = safeText(newComment);
        if (!text) return;

        const newId = uid();

        const author =
          isAdmin ? "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä" :
          (user.isAnonymous ? "–ì–æ—Å—Ç—å" : (user.email || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"));

        await db.collection("comments").doc(newId).set({
          personId: selectedPerson.id,
          author,
          text,
          date: new Date().toISOString(),
          userId: user.uid
        });

        setNewComment("");
      };

      const deleteComment = async (commentId) => {
        if (!isAdmin) return;
        await db.collection("comments").doc(commentId).delete();
      };

      // =========================
      // Photos
      // =========================
      const addPhotoToAlbum = async (personId, file) => {
        if (!isAdmin || !file) return;

        const reader = new FileReader();
        reader.onloadend = async () => {
          const dataUrl = String(reader.result || "");
          const person = people.find(p => p.id === personId);
          const nextPhotos = [...(person?.photos || []), dataUrl];
          await db.collection("people").doc(personId).update({ photos: nextPhotos });
          setSelectedPersonId(personId);
        };
        reader.readAsDataURL(file);
      };

      const deleteAlbumPhoto = async (personId, index) => {
        if (!isAdmin) return;
        const person = people.find(p => p.id === personId);
        const next = (person?.photos || []).filter((_, i) => i !== index);
        await db.collection("people").doc(personId).update({ photos: next });
      };

      // =========================
      // Tree helpers (graph, no duplicates)
      // =========================
      const personIsChild = useMemo(() => {
        const s = new Set();
        for (const c of couples) for (const ch of (c.childrenIds || [])) s.add(ch);
        return s;
      }, [couples]);

      const rootCouples = useMemo(() => {
        // If admin selected explicit roots, use them; otherwise fallback to heuristic.
        if (Array.isArray(rootCoupleIds) && rootCoupleIds.length) {
          const setIds = new Set(rootCoupleIds);
          const chosen = couples.filter(c => setIds.has(c.id));
          return chosen.length ? chosen : couples;
        }
        const roots = couples.filter(c =>
          !personIsChild.has(c.partner1Id) && !personIsChild.has(c.partner2Id)
        );
        return roots.length ? roots : couples;
      }, [couples, personIsChild, rootCoupleIds]);

      const couplesByPerson = useMemo(() => {
        const map = new Map();
        for (const c of couples) {
          if (!map.has(c.partner1Id)) map.set(c.partner1Id, []);
          if (!map.has(c.partner2Id)) map.set(c.partner2Id, []);
          map.get(c.partner1Id).push(c);
          map.get(c.partner2Id).push(c);
        }
        return map;
      }, [couples]);

      const toggleCoupleExpanded = (coupleId) => {
        setExpandedCouples(prev => {
          const next = new Set(prev);
          next.has(coupleId) ? next.delete(coupleId) : next.add(coupleId);
          return next;
        });
      };

      const toggleAllExpanded = () => {
        if (allExpanded) {
          setExpandedCouples(new Set());
          setAllExpanded(false);
        } else {
          const allCoupleIds = new Set(couples.map(c => c.id));
          setExpandedCouples(allCoupleIds);
          setAllExpanded(true);
        }
      };

      // =========================
      // GRAPH LAYOUT (index211-like): compute generations and render each couple once
      // =========================
      const graphLevels = useMemo(() => {
        const isCoupleExpanded = (id) => expandedCouples.has(id);
        const personLevel = {};
        const coupleLevel = {};

        // init
        for (const p of people) personLevel[p.id] = 0;

        // iterative relaxation (handles multiple parents; avoids recursion depth issues)
        const maxIter = Math.max(50, (people.length + couples.length) * 2);
        for (let iter = 0; iter < maxIter; iter++) {
          let changed = false;

          for (const c of couples) {
            const l1 = personLevel[c.partner1Id] ?? 0;
            const l2 = personLevel[c.partner2Id] ?? 0;
            const cl = Math.max(l1, l2);
            if (coupleLevel[c.id] !== cl) {
              coupleLevel[c.id] = cl;
              changed = true;
            }
            const next = cl + 1;
            for (const ch of (c.childrenIds || [])) {
              const prev = personLevel[ch] ?? 0;
              if (next > prev) {
                personLevel[ch] = next;
                changed = true;
              }
            }
          }

          if (!changed) break;
        }

        const maxL = Math.max(0, ...Object.values(personLevel));
        const rows = Array.from({ length: maxL + 1 }, () => ({ couples: [], singles: [] }));

        // choose which couples to include: if roots defined -> include reachable subgraph; else include all
        const roots = (rootCouples && rootCouples.length) ? rootCouples : couples;
        const allowedCoupleIds = new Set();
        const allowedPersonIds = new Set();

        const byId = new Map(couples.map(c => [c.id, c]));
        const queue = [...roots.map(r => r.id)];
        for (const r of roots) {
          allowedCoupleIds.add(r.id);
          allowedPersonIds.add(r.partner1Id);
          allowedPersonIds.add(r.partner2Id);
        }

        while (queue.length) {
          const cid = queue.shift();
          const c = byId.get(cid);
          if (!c) continue;
          // –µ—Å–ª–∏ –ø–∞—Ä–∞ —Å–≤–µ—Ä–Ω—É—Ç–∞ ‚Äî –Ω–µ —Ç—è–Ω–µ–º –Ω–∏–∂–µ –ø–æ—Ç–æ–º–∫–æ–≤ (–∫–∞—Ä—Ç–æ—á–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è, –Ω–æ –¥–µ—Ç–∏ —Å–∫—Ä—ã—Ç—ã)
          if (!isCoupleExpanded(cid)) continue;
          for (const ch of (c.childrenIds || [])) {
            allowedPersonIds.add(ch);
            const childCouples = couplesByPerson.get(ch) || [];
            for (const cc of childCouples) {
              if (!allowedCoupleIds.has(cc.id)) {
                allowedCoupleIds.add(cc.id);
                allowedPersonIds.add(cc.partner1Id);
                allowedPersonIds.add(cc.partner2Id);
                queue.push(cc.id);
              }
            }
          }
        }

        for (const c of couples) {
          if (!allowedCoupleIds.has(c.id)) continue;
          const lvl = coupleLevel[c.id] ?? 0;
          if (!rows[lvl]) continue;
          rows[lvl].couples.push(c);
        }

        const partnered = new Set(couples.flatMap(c => [c.partner1Id, c.partner2Id]));
        for (const p of people) {
          if (!allowedPersonIds.has(p.id)) continue;
          if (partnered.has(p.id)) continue;
          const lvl = personLevel[p.id] ?? 0;
          if (!rows[lvl]) continue;
          rows[lvl].singles.push(p);
        }

        return { rows, personLevel, coupleLevel, allowedCoupleIds, allowedPersonIds };
      }, [people, couples, rootCouples, couplesByPerson, expandedCouples]);

      // coords for SVG links
      const treeWrapRef = useRef(null);
      const [linkCoords, setLinkCoords] = useState({});

      const updateLinkCoords = () => {
        const wrap = treeWrapRef.current;
        if (!wrap) return;
        const rect = wrap.getBoundingClientRect();
        const next = {};

        wrap.querySelectorAll("[data-couple-anchor]").forEach((el) => {
          const id = el.getAttribute("data-couple-anchor");
          const r = el.getBoundingClientRect();
          next["c-" + id] = { x: (r.left + r.width / 2) - rect.left, y: (r.bottom) - rect.top };
        });

        wrap.querySelectorAll("[data-person-anchor]").forEach((el) => {
          const id = el.getAttribute("data-person-anchor");
          const r = el.getBoundingClientRect();
          next["p-" + id] = { x: (r.left + r.width / 2) - rect.left, y: (r.top) - rect.top };
        });

        setLinkCoords(next);
      };

      useLayoutEffect(() => {
        if (viewMode !== "tree") return;
        updateLinkCoords();

        let ro = null;
        const wrap = treeWrapRef.current;

        const onResize = () => updateLinkCoords();
        window.addEventListener("resize", onResize);

        if (wrap && window.ResizeObserver) {
          ro = new ResizeObserver(() => updateLinkCoords());
          ro.observe(wrap);
        }
        const t = setTimeout(updateLinkCoords, 250);

        return () => {
          clearTimeout(t);
          window.removeEventListener("resize", onResize);
          if (ro) ro.disconnect();
        };
      }, [viewMode, people, couples, graphLevels]);

      // =========================
      // UI states
      // =========================
// =========================
      // UI states
      // =========================
      if (loading) {
        return (
          <div className="min-h-screen flex items-center justify-center">
            <div className="text-center">
              <div className="w-16 h-16 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
              <div className="text-lg text-slate-600">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
          </div>
        );
      }

      if (!user) {
        return (
          <div className="min-h-screen flex items-center justify-center p-4">
            <div className="bg-white rounded-2xl p-8 w-full max-w-sm shadow-2xl">
              <div className="text-center mb-6">
                <div className="w-16 h-16 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-2xl mx-auto mb-4 flex items-center justify-center text-white text-2xl font-bold shadow-lg">
                  FT
                </div>
                <div className="text-2xl font-bold text-slate-900">–†–æ–¥–æ—Å–ª–æ–≤–Ω–æ–µ –¥–µ—Ä–µ–≤–æ</div>
                <div className="text-sm text-slate-500 mt-2">–í–æ–π—Ç–∏ –∫–∞–∫ –∞–¥–º–∏–Ω –∏–ª–∏ –∫–∞–∫ –≥–æ—Å—Ç—å</div>
              </div>

              <div className="space-y-3">
                <button
                  onClick={() => setShowLogin(true)}
                  className="w-full px-4 py-3 rounded-xl bg-gradient-to-r from-indigo-600 to-purple-600 text-white hover:from-indigo-700 hover:to-purple-700 font-semibold shadow-lg transition-all"
                >
                  üîê –í—Ö–æ–¥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
                </button>

                <button
                  onClick={handleGuestLogin}
                  className="w-full px-4 py-3 rounded-xl bg-slate-200 text-slate-800 hover:bg-slate-300 font-semibold transition-all"
                >
                  üëÅÔ∏è –í–æ–π—Ç–∏ –∫–∞–∫ –≥–æ—Å—Ç—å
                </button>
              </div>

              <div className="mt-4 text-xs text-slate-500">
                –ì–æ—Å—Ç—å ‚Äî –∞–Ω–æ–Ω–∏–º–Ω—ã–π –≤—Ö–æ–¥ Firebase. –õ–æ–≥–∏–Ω–∞/–ø–∞—Ä–æ–ª—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.
              </div>
            </div>

            {showLogin && (
              <Modal onClose={() => setShowLogin(false)}>
                <div className="text-lg font-semibold mb-4">–í—Ö–æ–¥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</div>
                <div className="space-y-3">
                  <Field label="Email">
                    <input
                      className="w-full border rounded-xl px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                      type="email"
                      placeholder="admin@example.com"
                      value={email}
                      onChange={(e) => setEmail(e.target.value)}
                    />
                  </Field>
                  <Field label="–ü–∞—Ä–æ–ª—å">
                    <input
                      className="w-full border rounded-xl px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                      type="password"
                      placeholder="–ü–∞—Ä–æ–ª—å"
                      value={password}
                      onChange={(e) => setPassword(e.target.value)}
                      onKeyDown={(e) => e.key === "Enter" && handleAdminLogin()}
                    />
                  </Field>
                </div>

                <div className="mt-4 flex gap-2">
                  <button onClick={handleAdminLogin} className="flex-1 px-3 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 transition-all">
                    –í–æ–π—Ç–∏
                  </button>
                  <button onClick={() => setShowLogin(false)} className="flex-1 px-3 py-2 rounded-xl bg-slate-200 text-slate-800 hover:bg-slate-300 transition-all">
                    –û—Ç–º–µ–Ω–∞
                  </button>
                </div>
              </Modal>
            )}
          </div>
        );
      }

      return (
        <div className="min-h-screen">
          <header className="bg-white/80 backdrop-blur-lg border-b sticky top-0 z-40 shadow-sm">
            <div className="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between gap-3">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-600 to-purple-600 text-white flex items-center justify-center font-extrabold shadow-lg">
                  FT
                </div>
                <div>
                  <div className="text-xl font-semibold text-slate-900">–†–æ–¥–æ—Å–ª–æ–≤–Ω–æ–µ –¥–µ—Ä–µ–≤–æ</div>
                  <div className="text-xs text-slate-500">
                    {isAdmin ? "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä" : "–ì–æ—Å—Ç—å"} ‚Ä¢ Cloud Firestore
                  </div>
                </div>
              </div>

              <div className="flex items-center gap-2">
                <div className="hidden sm:block text-xs text-slate-600">
                  {isAdmin ? "üë§ –ê–¥–º–∏–Ω" : "üëÅÔ∏è –ì–æ—Å—Ç—å"} ‚Ä¢ {user.isAnonymous ? "–∞–Ω–æ–Ω–∏–º–Ω–æ" : (user.email || "user")}
                </div>

                {!isAdmin && (
                  <button
                    onClick={() => setShowLogin(true)}
                    className="px-3 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 transition-all shadow-sm text-sm"
                    title="–í–æ–π—Ç–∏ –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä"
                  >
                    üîê
                  </button>
                )}

                <button
                  onClick={handleLogout}
                  className="px-3 py-2 rounded-lg bg-rose-600 text-white hover:bg-rose-700 transition-all shadow-sm text-sm"
                >
                  –í—ã—Ö–æ–¥
                </button>
              </div>
            </div>
          </header>

          <main className="max-w-6xl mx-auto px-4 py-6 space-y-4">
            {isAdmin && (
              <div className="flex flex-wrap gap-2">
                <button
                  onClick={() => { setEditingPerson(null); setShowPersonForm(true); }}
                  className="px-4 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 shadow-lg transition-all font-medium text-sm"
                >
                  + –î–æ–±–∞–≤–∏—Ç—å —á–µ–ª–æ–≤–µ–∫–∞
                </button>

                <button
                  onClick={() => setShowCoupleForm(true)}
                  className="px-4 py-2 rounded-lg bg-sky-600 text-white hover:bg-sky-700 shadow-lg transition-all font-medium text-sm"
                >
                  + –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä—É
                </button>
              </div>
            )}

            <section className="bg-white border rounded-2xl p-4 shadow-lg">
              <div className="px-2 py-2 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 mb-3">
                <div className="flex-1">
                  <div className="text-lg font-semibold text-slate-900">
                    {viewMode === "tree" ? "–î–µ—Ä–µ–≤–æ" : "–°–ø–∏—Å–æ–∫ –ª—é–¥–µ–π"}
                  </div>
                  <div className="text-xs text-slate-500">
                    {viewMode === "tree" 
                      ? (isAdmin
                          ? "–ù–∞–∂–º–∏ –Ω–∞ ¬´–î–µ—Ç–∏¬ª, —á—Ç–æ–±—ã —Å–≤–µ—Ä–Ω—É—Ç—å/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –ø–æ–∫–æ–ª–µ–Ω–∏—è. ‚ù§Ô∏è/üíî ‚Äî –¥–æ–±–∞–≤–∏—Ç—å —Ä–µ–±—ë–Ω–∫–∞."
                          : "–ù–∞–∂–∏–º–∞–π ¬´–î–µ—Ç–∏¬ª, —á—Ç–æ–±—ã —Å–≤–µ—Ä–Ω—É—Ç—å/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –ø–æ–∫–æ–ª–µ–Ω–∏—è. –ö–∞—Ä—Ç–æ—á–∫–∞ ‚Üí –¥–µ—Ç–∞–ª–∏.")
                      : "–°–ø–∏—Å–æ–∫ –ª—é–¥–µ–π –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –æ—Ç —Å—Ç–∞—Ä—à–∏—Ö –∫ –º–ª–∞–¥—à–∏–º –ø–æ –≥–æ–¥—É —Ä–æ–∂–¥–µ–Ω–∏—è"}
                  </div>
                </div>

                <div className="flex flex-wrap items-center gap-2">
                  <div className="text-xs text-slate-500 bg-slate-100 px-3 py-1 rounded-full whitespace-nowrap">
                    {people.length} –ª—é–¥–µ–π ‚Ä¢ {couples.length} –ø–∞—Ä
                  </div>
                  
                  <button
                    onClick={() => setViewMode(viewMode === "tree" ? "list" : "tree")}
                    className="px-3 py-1 rounded-lg bg-indigo-100 text-indigo-700 hover:bg-indigo-200 text-xs font-medium transition-all"
                  >
                    {viewMode === "tree" ? "üìã –°–ø–∏—Å–æ–∫" : "üå≥ –î–µ—Ä–µ–≤–æ"}
                  </button>

                  {viewMode === "tree" && (
                    <>
                      {isAdmin && (
                        <button
                          onClick={() => { setRootsDraft(rootCoupleIds || []); setShowRootsModal(true); }}
                          className="px-3 py-1 rounded-lg bg-amber-100 text-amber-800 hover:bg-amber-200 text-xs font-medium transition-all"
                          title="–í—ã–±—Ä–∞—Ç—å –∫–æ—Ä–Ω–µ–≤—ã–µ –ø–∞—Ä—ã (—á—Ç–æ–±—ã —Å–≤–µ—Ä—Ö—É –Ω–µ —Å–≤—è–∑—ã–≤–∞–ª–∏—Å—å –Ω–µ—Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ –≤–µ—Ç–∫–∏)"
                        >
                          ‚öì –ö–æ—Ä–Ω–∏
                        </button>
                      )}
                      <button
                        onClick={toggleAllExpanded}
                      className="px-3 py-1 rounded-lg bg-purple-100 text-purple-700 hover:bg-purple-200 text-xs font-medium transition-all"
                    >
                      {allExpanded ? "‚ûñ –°–≤–µ—Ä–Ω—É—Ç—å –≤—Å—ë" : "‚ûï –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—Å—ë"}
                    </button>
                    </>
                  )}
                </div>
              </div>

              <div className="mb-4">
                <input
                  type="text"
                  placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ —Ñ–∞–º–∏–ª–∏–∏, –∏–º–µ–Ω–∏ –∏–ª–∏ –æ—Ç—á–µ—Å—Ç–≤—É..."
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                  className="w-full px-4 py-2 border rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm"
                />
              </div>

              {people.length === 0 ? (
                <div className="p-8 text-center text-slate-600">
                  –ü–æ–∫–∞ –ø—É—Å—Ç–æ. {isAdmin && "–î–æ–±–∞–≤—å –ª—é–¥–µ–π –∏ –ø–∞—Ä—ã."}
                </div>
              ) : viewMode === "list" ? (
                <div className="space-y-2">
                  {sortedPeopleByAge.length === 0 ? (
                    <div className="p-8 text-center text-slate-600">
                      –ù–∏–∫–æ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ –∑–∞–ø—Ä–æ—Å—É "{searchQuery}"
                    </div>
                  ) : (
                    sortedPeopleByAge.map(person => (
                      <div 
                        key={person.id}
                        onClick={() => setSelectedPersonId(person.id)}
                        className="flex items-center gap-3 p-3 border rounded-xl hover:bg-slate-50 cursor-pointer transition-all"
                      >
                        {person.mainPhoto ? (
                          <img className="w-12 h-12 rounded-full object-cover" src={person.mainPhoto} alt="–§–æ—Ç–æ" />
                        ) : (
                          <div className="w-12 h-12 rounded-full bg-gradient-to-br from-indigo-600 to-purple-600 flex items-center justify-center text-white font-bold">
                            {((person.firstName?.[0] || "?") + (person.lastName?.[0] || "")).toUpperCase()}
                          </div>
                        )}
                        
                        <div className="flex-1 min-w-0">
                          <div className="font-semibold text-slate-900">
                            {person.lastName} {person.firstName} {person.middleName}
                          </div>
                          <div className="text-xs text-slate-600">
                            {person.gender === "F" ? "‚ôÄ" : "‚ôÇ"} {yearRange(person.birthDate, person.deathDate)}
                          </div>
                        </div>
                      </div>
                    ))
                  )}
                </div>
              ) : couples.length === 0 ? (
                <div className="p-8 text-center text-slate-600">
                  –ï—Å—Ç—å –ª—é–¥–∏, –Ω–æ –Ω–µ—Ç –ø–∞—Ä. {isAdmin && "–î–æ–±–∞–≤—å –ø–∞—Ä—É, —á—Ç–æ–±—ã –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –¥–µ—Ä–µ–≤–æ."}
                </div>
              ) : (
                <div ref={treeWrapRef} className="tree py-6">
                <svg className="treeLinksSvg">
                  {couples.map(c => (c.childrenIds || []).map(childId => {
                    if (!graphLevels.allowedCoupleIds?.has(c.id)) return null;
                    if (!graphLevels.allowedPersonIds?.has(childId)) return null;
                    const start = linkCoords["c-" + c.id];
                    const end = linkCoords["p-" + childId];
                    if (!start || !end) return null;
                    const midY = (start.y + end.y) / 2;
                    return (
                      <path
                        key={c.id + "-" + childId}
                        d={`M ${start.x} ${start.y} C ${start.x} ${midY}, ${end.x} ${midY}, ${end.x} ${end.y}`}
                        stroke="#000000"
                        strokeWidth="2"
                        fill="none"
                        className="path-transition"
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        vectorEffect="non-scaling-stroke"
                      />
                    );
                  }))}
                </svg>

                <div className="w-full flex flex-col items-center gap-20 min-w-max">
                  {graphLevels.rows.map((row, idx) => (
                    <div key={idx} className="flex flex-wrap gap-14 justify-center items-start px-10">
                      {row.couples.map(cp => (
                        <div key={cp.id} className="coupleContainer" data-couple-anchor={cp.id}>
                          <div className="coupleRow">
                            {(() => { const p1 = people.find(p => p.id === cp.partner1Id) || null; return (
                              <div style={{ opacity: matchesSearch(p1) ? 1 : 0.25 }}>
                                <PersonCardMini person={p1} onClick={() => setSelectedPersonId(cp.partner1Id)} />
                              </div>
                            ); })()}
                            <div
                              className="coupleMid"
                              title={isAdmin ? "–î–æ–±–∞–≤–∏—Ç—å —Ä–µ–±—ë–Ω–∫–∞" : "–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å –¥–µ—Ä–µ–≤–æ"}
                              aria-disabled={!isAdmin}
                              onClick={() => isAdmin && openAddChild(cp.id)}
                            >
                              {cp.status === "divorced" ? "üíî" : "‚ù§Ô∏è"}
                            </div>
                            {(() => { const p2 = people.find(p => p.id === cp.partner2Id) || null; return (
                              <div style={{ opacity: matchesSearch(p2) ? 1 : 0.25 }}>
                                <PersonCardMini person={p2} onClick={() => setSelectedPersonId(cp.partner2Id)} />
                              </div>
                            ); })()}
                          </div>

                          <div className="mt-2 flex items-center justify-center gap-2">
                            {(cp.childrenIds || []).length > 0 && (
                              <button
                                className="text-xs px-2 py-1 rounded-lg bg-slate-100 hover:bg-slate-200 text-slate-700"
                                onClick={() => toggleCoupleExpanded(cp.id)}
                                title="–°–≤–µ—Ä–Ω—É—Ç—å/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –¥–µ—Ç–µ–π"
                              >
                                {expandedCouples.has(cp.id) ? "–°–≤–µ—Ä–Ω—É—Ç—å –¥–µ—Ç–µ–π ‚ñ≤" : `–î–µ—Ç–∏ (${(cp.childrenIds || []).length}) ‚ñº`}
                              </button>
                            )}

                            {isAdmin && (
                              <button
                                className="text-xs px-2 py-1 rounded-lg bg-rose-50 hover:bg-rose-100 text-rose-700 border border-rose-200"
                                onClick={() => deleteCouple(cp.id)}
                                title="–£–¥–∞–ª–∏—Ç—å –ø–∞—Ä—É"
                              >
                                –£–¥–∞–ª–∏—Ç—å
                              </button>
                            )}
                          </div>
                        </div>
                      ))}

                      {row.singles.map(p => (
                        <div key={p.id} className="mt-2" data-person-anchor={p.id}>
                          <div style={{ opacity: matchesSearch(p) ? 1 : 0.25 }}>
                            <PersonCardMini person={p} onClick={() => setSelectedPersonId(p.id)} />
                          </div>
                        </div>
                      ))}
                    </div>
                  ))}
                </div>
              </div>
              )}
            </section>

            {selectedPerson && (
              <PersonDetailModal
                person={selectedPerson}
                isAdmin={isAdmin}
                onClose={() => setSelectedPersonId(null)}
                onEdit={() => { setEditingPerson(selectedPerson); setShowPersonForm(true); setSelectedPersonId(null); }}
                onDelete={() => { const id = selectedPerson.id; setSelectedPersonId(null); deletePerson(id); }}
                couples={couples}
                people={people}
                comments={comments.filter(c => c.personId === selectedPerson.id).sort(sortByDateDesc)}
                onDeleteComment={deleteComment}
                newComment={newComment}
                setNewComment={setNewComment}
                onAddComment={addComment}
                onAddAlbumPhoto={(file) => addPhotoToAlbum(selectedPerson.id, file)}
                onDeleteAlbumPhoto={(idx) => deleteAlbumPhoto(selectedPerson.id, idx)}
              />
            )}
          </main>

          {showLogin && (
            <Modal onClose={() => setShowLogin(false)}>
              <div className="text-lg font-semibold mb-4">–í—Ö–æ–¥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</div>
              <div className="space-y-3">
                <Field label="Email">
                  <input
                    className="w-full border rounded-xl px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                    type="email"
                    placeholder="admin@example.com"
                    value={email}
                    onChange={(e) => setEmail(e.target.value)}
                  />
                </Field>
                <Field label="–ü–∞—Ä–æ–ª—å">
                  <input
                    className="w-full border rounded-xl px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                    type="password"
                    placeholder="–ü–∞—Ä–æ–ª—å"
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    onKeyDown={(e) => e.key === "Enter" && handleAdminLogin()}
                  />
                </Field>
              </div>
              <div className="mt-4 flex gap-2">
                <button onClick={handleAdminLogin} className="flex-1 px-3 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 transition-all">–í–æ–π—Ç–∏</button>
                <button onClick={() => setShowLogin(false)} className="flex-1 px-3 py-2 rounded-xl bg-slate-200 text-slate-800 hover:bg-slate-300 transition-all">–û—Ç–º–µ–Ω–∞</button>
              </div>
            </Modal>
          )}

          {showPersonForm && (
            <PersonFormModal
              person={editingPerson}
              onClose={() => { setShowPersonForm(false); setEditingPerson(null); }}
              onSave={(data) => { if (editingPerson) updatePerson(data); else addPerson(data); }}
            />
          )}

          {showCoupleForm && (
            <CoupleFormModal
              people={people}
              onClose={() => setShowCoupleForm(false)}
              onSave={(data) => addCouple(data)}
            />
          )}

          {showRootsModal && isAdmin && (
            <RootsModal
              people={people}
              couples={couples}
              draft={rootsDraft}
              setDraft={setRootsDraft}
              onClose={() => setShowRootsModal(false)}
              onSave={async () => {
                try {
                  const cleaned = Array.from(new Set((rootsDraft || []).filter(Boolean)));
                  await db.collection("settings").doc("tree").set({ rootCoupleIds: cleaned }, { merge: true });
                  setShowRootsModal(false);
                } catch (e) {
                  alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ—Ä–Ω–∏: " + (e?.message || e));
                }
              }}
            />
          )}

          {addChildModal.open && (
            <AddChildModal
              people={people}
              couple={couples.find(c => c.id === addChildModal.coupleId) || null}
              onClose={closeAddChild}
              onCreate={(childData) => createChildAndAttach(addChildModal.coupleId, childData)}
              onAttachExisting={(childId) => attachExistingChild(addChildModal.coupleId, childId)}
            />
          )}
        </div>
      );
    }

    // =========================
    // Normalizers
    // =========================
    function normalizePerson(data) {
      const mainPhoto = data.mainPhoto || "";
      const photos = Array.isArray(data.photos) ? data.photos : (mainPhoto ? [mainPhoto] : []);
      const out = {
        firstName: data.firstName || "",
        lastName: data.lastName || "",
        middleName: data.middleName || "",
        gender: data.gender || "M",
        birthDate: data.birthDate || "",
        deathDate: data.deathDate || "",
        description: data.description || "",
        biography: data.biography || "",
        mainPhoto,
        photos,
      };
      out.photos = (out.photos || []).filter(Boolean);
      if (out.mainPhoto && !out.photos.includes(out.mainPhoto)) out.photos = [out.mainPhoto, ...out.photos];
      return out;
    }

    // =========================
    // Tree Components (—É–ª—É—á—à–µ–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
    // =========================
    function TreeCoupleNode({
      couple, people, couples, couplesByPerson,
      expandedCouples,
      toggleCoupleExpanded,
      onSelectPerson, isAdmin, onOpenAddChild,
      onDeleteCouple, onDetachChild,
      depth, path, searchQuery = ""
    }) {
      return (
        <li>
          <TreeCoupleContent
            couple={couple}
            people={people}
            couples={couples}
            couplesByPerson={couplesByPerson}
            expandedCouples={expandedCouples}
            toggleCoupleExpanded={toggleCoupleExpanded}
            onSelectPerson={onSelectPerson}
            isAdmin={isAdmin}
            onOpenAddChild={onOpenAddChild}
            onDeleteCouple={onDeleteCouple}
            onDetachChild={onDetachChild}
            depth={depth}
            path={path}
            searchQuery={searchQuery}
          />
        </li>
      );
    }

    function TreeCoupleContent({
      couple, people, couples, couplesByPerson,
      expandedCouples,
      toggleCoupleExpanded,
      onSelectPerson, isAdmin, onOpenAddChild,
      onDeleteCouple, onDetachChild,
      depth, path,
      focusPersonId = null,
      searchQuery = ""
    }) {
      const p1 = people.find(p => p.id === couple.partner1Id) || null;
      const p2 = people.find(p => p.id === couple.partner2Id) || null;

      const statusIcon = couple.status === "divorced" ? "üíî" : "‚ù§Ô∏è";

      const children = (couple.childrenIds || [])
        .map(id => people.find(p => p.id === id))
        .filter(Boolean);

      // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–µ—Ç–µ–π –ø–æ –ø–æ–∏—Å–∫–æ–≤–æ–º—É –∑–∞–ø—Ä–æ—Å—É
      const filteredChildren = useMemo(() => {
        if (!searchQuery.trim()) return children;
        
        const query = searchQuery.toLowerCase().trim();
        return children.filter(child => {
          const lastName = (child.lastName || "").toLowerCase();
          const firstName = (child.firstName || "").toLowerCase();
          const middleName = (child.middleName || "").toLowerCase();
          return lastName.includes(query) || firstName.includes(query) || middleName.includes(query);
        });
      }, [children, searchQuery]);

      const isExpanded = expandedCouples.has(couple.id);

      const nextPath = new Set(path);
      if (p1?.id) nextPath.add(p1.id);
      if (p2?.id) nextPath.add(p2.id);

      // –ï—Å–ª–∏ —ç—Ç–æ –ø–∞—Ä–∞ —Ä–µ–±—ë–Ω–∫–∞ (focusPersonId –∑–∞–¥–∞–Ω), –∏—Å–ø–æ–ª—å–∑—É–µ–º —è–∫–æ—Ä–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
      const isChildCouple = focusPersonId && (p1?.id === focusPersonId || p2?.id === focusPersonId);

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –ª–∏ –ø–∞—Ä—Ç–Ω–µ—Ä—ã –ø–æ–∏—Å–∫–æ–≤–æ–º—É –∑–∞–ø—Ä–æ—Å—É
      const matchesSearch = (person) => {
        if (!searchQuery.trim()) return true;
        const query = searchQuery.toLowerCase().trim();
        const lastName = (person?.lastName || "").toLowerCase();
        const firstName = (person?.firstName || "").toLowerCase();
        const middleName = (person?.middleName || "").toLowerCase();
        return lastName.includes(query) || firstName.includes(query) || middleName.includes(query);
      };

      const p1Matches = matchesSearch(p1);
      const p2Matches = matchesSearch(p2);

      return (
        <>
          <div className="coupleContainer">
            {isChildCouple ? (
              <AnchoredCoupleRow
                child={p1?.id === focusPersonId ? p1 : p2}
                partner={p1?.id === focusPersonId ? p2 : p1}
                statusIcon={statusIcon}
                isAdmin={isAdmin}
                onAddChild={() => isAdmin && onOpenAddChild(couple.id)}
                onSelect={(id) => id && onSelectPerson(id)}
                p1Matches={p1?.id === focusPersonId ? p1Matches : p2Matches}
                p2Matches={p1?.id === focusPersonId ? p2Matches : p1Matches}
              />
            ) : (
              <div className="coupleRow">
                <div style={{ opacity: p1Matches ? 1 : 0.3 }}>
                  <PersonCardMini person={p1} onClick={() => p1 && onSelectPerson(p1.id)} />
                </div>

                <div
                  className="coupleMid"
                  title={isAdmin ? "–î–æ–±–∞–≤–∏—Ç—å —Ä–µ–±—ë–Ω–∫–∞" : "–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å –¥–µ—Ä–µ–≤–æ"}
                  aria-disabled={!isAdmin}
                  onClick={() => isAdmin && onOpenAddChild(couple.id)}
                >
                  {statusIcon}
                </div>

                <div style={{ opacity: p2Matches ? 1 : 0.3 }}>
                  <PersonCardMini person={p2} onClick={() => p2 && onSelectPerson(p2.id)} />
                </div>
              </div>
            )}

            <div className="mt-2 flex items-center justify-center gap-2">
              {children.length > 0 && (
                <button
                  className="text-xs px-2 py-1 rounded-lg bg-slate-100 hover:bg-slate-200 text-slate-700"
                  onClick={() => toggleCoupleExpanded(couple.id)}
                >
                  {isExpanded ? "–°–≤–µ—Ä–Ω—É—Ç—å –¥–µ—Ç–µ–π ‚ñ≤" : `–î–µ—Ç–∏ (${children.length}) ‚ñº`}
                </button>
              )}

              {isAdmin && (
                <button
                  className="text-xs px-2 py-1 rounded-lg bg-rose-50 hover:bg-rose-100 text-rose-700 border border-rose-200"
                  onClick={() => onDeleteCouple(couple.id)}
                  title="–£–¥–∞–ª–∏—Ç—å –ø–∞—Ä—É"
                >
                  –£–¥–∞–ª–∏—Ç—å
                </button>
              )}
            </div>
          </div>

          {filteredChildren.length > 0 && isExpanded && (
            <ul className="clearfix">
              {filteredChildren.map(ch => (
                <TreePersonNode
                  key={ch.id}
                  person={ch}
                  people={people}
                  couples={couples}
                  couplesByPerson={couplesByPerson}
                  expandedCouples={expandedCouples}
                  toggleCoupleExpanded={toggleCoupleExpanded}
                  onSelectPerson={onSelectPerson}
                  isAdmin={isAdmin}
                  onOpenAddChild={onOpenAddChild}
                  onDeleteCouple={onDeleteCouple}
                  onDetachChild={onDetachChild}
                  depth={depth + 1}
                  path={nextPath}
                  searchQuery={searchQuery}
                />
              ))}
            </ul>
          )}
        </>
      );
    }

    function TreePersonNode({
      person, people, couples, couplesByPerson,
      expandedCouples,
      toggleCoupleExpanded,
      onSelectPerson, isAdmin,
      onOpenAddChild, onDeleteCouple, onDetachChild,
      depth, path, searchQuery = ""
    }) {
      const personCouples = (couplesByPerson.get(person.id) || []);

      return (
        <li>
          {personCouples.length === 0 ? (
            <div className="flex flex-col items-center gap-2">
              <PersonCardMini person={person} onClick={() => onSelectPerson(person.id)} />
            </div>
          ) : (
            <ul className="clearfix">
              {personCouples.map((c) => (
                <li key={c.id}>
                  <TreeCoupleContent
                    couple={c}
                    people={people}
                    couples={couples}
                    couplesByPerson={couplesByPerson}
                    expandedCouples={expandedCouples}
                    toggleCoupleExpanded={toggleCoupleExpanded}
                    onSelectPerson={onSelectPerson}
                    isAdmin={isAdmin}
                    onOpenAddChild={onOpenAddChild}
                    onDeleteCouple={onDeleteCouple}
                    onDetachChild={onDetachChild}
                    depth={depth + 1}
                    path={new Set([...path, person.id])}
                    focusPersonId={person.id}
                    searchQuery={searchQuery}
                  />
                </li>
              ))}
            </ul>
          )}
        </li>
      );
    }

    function PersonCardMini({ person, onClick }) {
      if (!person) {
        return (
          <div className="personCard opacity-60 cursor-not-allowed">
            <div className="avatar">?</div>
            <div className="text-left min-w-0">
              <div className="font-semibold text-slate-900 truncate">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
              <div className="text-xs text-slate-500">‚Äî</div>
            </div>
          </div>
        );
      }

      const initials = ((person.firstName?.[0] || "?") + (person.lastName?.[0] || "")).toUpperCase();
      const genderIcon = person.gender === "F" ? "‚ôÄ" : "‚ôÇ";

      return (
        <div className="personCard" data-person-anchor={person.id} onClick={onClick} title="–û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É">
          {person.mainPhoto ? (
            <img className="avatar" src={person.mainPhoto} alt="–§–æ—Ç–æ" />
          ) : (
            <div className="avatar">{initials}</div>
          )}

          <div className="text-left min-w-0">
            <div className="font-semibold text-slate-900 truncate">
              {person.lastName || "‚Äî"} {person.firstName || "‚Äî"}
            </div>
            <div className="text-xs text-slate-500 truncate">{person.middleName || " "}</div>
            <div className="text-xs text-slate-600 flex items-center gap-2">
              <span>{genderIcon}</span>
              <span>{yearRange(person.birthDate, person.deathDate)}</span>
            </div>
          </div>
        </div>
      );
    }

    
function AnchoredCoupleRow({ child, partner, statusIcon, isAdmin, onAddChild, onSelect, p1Matches = true, p2Matches = true }) {
  const rowRef = React.useRef(null);
  const childRef = React.useRef(null);
  const [geom, setGeom] = React.useState({ w: 0, toX: 0 });

  React.useEffect(() => {
    let ro = null;

    const measure = () => {
      const rowEl = rowRef.current;
      const chEl = childRef.current;
      if (!rowEl || !chEl) return;

      const r = rowEl.getBoundingClientRect();
      const c = chEl.getBoundingClientRect();
      const w = Math.max(1, r.width);
      const toX = (c.left - r.left) + c.width / 2;
      setGeom({ w, toX });
    };

    // –ø–µ—Ä–≤–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞
    const raf = requestAnimationFrame(measure);

    // —Ä–µ–∞–≥–∏—Ä—É–µ–º –Ω–∞ —Ä–µ—Å–∞–π–∑
    if (window.ResizeObserver) {
      ro = new ResizeObserver(() => measure());
      ro.observe(rowRef.current);
    } else {
      window.addEventListener("resize", measure);
    }

    return () => {
      cancelAnimationFrame(raf);
      if (ro) ro.disconnect();
      else window.removeEventListener("resize", measure);
    };
  }, [child?.id, partner?.id]);

  const fromX = geom.w / 2;
  const h = 22;

  return (
    <div className="coupleRowAnchored" ref={rowRef}>
      <svg className="anchorOverlay" viewBox={`0 0 ${geom.w} ${h}`} preserveAspectRatio="none">
        <path
          d={`M ${fromX} 0 V ${h/2} H ${geom.toX} V ${h}`}
          fill="none"
          stroke="#000000"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
        />
      </svg>

      <div ref={childRef} style={{ opacity: p1Matches ? 1 : 0.3 }}>
        <PersonCardMini person={child} onClick={() => child && onSelect(child.id)} />
      </div>

      <div
        className="coupleMid"
        title={isAdmin ? "–î–æ–±–∞–≤–∏—Ç—å —Ä–µ–±—ë–Ω–∫–∞" : "–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å –¥–µ—Ä–µ–≤–æ"}
        aria-disabled={!isAdmin}
        onClick={() => isAdmin && onAddChild()}
      >
        {statusIcon}
      </div>

      <div style={{ opacity: p2Matches ? 1 : 0.3 }}>
        <PersonCardMini person={partner} onClick={() => partner && onSelect(partner.id)} />
      </div>
    </div>
  );
}

    // =========================
    // Modals + Forms
    // =========================
    function Modal({ children, onClose }) {
      return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 modal-overlay">
          <div className="bg-white rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-5 shadow-2xl modal-content">
            <div className="flex justify-end">
              <button onClick={onClose} className="px-3 py-1 rounded-lg bg-slate-200 hover:bg-slate-300 text-slate-800 text-sm">
                –ó–∞–∫—Ä—ã—Ç—å
              </button>
            </div>
            <div className="mt-3">{children}</div>
          </div>
        </div>
      );
    }

    function Lightbox({ src, onClose }) {
      return (
        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[60] p-4" onClick={onClose}>
          <div className="max-w-5xl w-full" onClick={(e) => e.stopPropagation()}>
            <div className="flex justify-end mb-2">
              <button onClick={onClose} className="px-3 py-2 rounded-xl bg-white/10 text-white hover:bg-white/20">
                –ó–∞–∫—Ä—ã—Ç—å
              </button>
            </div>
            <img src={src} alt="–§–æ—Ç–æ" className="w-full max-h-[85vh] object-contain rounded-2xl shadow-2xl bg-black" />
          </div>
        </div>
      );
    }

    function Field({ label, children, className = "" }) {
      return (
        <div className={className}>
          <label className="block text-sm font-medium text-slate-900 mb-1">{label}</label>
          {children}
        </div>
      );
    }

    function PersonFormModal({ person, onClose, onSave }) {
      const [form, setForm] = useState(person || {
        id: uid(),
        firstName: "",
        lastName: "",
        middleName: "",
        gender: "M",
        birthDate: "",
        deathDate: "",
        description: "",
        biography: "",
        mainPhoto: "",
        photos: []
      });

      const handleMainPhoto = (file) => {
        if (!file) return;
        const reader = new FileReader();
        reader.onloadend = () => {
          const dataUrl = String(reader.result || "");
          setForm(prev => ({
            ...prev,
            mainPhoto: dataUrl,
            photos: prev.photos?.length ? prev.photos : (dataUrl ? [dataUrl] : [])
          }));
        };
        reader.readAsDataURL(file);
      };

      const submit = () => {
        if (!safeText(form.lastName) || !safeText(form.firstName)) {
          alert("–ò–º—è –∏ —Ñ–∞–º–∏–ª–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã");
          return;
        }
        onSave(form);
      };

      return (
        <Modal onClose={onClose}>
          <div className="flex items-center justify-between gap-3 mb-3">
            <div className="text-lg font-semibold">{person ? "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —á–µ–ª–æ–≤–µ–∫–∞" : "–î–æ–±–∞–≤–∏—Ç—å —á–µ–ª–æ–≤–µ–∫–∞"}</div>
            <div className="text-xs text-slate-500">* –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è</div>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
            <Field label="–§–∞–º–∏–ª–∏—è *">
              <input className="w-full border rounded-xl px-3 py-2" value={form.lastName} onChange={(e) => setForm(prev => ({...prev, lastName: e.target.value}))} />
            </Field>
            <Field label="–ò–º—è *">
              <input className="w-full border rounded-xl px-3 py-2" value={form.firstName} onChange={(e) => setForm(prev => ({...prev, firstName: e.target.value}))} />
            </Field>
            <Field label="–û—Ç—á–µ—Å—Ç–≤–æ" className="md:col-span-2">
              <input className="w-full border rounded-xl px-3 py-2" value={form.middleName} onChange={(e) => setForm(prev => ({...prev, middleName: e.target.value}))} />
            </Field>
            <Field label="–ü–æ–ª">
              <select className="w-full border rounded-xl px-3 py-2" value={form.gender} onChange={(e) => setForm(prev => ({...prev, gender: e.target.value}))}>
                <option value="M">–ú—É–∂—Å–∫–æ–π</option>
                <option value="F">–ñ–µ–Ω—Å–∫–∏–π</option>
              </select>
            </Field>
            <Field label="–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è">
              <input type="date" className="w-full border rounded-xl px-3 py-2" value={form.birthDate} onChange={(e) => setForm(prev => ({...prev, birthDate: e.target.value}))} />
            </Field>
            <Field label="–î–∞—Ç–∞ —Å–º–µ—Ä—Ç–∏">
              <input type="date" className="w-full border rounded-xl px-3 py-2" value={form.deathDate} onChange={(e) => setForm(prev => ({...prev, deathDate: e.target.value}))} />
            </Field>

            <Field label="–ö–æ—Ä–æ—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ" className="md:col-span-2">
              <textarea rows="3" className="w-full border rounded-xl px-3 py-2" value={form.description} onChange={(e) => setForm(prev => ({...prev, description: e.target.value}))} />
            </Field>

            <Field label="–ê–≤—Ç–æ–±–∏–æ–≥—Ä–∞—Ñ–∏—è" className="md:col-span-2">
              <textarea rows="6" className="w-full border rounded-xl px-3 py-2" placeholder="–ú–æ–∂–Ω–æ –ø–∏—Å–∞—Ç—å –±–æ–ª—å—à–∏–º —Ç–µ–∫—Å—Ç–æ–º" value={form.biography} onChange={(e) => setForm(prev => ({...prev, biography: e.target.value}))} />
            </Field>

            <Field label="–ì–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ" className="md:col-span-2">
              <input type="file" accept="image/*" className="w-full border rounded-xl px-3 py-2" onChange={(e) => handleMainPhoto(e.target.files?.[0])} />
              {form.mainPhoto && (
                <img src={form.mainPhoto} className="mt-2 w-28 h-28 rounded-xl object-cover border" alt="preview" />
              )}
              <div className="text-xs text-slate-500 mt-2">
                –§–æ—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∫–∞–∫ base64 –≤ Firestore. –î–ª—è –±–æ–ª—å—à–æ–≥–æ –∞–ª—å–±–æ–º–∞ –ª—É—á—à–µ Firebase Storage.
              </div>
            </Field>
          </div>

          <div className="mt-4 flex gap-2">
            <button onClick={submit} className="flex-1 px-3 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button onClick={onClose} className="flex-1 px-3 py-2 rounded-xl bg-slate-200 text-slate-800 hover:bg-slate-300">–û—Ç–º–µ–Ω–∞</button>
          </div>
        </Modal>
      );
    }

    function CoupleFormModal({ people, onClose, onSave }) {
      const [form, setForm] = useState({ partner1Id: "", partner2Id: "", status: "married" });

      const submit = () => {
        if (!form.partner1Id || !form.partner2Id) { alert("–í—ã–±–µ—Ä–∏ –¥–≤—É—Ö –ª—é–¥–µ–π"); return; }
        if (form.partner1Id === form.partner2Id) { alert("–ù—É–∂–Ω—ã –¥–≤–∞ —Ä–∞–∑–Ω—ã—Ö —á–µ–ª–æ–≤–µ–∫–∞"); return; }
        onSave(form);
      };

      return (
        <Modal onClose={onClose}>
          <div className="text-lg font-semibold mb-3">–î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä—É</div>

          <div className="space-y-3">
            <Field label="–ü–∞—Ä—Ç–Ω—ë—Ä 1">
              <select className="w-full border rounded-xl px-3 py-2" value={form.partner1Id} onChange={(e) => setForm(prev => ({...prev, partner1Id: e.target.value}))}>
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ‚Ä¶</option>
                {people.map(p => <option key={p.id} value={p.id}>{safeName(p)}</option>)}
              </select>
            </Field>

            <Field label="–ü–∞—Ä—Ç–Ω—ë—Ä 2">
              <select className="w-full border rounded-xl px-3 py-2" value={form.partner2Id} onChange={(e) => setForm(prev => ({...prev, partner2Id: e.target.value}))}>
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ‚Ä¶</option>
                {people.map(p => <option key={p.id} value={p.id}>{safeName(p)}</option>)}
              </select>
            </Field>

            <Field label="–°—Ç–∞—Ç—É—Å">
              <select className="w-full border rounded-xl px-3 py-2" value={form.status} onChange={(e) => setForm(prev => ({...prev, status: e.target.value}))}>
                <option value="married">–ë—Ä–∞–∫ ‚ù§Ô∏è</option>
                <option value="divorced">–†–∞–∑–≤–æ–¥ üíî</option>
              </select>
            </Field>
          </div>

          <div className="mt-4 flex gap-2">
            <button onClick={submit} className="flex-1 px-3 py-2 rounded-xl bg-sky-600 text-white hover:bg-sky-700">–î–æ–±–∞–≤–∏—Ç—å</button>
            <button onClick={onClose} className="flex-1 px-3 py-2 rounded-xl bg-slate-200 text-slate-800 hover:bg-slate-300">–û—Ç–º–µ–Ω–∞</button>
          </div>
        </Modal>
      );
    }

    function AddChildModal({ people, couple, onClose, onCreate, onAttachExisting }) {
      const [mode, setMode] = useState("create");
      const [existingId, setExistingId] = useState("");

      const [child, setChild] = useState({
        firstName: "",
        lastName: "",
        middleName: "",
        gender: "M",
        birthDate: "",
        deathDate: "",
        description: "",
        biography: "",
        mainPhoto: ""
      });

      const submit = () => {
        if (!couple) { alert("–ü–∞—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"); return; }

        if (mode === "create") {
          if (!safeText(child.firstName)) { alert("–ò–º—è —Ä–µ–±—ë–Ω–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ"); return; }
          onCreate(child);
          return;
        }

        if (!existingId) { alert("–í—ã–±–µ—Ä–∏ —Ä–µ–±—ë–Ω–∫–∞"); return; }
        onAttachExisting(existingId);
      };

      return (
        <Modal onClose={onClose}>
          <div className="text-lg font-semibold mb-3">–î–æ–±–∞–≤–∏—Ç—å —Ä–µ–±—ë–Ω–∫–∞</div>

          <div className="mb-4 flex gap-2">
            <button
              className={"px-3 py-1 rounded-lg " + (mode === "create" ? "bg-indigo-600 text-white" : "bg-slate-200 text-slate-800")}
              onClick={() => setMode("create")}
            >
              –ù–æ–≤—ã–π —Ä–µ–±—ë–Ω–æ–∫
            </button>
            <button
              className={"px-3 py-1 rounded-lg " + (mode === "attach" ? "bg-indigo-600 text-white" : "bg-slate-200 text-slate-800")}
              onClick={() => setMode("attach")}
            >
              –ò–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö
            </button>
          </div>

          {mode === "create" ? (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
              <Field label="–ò–º—è *">
                <input className="w-full border rounded-xl px-3 py-2" value={child.firstName} onChange={(e) => setChild(prev => ({...prev, firstName: e.target.value}))} />
              </Field>
              <Field label="–§–∞–º–∏–ª–∏—è">
                <input className="w-full border rounded-xl px-3 py-2" value={child.lastName} onChange={(e) => setChild(prev => ({...prev, lastName: e.target.value}))} />
              </Field>

              <Field label="–û—Ç—á–µ—Å—Ç–≤–æ">
                <input className="w-full border rounded-xl px-3 py-2" value={child.middleName} onChange={(e) => setChild(prev => ({...prev, middleName: e.target.value}))} />
              </Field>

              <Field label="–ü–æ–ª">
                <select className="w-full border rounded-xl px-3 py-2" value={child.gender} onChange={(e) => setChild(prev => ({...prev, gender: e.target.value}))}>
                  <option value="M">–ú—É–∂—Å–∫–æ–π</option>
                  <option value="F">–ñ–µ–Ω—Å–∫–∏–π</option>
                </select>
              </Field>

              <Field label="–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è">
                <input type="date" className="w-full border rounded-xl px-3 py-2" value={child.birthDate} onChange={(e) => setChild(prev => ({...prev, birthDate: e.target.value}))} />
              </Field>

              <Field label="–û–ø–∏—Å–∞–Ω–∏–µ" className="md:col-span-2">
                <textarea rows="2" className="w-full border rounded-xl px-3 py-2" value={child.description} onChange={(e) => setChild(prev => ({...prev, description: e.target.value}))} />
              </Field>

              <Field label="–ê–≤—Ç–æ–±–∏–æ–≥—Ä–∞—Ñ–∏—è" className="md:col-span-2">
                <textarea rows="5" className="w-full border rounded-xl px-3 py-2" value={child.biography} onChange={(e) => setChild(prev => ({...prev, biography: e.target.value}))} />
              </Field>
            </div>
          ) : (
            <Field label="–í—ã–±–µ—Ä–∏ —Ä–µ–±—ë–Ω–∫–∞">
              <select className="w-full border rounded-xl px-3 py-2" value={existingId} onChange={(e) => setExistingId(e.target.value)}>
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ‚Ä¶</option>
                {people.map(p => (
                  <option key={p.id} value={p.id}>{safeName(p)}</option>
                ))}
              </select>
              <div className="text-xs text-slate-500 mt-2">
                –ú–æ–∂–Ω–æ –ø—Ä–∏–≤—è–∑–∞—Ç—å –ª—é–±–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞ –∫–∞–∫ —Ä–µ–±—ë–Ω–∫–∞ —ç—Ç–æ–π –ø–∞—Ä—ã.
              </div>
            </Field>
          )}

          <div className="mt-4 flex gap-2">
            <button onClick={submit} className="flex-1 px-3 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700">–î–æ–±–∞–≤–∏—Ç—å</button>
            <button onClick={onClose} className="flex-1 px-3 py-2 rounded-xl bg-slate-200 text-slate-800 hover:bg-slate-300">–û—Ç–º–µ–Ω–∞</button>
          </div>
        </Modal>
      );
    }

    function PersonDetailModal({
      person, isAdmin, onClose, onEdit, onDelete,
      couples, people, comments,
      onDeleteComment,
      newComment, setNewComment, onAddComment,
      onAddAlbumPhoto, onDeleteAlbumPhoto
    }) {
      const [lightboxSrc, setLightboxSrc] = useState("");

      const personCouples = couples.filter(c => c.partner1Id === person.id || c.partner2Id === person.id);

      return (
        <>
          <Modal onClose={onClose}>
            <div className="flex items-start justify-between gap-4 mb-4">
              <div>
                <div className="text-2xl font-bold text-slate-900">{person.lastName} {person.firstName}</div>
                <div className="text-sm text-slate-600">{person.middleName || ""}</div>
                <div className="text-xs text-slate-500 mt-1">
                  {person.gender === "F" ? "‚ôÄ –ñ–µ–Ω—â–∏–Ω–∞" : "‚ôÇ –ú—É–∂—á–∏–Ω–∞"} ‚Ä¢ {yearRange(person.birthDate, person.deathDate)}
                </div>
              </div>

              {isAdmin && (
                <div className="flex gap-2">
                  <button onClick={onEdit} className="px-3 py-2 rounded-xl bg-sky-600 text-white text-sm hover:bg-sky-700">
                    –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                  </button>
                  <button onClick={onDelete} className="px-3 py-2 rounded-xl bg-rose-600 text-white text-sm hover:bg-rose-700">
                    –£–¥–∞–ª–∏—Ç—å
                  </button>
                </div>
              )}
            </div>

            {person.mainPhoto && (
              <img
                src={person.mainPhoto}
                className="w-full h-52 object-cover rounded-2xl mb-4 border cursor-zoom-in"
                alt="–§–æ—Ç–æ"
                onClick={() => setLightboxSrc(person.mainPhoto)}
                title="–û—Ç–∫—Ä—ã—Ç—å –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω"
              />
            )}

            <div className="space-y-4 max-h-[60vh] overflow-y-auto pr-1">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                {person.birthDate && (
                  <div className="text-sm bg-slate-50 border rounded-2xl p-3">
                    <div className="font-semibold text-slate-900">–†–æ–∂–¥–µ–Ω–∏–µ</div>
                    <div className="text-slate-600 mt-1">{new Date(person.birthDate).toLocaleDateString("ru-RU")}</div>
                  </div>
                )}
                {person.deathDate && (
                  <div className="text-sm bg-slate-50 border rounded-2xl p-3">
                    <div className="font-semibold text-slate-900">–°–º–µ—Ä—Ç—å</div>
                    <div className="text-slate-600 mt-1">{new Date(person.deathDate).toLocaleDateString("ru-RU")}</div>
                  </div>
                )}
              </div>

              {person.description && (
                <div className="text-sm bg-slate-50 border rounded-2xl p-3">
                  <div className="font-semibold text-slate-900">–û–ø–∏—Å–∞–Ω–∏–µ</div>
                  <p className="text-slate-600 mt-1 whitespace-pre-wrap">{person.description}</p>
                </div>
              )}

              {person.biography && (
                <div className="text-sm bg-slate-50 border rounded-2xl p-3">
                  <div className="font-semibold text-slate-900">–ê–≤—Ç–æ–±–∏–æ–≥—Ä–∞—Ñ–∏—è</div>
                  <p className="text-slate-700 mt-1 whitespace-pre-wrap leading-relaxed">{person.biography}</p>
                </div>
              )}

              {personCouples.length > 0 && (
                <div className="text-sm bg-slate-50 border rounded-2xl p-3">
                  <div className="font-semibold text-slate-900">–ü–∞—Ä—Ç–Ω—ë—Ä—ã</div>
                  <ul className="mt-2 space-y-1">
                    {personCouples.map(c => {
                      const partner = c.partner1Id === person.id
                        ? people.find(p => p.id === c.partner2Id)
                        : people.find(p => p.id === c.partner1Id);

                      return (
                        <li key={c.id} className="text-slate-700 flex items-center justify-between">
                          <span>{partner ? safeName(partner) : "?"} {c.status === "divorced" ? "üíî" : "‚ù§Ô∏è"}</span>
                        </li>
                      );
                    })}
                  </ul>
                </div>
              )}

              {(person.photos || []).length > 0 && (
                <div className="text-sm bg-slate-50 border rounded-2xl p-3">
                  <div className="font-semibold text-slate-900">–ê–ª—å–±–æ–º</div>
                  <div className="grid grid-cols-2 sm:grid-cols-3 gap-2 mt-3">
                    {(person.photos || []).map((photo, idx) => (
                      <div key={idx} className="relative group">
                        <img
                          src={photo}
                          className="w-full h-32 object-cover rounded-xl border bg-white cursor-zoom-in"
                          alt={"Photo " + (idx + 1)}
                          onClick={() => setLightboxSrc(photo)}
                          title="–û—Ç–∫—Ä—ã—Ç—å –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω"
                        />
                        {isAdmin && (
                          <button
                            onClick={() => onDeleteAlbumPhoto(idx)}
                            className="absolute top-2 right-2 bg-rose-600 text-white rounded-lg px-2 py-1 text-xs opacity-0 group-hover:opacity-100 transition"
                            title="–£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ"
                          >
                            ‚úï
                          </button>
                        )}
                      </div>
                    ))}
                  </div>
                  <div className="text-xs text-slate-500 mt-2">–ù–∞–∂–º–∏ –Ω–∞ —Ñ–æ—Ç–æ ‚Äî –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω.</div>
                </div>
              )}

              {isAdmin && (
                <div className="text-sm bg-slate-50 border rounded-2xl p-3">
                  <div className="font-semibold text-slate-900 mb-2">–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ –≤ –∞–ª—å–±–æ–º</div>
                  <input type="file" accept="image/*" className="w-full border rounded-xl px-3 py-2 bg-white" onChange={(e) => onAddAlbumPhoto(e.target.files?.[0])} />
                </div>
              )}

              <div className="border-t pt-4">
                <div className="font-semibold text-slate-900 mb-2">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ ({comments.length})</div>

                <div className="space-y-2 mb-3">
                  {comments.map(c => (
                    <div key={c.id} className="bg-slate-100 rounded-2xl p-3 text-sm border">
                      <div className="flex items-center justify-between gap-2 mb-1">
                        <span className="font-semibold text-slate-900">{c.author || "‚Äî"}</span>
                        {isAdmin && (
                          <button onClick={() => onDeleteComment(c.id)} className="text-rose-600 hover:text-rose-700 text-xs" title="–£–¥–∞–ª–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π">
                            ‚úï
                          </button>
                        )}
                      </div>
                      <div className="text-slate-700 whitespace-pre-wrap">{c.text}</div>
                      <div className="text-xs text-slate-500 mt-2">
                        {c.date ? new Date(c.date).toLocaleString("ru-RU", { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" }) : ""}
                      </div>
                    </div>
                  ))}
                </div>

                <div className="flex gap-2">
                  <input
                    type="text"
                    className="flex-1 border rounded-xl px-3 py-2 text-sm bg-white"
                    placeholder="–ù–∞–ø–∏—Å–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π‚Ä¶"
                    value={newComment}
                    onChange={(e) => setNewComment(e.target.value)}
                    onKeyDown={(e) => e.key === "Enter" && onAddComment()}
                  />
                  <button onClick={onAddComment} className="px-3 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 text-sm">
                    –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                  </button>
                </div>
              </div>
            </div>
          </Modal>

          {lightboxSrc && <Lightbox src={lightboxSrc} onClose={() => setLightboxSrc("")} />}
        </>
      );
    }


    function RootsModal({ people, couples, draft, setDraft, onClose, onSave }) {
      const nameOf = (id) => {
        const p = people.find(x => x.id === id);
        return p ? safeName(p) : "‚Äî";
      };

      const toggle = (coupleId) => {
        setDraft(prev => {
          const s = new Set(prev || []);
          s.has(coupleId) ? s.delete(coupleId) : s.add(coupleId);
          return Array.from(s);
        });
      };

      return (
        <Modal onClose={onClose}>
          <div className="text-lg font-semibold mb-2">–ö–æ—Ä–Ω–µ–≤—ã–µ –ø–∞—Ä—ã</div>
          <div className="text-sm text-slate-600 mb-4">
            –í—ã–±–µ—Ä–∏ –ø–∞—Ä—ã, —Å –∫–æ—Ç–æ—Ä—ã—Ö –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –¥–µ—Ä–µ–≤–æ. –≠—Ç–æ —É–±–∏—Ä–∞–µ—Ç ¬´—Å–≤—è–∑–∏¬ª –º–µ–∂–¥—É –Ω–µ—Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –≤–µ—Ä—Ö–Ω–∏–º–∏ –≤–µ—Ç–∫–∞–º–∏.
          </div>

          <div className="space-y-2 max-h-[55vh] overflow-y-auto pr-1">
            {couples.length === 0 ? (
              <div className="text-slate-600">–ü–æ–∫–∞ –Ω–µ—Ç –ø–∞—Ä.</div>
            ) : (
              couples.map(c => {
                const checked = (draft || []).includes(c.id);
                return (
                  <label key={c.id} className="flex items-start gap-3 p-3 border rounded-xl hover:bg-slate-50 cursor-pointer">
                    <input
                      type="checkbox"
                      className="mt-1"
                      checked={checked}
                      onChange={() => toggle(c.id)}
                    />
                    <div className="min-w-0">
                      <div className="font-semibold text-slate-900">
                        {nameOf(c.partner1Id)} {c.status === "divorced" ? "üíî" : "‚ù§Ô∏è"} {nameOf(c.partner2Id)}
                      </div>
                      <div className="text-xs text-slate-600">
                        –î–µ—Ç–∏: {(c.childrenIds || []).length}
                      </div>
                    </div>
                  </label>
                );
              })
            )}
          </div>

          <div className="mt-4 flex gap-2">
            <button onClick={onSave} className="flex-1 px-3 py-2 rounded-xl bg-amber-600 text-white hover:bg-amber-700">
              –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ—Ä–Ω–∏
            </button>
            <button onClick={onClose} className="flex-1 px-3 py-2 rounded-xl bg-slate-200 text-slate-800 hover:bg-slate-300">
              –û—Ç–º–µ–Ω–∞
            </button>
          </div>

          <div className="text-xs text-slate-500 mt-3">
            –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞—Ç—å, –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω —Ç–µ–∫—É—â–∏–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–ª–≥–æ—Ä–∏—Ç–º.
          </div>
        </Modal>
      );
    }


        // render
    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
