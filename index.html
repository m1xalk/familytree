<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–†–æ–¥–æ—Å–ª–æ–≤–Ω–æ–µ –¥–µ—Ä–µ–≤–æ</title>

  <!-- React (UMD) + Babel –¥–ª—è GitHub Pages -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –¥–µ—Ä–µ–≤–æ —Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑ —Å –ª–∏–Ω–∏—è–º–∏ (ul/li —Ç—Ä—é–∫) */
    .tree { padding: 12px; overflow: auto; }
    .tree ul { padding-top: 24px; position: relative; }
    .tree li {
      float: left;
      text-align: center;
      list-style: none;
      position: relative;
      padding: 24px 10px 0 10px;
      min-width: 220px;
    }

    /* –ª–∏–Ω–∏–∏ –º–µ–∂–¥—É —Å–æ—Å–µ–¥–Ω–∏–º–∏ —É–∑–ª–∞–º–∏ */
    .tree li::before,
    .tree li::after {
      content: "";
      position: absolute;
      top: 0;
      right: 50%;
      border-top: 2px solid #cbd5e1;
      width: 50%;
      height: 24px;
    }
    .tree li::after {
      right: auto;
      left: 50%;
      border-left: 2px solid #cbd5e1;
    }

    /* –æ–¥–∏–Ω–æ—á–Ω—ã–π —Ä–µ–±–µ–Ω–æ–∫ */
    .tree li:only-child::before,
    .tree li:only-child::after { display: none; }
    .tree li:only-child { padding-top: 0; }

    /* –∫—Ä–∞–π–Ω–∏–µ –¥–µ—Ç–∏ */
    .tree li:first-child::before { border: 0 none; }
    .tree li:last-child::after { border: 0 none; }
    .tree li:last-child::before { border-right: 2px solid #cbd5e1; border-radius: 0 10px 0 0; }
    .tree li:first-child::after { border-radius: 10px 0 0 0; }

    /* –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è –≤–Ω–∏–∑ –∫ –¥–µ—Ç—è–º */
    .tree ul ul::before {
      content: "";
      position: absolute;
      top: 0;
      left: 50%;
      border-left: 2px solid #cbd5e1;
      width: 0;
      height: 24px;
    }

    /* –∫–∞—Ä—Ç–æ—á–∫–∞ —á–µ–ª–æ–≤–µ–∫–∞ */
    .personCard {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border: 1px solid #e2e8f0;
      border-radius: 16px;
      background: #fff;
      box-shadow: 0 8px 22px rgba(15,23,42,.06);
      max-width: 280px;
      cursor: pointer;
      user-select: none;
    }
    .personCard:hover { box-shadow: 0 12px 28px rgba(15,23,42,.10); }

    .avatar {
      width: 44px;
      height: 44px;
      border-radius: 999px;
      object-fit: cover;
      background: #e0e7ff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      color: #3730a3;
      flex: 0 0 auto;
      overflow: hidden;
    }

    /* –ø–∞—Ä–∞ (–¥–≤–∞ —á–µ–ª–æ–≤–µ–∫–∞ + —Å–µ—Ä–¥–µ—á–∫–æ/—Ä–∞–∑–≤–æ–¥ –≤ —Ü–µ–Ω—Ç—Ä–µ) */
    .coupleRow {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      position: relative;
    }
    .coupleMid {
      width: 36px;
      height: 36px;
      border-radius: 999px;
      border: 1px solid #e2e8f0;
      background: #fff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      box-shadow: 0 6px 16px rgba(15,23,42,.08);
      cursor: pointer;
      user-select: none;
    }
    .coupleMid[aria-disabled="true"] { cursor: default; opacity: .65; }

    /* –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è "—É–∑–ª–∞ —Å–µ–º—å–∏" –≤–Ω–∏–∑ */
    .coupleDownLine {
      position: relative;
      display: inline-block;
    }
    .coupleDownLine::after {
      content: "";
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: -16px;
      height: 16px;
      border-left: 2px solid #cbd5e1;
    }

    .clearfix::after { content: ""; display: table; clear: both; }
  </style>
</head>

<body class="bg-slate-50">
  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useState } = React;

    // =========================
    // utils
    // =========================
    const uid = () => String(Date.now()) + "_" + Math.floor(Math.random() * 100000);

    const yearRange = (birthDate, deathDate) => {
      const y = (d) => d ? new Date(d).getFullYear() : "";
      const b = y(birthDate);
      const dd = y(deathDate);
      if (!b && !dd) return "‚Äî";
      if (b && !dd) return String(b);
      if (b && dd) return `${b}‚Äì${dd}`;
      return `‚Äî‚Äì${dd}`;
    };

    const safeName = (p) => {
      const ln = (p?.lastName || "").trim();
      const fn = (p?.firstName || "").trim();
      return (ln + " " + fn).trim() || "–ë–µ–∑ –∏–º–µ–Ω–∏";
    };

    // =========================
    // App
    // =========================
    function App() {
      // "–∑–∞—â–∏—Ç–∞" ‚Äî —Ç–æ–ª—å–∫–æ UI. –ù–∞ GitHub Pages —ç—Ç–æ –Ω–µ –Ω–∞—Å—Ç–æ—è—â–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å.
      const [isAdmin, setIsAdmin] = useState(false);
      const [showLogin, setShowLogin] = useState(false);
      const [password, setPassword] = useState("");

      // data
      const [people, setPeople] = useState([]);
      // couples: { id, partner1Id, partner2Id, status: 'married'|'divorced', childrenIds: [] }
      const [couples, setCouples] = useState([]);
      // comments: { id, personId, author, text, date }
      const [comments, setComments] = useState([]);

      // UI state
      const [selectedPersonId, setSelectedPersonId] = useState(null);
      const selectedPerson = useMemo(() => people.find(p => p.id === selectedPersonId) || null, [people, selectedPersonId]);

      const [expanded, setExpanded] = useState(new Set());
      const [showPersonForm, setShowPersonForm] = useState(false);
      const [editingPerson, setEditingPerson] = useState(null);

      const [showCoupleForm, setShowCoupleForm] = useState(false);

      const [addChildModal, setAddChildModal] = useState({ open: false, coupleId: null });
      const [newComment, setNewComment] = useState("");

      // -------------------------
      // storage
      // -------------------------
      useEffect(() => {
        const sp = localStorage.getItem("ft_people");
        const sc = localStorage.getItem("ft_couples");
        const scom = localStorage.getItem("ft_comments");
        if (sp) setPeople(JSON.parse(sp));
        if (sc) setCouples(JSON.parse(sc));
        if (scom) setComments(JSON.parse(scom));
      }, []);

      useEffect(() => localStorage.setItem("ft_people", JSON.stringify(people)), [people]);
      useEffect(() => localStorage.setItem("ft_couples", JSON.stringify(couples)), [couples]);
      useEffect(() => localStorage.setItem("ft_comments", JSON.stringify(comments)), [comments]);

      // -------------------------
      // auth
      // -------------------------
      const handleLogin = () => {
        if (password === "admin123") {
          setIsAdmin(true);
          setShowLogin(false);
          setPassword("");
        } else {
          alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å");
        }
      };

      const handleLogout = () => setIsAdmin(false);

      // -------------------------
      // CRUD people
      // -------------------------
      const addPerson = (data) => {
        const p = {
          id: uid(),
          firstName: data.firstName || "",
          lastName: data.lastName || "",
          middleName: data.middleName || "",
          gender: data.gender || "M",
          birthDate: data.birthDate || "",
          deathDate: data.deathDate || "",
          description: data.description || "",
          mainPhoto: data.mainPhoto || "",
          photos: data.mainPhoto ? [data.mainPhoto] : [],
        };
        setPeople(prev => [...prev, p]);
        setShowPersonForm(false);
      };

      const updatePerson = (data) => {
        setPeople(prev => prev.map(p => p.id === data.id ? data : p));
        setEditingPerson(null);
        setShowPersonForm(false);
        setSelectedPersonId(data.id);
      };

      const deletePerson = (personId) => {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å —á–µ–ª–æ–≤–µ–∫–∞? –°–≤—è–∑–∏, –¥–µ—Ç–∏ –≤ –ø–∞—Ä–∞—Ö –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –±—É–¥—É—Ç –æ—á–∏—â–µ–Ω—ã.")) return;

        // 1) —É–¥–∞–ª—è–µ–º —á–µ–ª–æ–≤–µ–∫–∞
        setPeople(prev => prev.filter(p => p.id !== personId));

        // 2) —á–∏—Å—Ç–∏–º –ø–∞—Ä—ã:
        // - –µ—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –ø–∞—Ä—Ç–Ω—ë—Ä -> —É–¥–∞–ª—è–µ–º –ø–∞—Ä—É
        // - –µ—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ —Ä–µ–±—ë–Ω–æ–∫ -> –≤—ã–∫–∏–¥—ã–≤–∞–µ–º –∏–∑ childrenIds
        setCouples(prev => prev
          .filter(c => c.partner1Id !== personId && c.partner2Id !== personId)
          .map(c => ({ ...c, childrenIds: (c.childrenIds || []).filter(id => id !== personId) }))
        );

        // 3) —É–¥–∞–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
        setComments(prev => prev.filter(c => c.personId !== personId));

        if (selectedPersonId === personId) setSelectedPersonId(null);
      };

      // -------------------------
      // CRUD couples
      // -------------------------
      const addCouple = (data) => {
        const c = {
          id: uid(),
          partner1Id: data.partner1Id,
          partner2Id: data.partner2Id,
          status: data.status,
          childrenIds: [],
        };
        setCouples(prev => [...prev, c]);
        setShowCoupleForm(false);

        // —Ä–∞—Å–∫—Ä—ã—Ç—å –æ–±–æ–∏—Ö –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤
        setExpanded(prev => new Set([...prev, data.partner1Id, data.partner2Id, c.id]));
      };

      const deleteCouple = (coupleId) => {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å –ø–∞—Ä—É? –î–µ—Ç–∏ –æ—Å—Ç–∞–Ω—É—Ç—Å—è –∫–∞–∫ –ª—é–¥–∏, –Ω–æ —Å–≤—è–∑—å —ç—Ç–æ–π –ø–∞—Ä—ã –∏—Å—á–µ–∑–Ω–µ—Ç.")) return;
        setCouples(prev => prev.filter(c => c.id !== coupleId));
      };

      const updateCoupleChildren = (coupleId, updater) => {
        setCouples(prev => prev.map(c => c.id === coupleId ? updater(c) : c));
      };

      // -------------------------
      // comments
      // -------------------------
      const addComment = () => {
        if (!selectedPerson) return;
        const text = (newComment || "").trim();
        if (!text) return;

        setComments(prev => [...prev, {
          id: uid(),
          personId: selectedPerson.id,
          author: isAdmin ? "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä" : "–ì–æ—Å—Ç—å",
          text,
          date: new Date().toISOString(),
        }]);

        setNewComment("");
      };

      const deleteComment = (commentId) => {
        setComments(prev => prev.filter(c => c.id !== commentId));
      };

      // -------------------------
      // photos
      // -------------------------
      const addPhotoToAlbum = (personId, file) => {
        if (!file) return;
        const reader = new FileReader();
        reader.onloadend = () => {
          const dataUrl = String(reader.result || "");
          setPeople(prev => prev.map(p => {
            if (p.id !== personId) return p;
            const nextPhotos = [...(p.photos || []), dataUrl];
            return { ...p, photos: nextPhotos };
          }));
          // –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç ‚Äî –æ–±–Ω–æ–≤–∏–º selected
          setSelectedPersonId(prevId => prevId);
        };
        reader.readAsDataURL(file);
      };

      const deleteAlbumPhoto = (personId, index) => {
        setPeople(prev => prev.map(p => {
          if (p.id !== personId) return p;
          const next = (p.photos || []).filter((_, i) => i !== index);
          return { ...p, photos: next };
        }));
      };

      // -------------------------
      // tree helpers
      // -------------------------
      const personIsChild = useMemo(() => {
        const s = new Set();
        for (const c of couples) for (const ch of (c.childrenIds || [])) s.add(ch);
        return s;
      }, [couples]);

      const rootCouples = useMemo(() => {
        // "–∫–æ—Ä–Ω–µ–≤–∞—è –ø–∞—Ä–∞" ‚Äî –∫–æ–≥–¥–∞ –æ–±–∞ –ø–∞—Ä—Ç–Ω—ë—Ä–∞ –Ω–µ —è–≤–ª—è—é—Ç—Å—è —á—å–∏–º–∏-—Ç–æ –¥–µ—Ç—å–º–∏.
        const roots = couples.filter(c =>
          !personIsChild.has(c.partner1Id) && !personIsChild.has(c.partner2Id)
        );
        return roots.length ? roots : couples;
      }, [couples, personIsChild]);

      const couplesByPerson = useMemo(() => {
        const map = new Map();
        for (const c of couples) {
          if (!map.has(c.partner1Id)) map.set(c.partner1Id, []);
          if (!map.has(c.partner2Id)) map.set(c.partner2Id, []);
          map.get(c.partner1Id).push(c);
          map.get(c.partner2Id).push(c);
        }
        return map;
      }, [couples]);

      const toggleExpanded = (key) => {
        setExpanded(prev => {
          const next = new Set(prev);
          next.has(key) ? next.delete(key) : next.add(key);
          return next;
        });
      };

      // -------------------------
      // add child workflow
      // -------------------------
      const openAddChild = (coupleId) => {
        if (!isAdmin) return;
        setAddChildModal({ open: true, coupleId });
      };

      const closeAddChild = () => setAddChildModal({ open: false, coupleId: null });

      const createChildAndAttach = (coupleId, childData) => {
        const child = {
          id: uid(),
          firstName: childData.firstName || "–ù–æ–≤—ã–π",
          lastName: childData.lastName || "",
          middleName: childData.middleName || "",
          gender: childData.gender || "M",
          birthDate: childData.birthDate || "",
          deathDate: childData.deathDate || "",
          description: childData.description || "",
          mainPhoto: childData.mainPhoto || "",
          photos: childData.mainPhoto ? [childData.mainPhoto] : [],
        };

        setPeople(prev => [...prev, child]);
        updateCoupleChildren(coupleId, (c) => ({
          ...c,
          childrenIds: [...new Set([...(c.childrenIds || []), child.id])]
        }));

        setExpanded(prev => new Set([...prev, coupleId]));
        closeAddChild();
      };

      const attachExistingChild = (coupleId, childId) => {
        updateCoupleChildren(coupleId, (c) => ({
          ...c,
          childrenIds: [...new Set([...(c.childrenIds || []), childId])]
        }));
        setExpanded(prev => new Set([...prev, coupleId]));
        closeAddChild();
      };

      // -------------------------
      // UI
      // -------------------------
      return (
        <div className="min-h-screen">
          <header className="bg-white border-b">
            <div className="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between gap-3">
              <div className="flex items-center gap-3">
                <div className="w-9 h-9 rounded-xl bg-indigo-600 text-white flex items-center justify-center font-extrabold">FT</div>
                <div>
                  <div className="text-xl font-semibold text-slate-900">–†–æ–¥–æ—Å–ª–æ–≤–Ω–æ–µ –¥–µ—Ä–µ–≤–æ</div>
                  <div className="text-xs text-slate-500">GitHub Pages ‚Ä¢ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage</div>
                </div>
              </div>

              <div className="flex items-center gap-2">
                {isAdmin ? (
                  <>
                    <span className="text-sm text-slate-600">–ê–¥–º–∏–Ω</span>
                    <button
                      onClick={handleLogout}
                      className="px-3 py-2 rounded-lg bg-rose-600 text-white hover:bg-rose-700"
                    >
                      –í—ã–π—Ç–∏
                    </button>
                  </>
                ) : (
                  <button
                    onClick={() => setShowLogin(true)}
                    className="px-3 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700"
                  >
                    –í–æ–π—Ç–∏ –∫–∞–∫ –∞–¥–º–∏–Ω
                  </button>
                )}
              </div>
            </div>
          </header>

          <main className="max-w-6xl mx-auto px-4 py-6 space-y-4">
            {isAdmin && (
              <div className="flex flex-wrap gap-2">
                <button
                  onClick={() => { setEditingPerson(null); setShowPersonForm(true); }}
                  className="px-3 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700"
                >
                  + –î–æ–±–∞–≤–∏—Ç—å —á–µ–ª–æ–≤–µ–∫–∞
                </button>

                <button
                  onClick={() => setShowCoupleForm(true)}
                  className="px-3 py-2 rounded-lg bg-sky-600 text-white hover:bg-sky-700"
                >
                  + –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä—É
                </button>

                <button
                  onClick={() => {
                    if (!confirm("–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ (—Ç–æ–ª—å–∫–æ –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ)?")) return;
                    localStorage.removeItem("ft_people");
                    localStorage.removeItem("ft_couples");
                    localStorage.removeItem("ft_comments");
                    setPeople([]);
                    setCouples([]);
                    setComments([]);
                    setSelectedPersonId(null);
                    setExpanded(new Set());
                  }}
                  className="px-3 py-2 rounded-lg bg-slate-700 text-white hover:bg-slate-800"
                >
                  –°–±—Ä–æ—Å–∏—Ç—å localStorage
                </button>

                <div className="text-xs text-slate-500 flex items-center">
                  –ü–∞—Ä–æ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: <span className="font-semibold ml-1">admin123</span>
                </div>
              </div>
            )}

            <section className="bg-white border rounded-2xl p-3">
              <div className="px-2 py-2 flex items-start justify-between gap-3">
                <div>
                  <div className="text-lg font-semibold text-slate-900">–î–µ—Ä–µ–≤–æ —Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑</div>
                  <div className="text-xs text-slate-500">
                    –°–µ—Ä–¥—Ü–µ/üíî ‚Äî —É–∑–µ–ª –ø–∞—Ä—ã. –î–ª—è –∞–¥–º–∏–Ω–∞: –∫–ª–∏–∫ –ø–æ –Ω–µ–º—É ‚Üí –¥–æ–±–∞–≤–∏—Ç—å —Ä–µ–±—ë–Ω–∫–∞ —ç—Ç–æ–π –ø–∞—Ä—ã.
                  </div>
                </div>
                <div className="text-xs text-slate-500">
                  {people.length} –ª—é–¥–µ–π ‚Ä¢ {couples.length} –ø–∞—Ä
                </div>
              </div>

              {people.length === 0 ? (
                <div className="p-6 text-slate-600">
                  –ü–æ–∫–∞ –ø—É—Å—Ç–æ. –ó–∞–π–¥–∏ –∫–∞–∫ –∞–¥–º–∏–Ω –∏ –¥–æ–±–∞–≤—å –ª—é–¥–µ–π/–ø–∞—Ä—ã.
                </div>
              ) : couples.length === 0 ? (
                <div className="p-6 text-slate-600">
                  –ï—Å—Ç—å –ª—é–¥–∏, –Ω–æ –Ω–µ—Ç –ø–∞—Ä. –î–æ–±–∞–≤—å –ø–∞—Ä—É, —á—Ç–æ–±—ã –¥–µ—Ä–µ–≤–æ —Å—Ç—Ä–æ–∏–ª–æ—Å—å –∫–∞–∫ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–µ.
                </div>
              ) : (
                <div className="tree">
                  <ul className="clearfix">
                    {rootCouples.map(c => (
                      <TreeCoupleNode
                        key={c.id}
                        couple={c}
                        people={people}
                        couplesByPerson={couplesByPerson}
                        expanded={expanded}
                        toggleExpanded={toggleExpanded}
                        onSelectPerson={(id) => setSelectedPersonId(id)}
                        isAdmin={isAdmin}
                        onOpenAddChild={() => openAddChild(c.id)}
                      />
                    ))}
                  </ul>
                </div>
              )}
            </section>

            {/* –î–µ—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ —Å–ø—Ä–∞–≤–∞/–≤ –º–æ–¥–∞–ª–∫–µ ‚Äî –∑–¥–µ—Å—å –º–æ–¥–∞–ª–∫–∞ */}
            {selectedPerson && (
              <PersonDetailModal
                person={selectedPerson}
                isAdmin={isAdmin}
                onClose={() => setSelectedPersonId(null)}
                onEdit={() => { setEditingPerson(selectedPerson); setShowPersonForm(true); setSelectedPersonId(null); }}
                onDelete={() => { const id = selectedPerson.id; setSelectedPersonId(null); deletePerson(id); }}
                couples={couples}
                people={people}
                comments={comments.filter(c => c.personId === selectedPerson.id)}
                onDeleteComment={deleteComment}
                newComment={newComment}
                setNewComment={setNewComment}
                onAddComment={addComment}
                onAddAlbumPhoto={(file) => addPhotoToAlbum(selectedPerson.id, file)}
                onDeleteAlbumPhoto={(idx) => deleteAlbumPhoto(selectedPerson.id, idx)}
              />
            )}
          </main>

          {/* login modal */}
          {showLogin && (
            <Modal onClose={() => setShowLogin(false)}>
              <div className="text-lg font-semibold mb-3">–í—Ö–æ–¥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</div>
              <input
                className="w-full border rounded-xl px-3 py-2"
                type="password"
                placeholder="–ü–∞—Ä–æ–ª—å"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                onKeyDown={(e) => e.key === "Enter" && handleLogin()}
              />
              <div className="text-xs text-slate-500 mt-2">
                –ù–∞ GitHub Pages —ç—Ç–æ —Ç–æ–ª—å–∫–æ —Å–∫—Ä—ã–≤–∞–µ—Ç –∫–Ω–æ–ø–∫–∏. –≠—Ç–æ –Ω–µ —Ä–µ–∞–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞.
              </div>
              <div className="mt-4 flex gap-2">
                <button
                  onClick={handleLogin}
                  className="flex-1 px-3 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700"
                >
                  –í–æ–π—Ç–∏
                </button>
                <button
                  onClick={() => setShowLogin(false)}
                  className="flex-1 px-3 py-2 rounded-xl bg-slate-200 text-slate-800 hover:bg-slate-300"
                >
                  –û—Ç–º–µ–Ω–∞
                </button>
              </div>
            </Modal>
          )}

          {/* person form */}
          {showPersonForm && (
            <PersonFormModal
              person={editingPerson}
              onClose={() => { setShowPersonForm(false); setEditingPerson(null); }}
              onSave={(data) => {
                if (editingPerson) updatePerson(data);
                else addPerson(data);
              }}
            />
          )}

          {/* couple form */}
          {showCoupleForm && (
            <CoupleFormModal
              people={people}
              onClose={() => setShowCoupleForm(false)}
              onSave={(data) => addCouple(data)}
            />
          )}

          {/* add child modal */}
          {addChildModal.open && (
            <AddChildModal
              people={people}
              couple={couples.find(c => c.id === addChildModal.coupleId) || null}
              onClose={closeAddChild}
              onCreate={(childData) => createChildAndAttach(addChildModal.coupleId, childData)}
              onAttachExisting={(childId) => attachExistingChild(addChildModal.coupleId, childId)}
            />
          )}
        </div>
      );
    }

    // =========================
    // Tree node components
    // =========================
    function TreeCoupleNode({
      couple,
      people,
      couplesByPerson,
      expanded,
      toggleExpanded,
      onSelectPerson,
      isAdmin,
      onOpenAddChild
    }) {
      const p1 = people.find(p => p.id === couple.partner1Id) || null;
      const p2 = people.find(p => p.id === couple.partner2Id) || null;
      const statusIcon = couple.status === "divorced" ? "üíî" : "‚ù§Ô∏è";

      const children = (couple.childrenIds || [])
        .map(id => people.find(p => p.id === id))
        .filter(Boolean);

      const isExpanded = expanded.has(couple.id);

      return (
        <li>
          <div className="coupleDownLine">
            <div className="coupleRow">
              <PersonCardMini person={p1} onClick={() => p1 && onSelectPerson(p1.id)} />
              <div
                className="coupleMid"
                title={isAdmin ? "–î–æ–±–∞–≤–∏—Ç—å —Ä–µ–±—ë–Ω–∫–∞ —ç—Ç–æ–π –ø–∞—Ä—ã" : "–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω"}
                aria-disabled={!isAdmin}
                onClick={() => isAdmin && onOpenAddChild()}
              >
                {statusIcon}
              </div>
              <PersonCardMini person={p2} onClick={() => p2 && onSelectPerson(p2.id)} />
            </div>

            {children.length > 0 && (
              <div className="mt-2">
                <button
                  className="text-xs px-2 py-1 rounded-lg bg-slate-100 hover:bg-slate-200 text-slate-700"
                  onClick={() => toggleExpanded(couple.id)}
                >
                  {isExpanded ? "–°–≤–µ—Ä–Ω—É—Ç—å –¥–µ—Ç–µ–π ‚ñ≤" : `–ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–µ–π (${children.length}) ‚ñº`}
                </button>
              </div>
            )}
          </div>

          {children.length > 0 && isExpanded && (
            <ul className="clearfix">
              {children.map(ch => (
                <TreePersonDescNode
                  key={ch.id}
                  person={ch}
                  people={people}
                  couplesByPerson={couplesByPerson}
                  expanded={expanded}
                  toggleExpanded={toggleExpanded}
                  onSelectPerson={onSelectPerson}
                  isAdmin={isAdmin}
                />
              ))}
            </ul>
          )}
        </li>
      );
    }

    function TreePersonDescNode({
      person,
      people,
      couplesByPerson,
      expanded,
      toggleExpanded,
      onSelectPerson,
      isAdmin
    }) {
      const personCouples = couplesByPerson.get(person.id) || [];
      // —É–ø—Ä–æ—â–µ–Ω–∏–µ: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ "–ø–µ—Ä–≤—É—é" –ø–∞—Ä—É –ø–æ—Ç–æ–º–∫–æ–≤
      const firstCouple = personCouples[0] || null;

      // –µ—Å–ª–∏ —É —Ä–µ–±—ë–Ω–∫–∞ –µ—Å—Ç—å —Å–≤–æ—è –ø–∞—Ä–∞, –º–æ–∂–Ω–æ —Ä–∞—Å–∫—Ä—ã—Ç—å –µ—ë –ø–æ–¥ –Ω–∏–º
      const hasOwnCouple = Boolean(firstCouple);
      const isExpanded = expanded.has("person_" + person.id);

      return (
        <li>
          <div className="flex flex-col items-center gap-2">
            <PersonCardMini person={person} onClick={() => onSelectPerson(person.id)} />

            {hasOwnCouple && (
              <button
                className="text-xs px-2 py-1 rounded-lg bg-slate-100 hover:bg-slate-200 text-slate-700"
                onClick={() => toggleExpanded("person_" + person.id)}
              >
                {isExpanded ? "–°–≤–µ—Ä–Ω—É—Ç—å –≤–µ—Ç–∫—É ‚ñ≤" : "–ü–æ–∫–∞–∑–∞—Ç—å –≤–µ—Ç–∫—É ‚ñº"}
              </button>
            )}
          </div>

          {hasOwnCouple && isExpanded && (
            <ul className="clearfix">
              <TreeCoupleNode
                couple={firstCouple}
                people={people}
                couplesByPerson={couplesByPerson}
                expanded={expanded}
                toggleExpanded={toggleExpanded}
                onSelectPerson={onSelectPerson}
                isAdmin={isAdmin}
                onOpenAddChild={() => {} /* –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–µ—Ç–µ–π –¥–æ—Å—Ç—É–ø–Ω–æ —á–µ—Ä–µ–∑ —Å–µ—Ä–¥–µ—á–∫–æ –ø–∞—Ä—ã (–≤–Ω—É—Ç—Ä–∏ TreeCoupleNode) */}
              />
            </ul>
          )}
        </li>
      );
    }

    function PersonCardMini({ person, onClick }) {
      if (!person) {
        return (
          <div className="personCard opacity-60 cursor-not-allowed">
            <div className="avatar">?</div>
            <div className="text-left min-w-0">
              <div className="font-semibold text-slate-900 truncate">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
              <div className="text-xs text-slate-500">‚Äî</div>
            </div>
          </div>
        );
      }

      const initials = ((person.firstName?.[0] || "?") + (person.lastName?.[0] || "")).toUpperCase();
      const genderIcon = person.gender === "F" ? "‚ôÄ" : "‚ôÇ";

      return (
        <div className="personCard" onClick={onClick} title="–û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É">
          {person.mainPhoto ? (
            <img className="avatar" src={person.mainPhoto} alt="–§–æ—Ç–æ" />
          ) : (
            <div className="avatar">{initials}</div>
          )}

          <div className="text-left min-w-0">
            <div className="font-semibold text-slate-900 truncate">{person.lastName} {person.firstName}</div>
            <div className="text-xs text-slate-500 truncate">{person.middleName || " "}</div>
            <div className="text-xs text-slate-600 flex items-center gap-2">
              <span>{genderIcon}</span>
              <span>{yearRange(person.birthDate, person.deathDate)}</span>
            </div>
          </div>
        </div>
      );
    }

    // =========================
    // Modals
    // =========================
    function Modal({ children, onClose }) {
      return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-2xl w-full max-w-lg p-5 shadow-xl">
            <div className="flex justify-end">
              <button onClick={onClose} className="px-3 py-1 rounded-lg bg-slate-200 hover:bg-slate-300 text-slate-800 text-sm">
                –ó–∞–∫—Ä—ã—Ç—å
              </button>
            </div>
            <div className="mt-3">{children}</div>
          </div>
        </div>
      );
    }

    function PersonFormModal({ person, onClose, onSave }) {
      const [form, setForm] = useState(person || {
        id: uid(),
        firstName: "",
        lastName: "",
        middleName: "",
        gender: "M",
        birthDate: "",
        deathDate: "",
        description: "",
        mainPhoto: "",
        photos: []
      });

      const handleMainPhoto = (file) => {
        if (!file) return;
        const reader = new FileReader();
        reader.onloadend = () => {
          const dataUrl = String(reader.result || "");
          setForm(prev => ({
            ...prev,
            mainPhoto: dataUrl,
            photos: prev.photos?.length ? prev.photos : (dataUrl ? [dataUrl] : [])
          }));
        };
        reader.readAsDataURL(file);
      };

      const submit = () => {
        if (!form.lastName.trim() || !form.firstName.trim()) {
          alert("–ò–º—è –∏ —Ñ–∞–º–∏–ª–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã");
          return;
        }
        onSave(form);
      };

      return (
        <Modal onClose={onClose}>
          <div className="text-lg font-semibold mb-3">
            {person ? "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —á–µ–ª–æ–≤–µ–∫–∞" : "–î–æ–±–∞–≤–∏—Ç—å —á–µ–ª–æ–≤–µ–∫–∞"}
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
            <Field label="–§–∞–º–∏–ª–∏—è *">
              <input className="w-full border rounded-xl px-3 py-2"
                     value={form.lastName}
                     onChange={(e) => setForm(prev => ({...prev, lastName: e.target.value}))} />
            </Field>
            <Field label="–ò–º—è *">
              <input className="w-full border rounded-xl px-3 py-2"
                     value={form.firstName}
                     onChange={(e) => setForm(prev => ({...prev, firstName: e.target.value}))} />
            </Field>

            <Field label="–û—Ç—á–µ—Å—Ç–≤–æ" className="md:col-span-2">
              <input className="w-full border rounded-xl px-3 py-2"
                     value={form.middleName}
                     onChange={(e) => setForm(prev => ({...prev, middleName: e.target.value}))} />
            </Field>

            <Field label="–ü–æ–ª">
              <select className="w-full border rounded-xl px-3 py-2"
                      value={form.gender}
                      onChange={(e) => setForm(prev => ({...prev, gender: e.target.value}))}>
                <option value="M">–ú—É–∂—Å–∫–æ–π</option>
                <option value="F">–ñ–µ–Ω—Å–∫–∏–π</option>
              </select>
            </Field>

            <Field label="–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è">
              <input type="date" className="w-full border rounded-xl px-3 py-2"
                     value={form.birthDate}
                     onChange={(e) => setForm(prev => ({...prev, birthDate: e.target.value}))} />
            </Field>

            <Field label="–î–∞—Ç–∞ —Å–º–µ—Ä—Ç–∏">
              <input type="date" className="w-full border rounded-xl px-3 py-2"
                     value={form.deathDate}
                     onChange={(e) => setForm(prev => ({...prev, deathDate: e.target.value}))} />
            </Field>

            <Field label="–û–ø–∏—Å–∞–Ω–∏–µ" className="md:col-span-2">
              <textarea rows="3" className="w-full border rounded-xl px-3 py-2"
                        value={form.description}
                        onChange={(e) => setForm(prev => ({...prev, description: e.target.value}))} />
            </Field>

            <Field label="–ì–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ" className="md:col-span-2">
              <input type="file" accept="image/*" className="w-full border rounded-xl px-3 py-2"
                     onChange={(e) => handleMainPhoto(e.target.files?.[0])} />
              {form.mainPhoto && (
                <img src={form.mainPhoto} className="mt-2 w-28 h-28 rounded-xl object-cover border" alt="preview" />
              )}
            </Field>
          </div>

          <div className="mt-4 flex gap-2">
            <button onClick={submit} className="flex-1 px-3 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700">
              –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
            </button>
            <button onClick={onClose} className="flex-1 px-3 py-2 rounded-xl bg-slate-200 text-slate-800 hover:bg-slate-300">
              –û—Ç–º–µ–Ω–∞
            </button>
          </div>
        </Modal>
      );
    }

    function CoupleFormModal({ people, onClose, onSave }) {
      const [form, setForm] = useState({
        partner1Id: "",
        partner2Id: "",
        status: "married"
      });

      const submit = () => {
        if (!form.partner1Id || !form.partner2Id) {
          alert("–í—ã–±–µ—Ä–∏ –¥–≤—É—Ö –ª—é–¥–µ–π");
          return;
        }
        if (form.partner1Id === form.partner2Id) {
          alert("–ù—É–∂–Ω—ã –¥–≤–∞ —Ä–∞–∑–Ω—ã—Ö —á–µ–ª–æ–≤–µ–∫–∞");
          return;
        }
        onSave(form);
      };

      return (
        <Modal onClose={onClose}>
          <div className="text-lg font-semibold mb-3">–î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä—É</div>

          <div className="space-y-3">
            <Field label="–ü–∞—Ä—Ç–Ω—ë—Ä 1">
              <select className="w-full border rounded-xl px-3 py-2"
                      value={form.partner1Id}
                      onChange={(e) => setForm(prev => ({...prev, partner1Id: e.target.value}))}>
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ‚Ä¶</option>
                {people.map(p => (
                  <option key={p.id} value={p.id}>{safeName(p)}</option>
                ))}
              </select>
            </Field>

            <Field label="–ü–∞—Ä—Ç–Ω—ë—Ä 2">
              <select className="w-full border rounded-xl px-3 py-2"
                      value={form.partner2Id}
                      onChange={(e) => setForm(prev => ({...prev, partner2Id: e.target.value}))}>
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ‚Ä¶</option>
                {people.map(p => (
                  <option key={p.id} value={p.id}>{safeName(p)}</option>
                ))}
              </select>
            </Field>

            <Field label="–°—Ç–∞—Ç—É—Å">
              <select className="w-full border rounded-xl px-3 py-2"
                      value={form.status}
                      onChange={(e) => setForm(prev => ({...prev, status: e.target.value}))}>
                <option value="married">–ë—Ä–∞–∫ ‚ù§Ô∏è</option>
                <option value="divorced">–†–∞–∑–≤–æ–¥ üíî</option>
              </select>
            </Field>
          </div>

          <div className="mt-4 flex gap-2">
            <button onClick={submit} className="flex-1 px-3 py-2 rounded-xl bg-sky-600 text-white hover:bg-sky-700">
              –î–æ–±–∞–≤–∏—Ç—å
            </button>
            <button onClick={onClose} className="flex-1 px-3 py-2 rounded-xl bg-slate-200 text-slate-800 hover:bg-slate-300">
              –û—Ç–º–µ–Ω–∞
            </button>
          </div>
        </Modal>
      );
    }

    function AddChildModal({ people, couple, onClose, onCreate, onAttachExisting }) {
      const [mode, setMode] = useState("create"); // create | attach
      const [existingId, setExistingId] = useState("");

      const [child, setChild] = useState({
        firstName: "",
        lastName: "",
        middleName: "",
        gender: "M",
        birthDate: "",
        deathDate: "",
        description: "",
        mainPhoto: ""
      });

      const handleMainPhoto = (file) => {
        if (!file) return;
        const reader = new FileReader();
        reader.onloadend = () => setChild(prev => ({...prev, mainPhoto: String(reader.result || "")}));
        reader.readAsDataURL(file);
      };

      if (!couple) {
        return (
          <Modal onClose={onClose}>
            <div className="text-slate-700">–ü–∞—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.</div>
          </Modal>
        );
      }

      const submitCreate = () => {
        if (!child.firstName.trim()) {
          alert("–ò–º—è —Ä–µ–±—ë–Ω–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ (–º–∏–Ω–∏–º—É–º –∏–º—è).");
          return;
        }
        onCreate(child);
      };

      const submitAttach = () => {
        if (!existingId) {
          alert("–í—ã–±–µ—Ä–∏ —Ä–µ–±—ë–Ω–∫–∞ –∏–∑ —Å–ø–∏—Å–∫–∞");
          return;
        }
        onAttachExisting(existingId);
      };

      // —á—Ç–æ–±—ã –Ω–µ –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã—Ö
      const attached = new Set(couple.childrenIds || []);
      const attachCandidates = people.filter(p => !attached.has(p.id));

      return (
        <Modal onClose={onClose}>
          <div className="text-lg font-semibold mb-3">–î–æ–±–∞–≤–∏—Ç—å —Ä–µ–±—ë–Ω–∫–∞ –∫ –ø–∞—Ä–µ</div>

          <div className="flex gap-2 mb-3">
            <button
              onClick={() => setMode("create")}
              className={"px-3 py-2 rounded-xl text-sm " + (mode === "create" ? "bg-indigo-600 text-white" : "bg-slate-100 hover:bg-slate-200")}
            >
              –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ
            </button>
            <button
              onClick={() => setMode("attach")}
              className={"px-3 py-2 rounded-xl text-sm " + (mode === "attach" ? "bg-indigo-600 text-white" : "bg-slate-100 hover:bg-slate-200")}
            >
              –ü—Ä–∏–≤—è–∑–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ
            </button>
          </div>

          {mode === "attach" ? (
            <>
              <Field label="–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–±—ë–Ω–∫–∞">
                <select
                  className="w-full border rounded-xl px-3 py-2"
                  value={existingId}
                  onChange={(e) => setExistingId(e.target.value)}
                >
                  <option value="">–í—ã–±–µ—Ä–∏—Ç–µ‚Ä¶</option>
                  {attachCandidates.map(p => (
                    <option key={p.id} value={p.id}>{safeName(p)}</option>
                  ))}
                </select>
              </Field>

              <div className="mt-4 flex gap-2">
                <button onClick={submitAttach} className="flex-1 px-3 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700">
                  –ü—Ä–∏–≤—è–∑–∞—Ç—å
                </button>
                <button onClick={onClose} className="flex-1 px-3 py-2 rounded-xl bg-slate-200 text-slate-800 hover:bg-slate-300">
                  –û—Ç–º–µ–Ω–∞
                </button>
              </div>
            </>
          ) : (
            <>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                <Field label="–ò–º—è *">
                  <input className="w-full border rounded-xl px-3 py-2"
                         value={child.firstName}
                         onChange={(e) => setChild(prev => ({...prev, firstName: e.target.value}))}/>
                </Field>
                <Field label="–§–∞–º–∏–ª–∏—è">
                  <input className="w-full border rounded-xl px-3 py-2"
                         value={child.lastName}
                         onChange={(e) => setChild(prev => ({...prev, lastName: e.target.value}))}/>
                </Field>
                <Field label="–û—Ç—á–µ—Å—Ç–≤–æ" className="md:col-span-2">
                  <input className="w-full border rounded-xl px-3 py-2"
                         value={child.middleName}
                         onChange={(e) => setChild(prev => ({...prev, middleName: e.target.value}))}/>
                </Field>

                <Field label="–ü–æ–ª">
                  <select className="w-full border rounded-xl px-3 py-2"
                          value={child.gender}
                          onChange={(e) => setChild(prev => ({...prev, gender: e.target.value}))}>
                    <option value="M">–ú—É–∂—Å–∫–æ–π</option>
                    <option value="F">–ñ–µ–Ω—Å–∫–∏–π</option>
                  </select>
                </Field>

                <Field label="–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è">
                  <input type="date" className="w-full border rounded-xl px-3 py-2"
                         value={child.birthDate}
                         onChange={(e) => setChild(prev => ({...prev, birthDate: e.target.value}))}/>
                </Field>

                <Field label="–î–∞—Ç–∞ —Å–º–µ—Ä—Ç–∏">
                  <input type="date" className="w-full border rounded-xl px-3 py-2"
                         value={child.deathDate}
                         onChange={(e) => setChild(prev => ({...prev, deathDate: e.target.value}))}/>
                </Field>

                <Field label="–û–ø–∏—Å–∞–Ω–∏–µ" className="md:col-span-2">
                  <textarea rows="3" className="w-full border rounded-xl px-3 py-2"
                            value={child.description}
                            onChange={(e) => setChild(prev => ({...prev, description: e.target.value}))}/>
                </Field>

                <Field label="–§–æ—Ç–æ" className="md:col-span-2">
                  <input type="file" accept="image/*" className="w-full border rounded-xl px-3 py-2"
                         onChange={(e) => handleMainPhoto(e.target.files?.[0])}/>
                  {child.mainPhoto && (
                    <img src={child.mainPhoto} className="mt-2 w-28 h-28 rounded-xl object-cover border" alt="preview"/>
                  )}
                </Field>
              </div>

              <div className="mt-4 flex gap-2">
                <button onClick={submitCreate} className="flex-1 px-3 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700">
                  –°–æ–∑–¥–∞—Ç—å –∏ –¥–æ–±–∞–≤–∏—Ç—å
                </button>
                <button onClick={onClose} className="flex-1 px-3 py-2 rounded-xl bg-slate-200 text-slate-800 hover:bg-slate-300">
                  –û—Ç–º–µ–Ω–∞
                </button>
              </div>
            </>
          )}
        </Modal>
      );
    }

    function PersonDetailModal({
      person,
      isAdmin,
      onClose,
      onEdit,
      onDelete,
      couples,
      people,
      comments,
      onDeleteComment,
      newComment,
      setNewComment,
      onAddComment,
      onAddAlbumPhoto,
      onDeleteAlbumPhoto
    }) {
      const relatedCouples = couples.filter(c => c.partner1Id === person.id || c.partner2Id === person.id);
      const children = [];
      for (const c of relatedCouples) {
        for (const chId of (c.childrenIds || [])) {
          const ch = people.find(p => p.id === chId);
          if (ch) children.push(ch);
        }
      }

      return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-2xl w-full max-w-4xl shadow-xl max-h-[90vh] overflow-y-auto">
            <div className="sticky top-0 bg-white border-b px-5 py-4 flex items-center justify-between gap-2">
              <div className="font-semibold text-lg">{person.lastName} {person.firstName} {person.middleName}</div>
              <div className="flex items-center gap-2">
                {isAdmin && (
                  <>
                    <button onClick={onEdit} className="px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 text-sm">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    <button onClick={onDelete} className="px-3 py-2 rounded-xl bg-rose-600 text-white hover:bg-rose-700 text-sm">–£–¥–∞–ª–∏—Ç—å</button>
                  </>
                )}
                <button onClick={onClose} className="px-3 py-2 rounded-xl bg-slate-200 hover:bg-slate-300 text-sm">–ó–∞–∫—Ä—ã—Ç—å</button>
              </div>
            </div>

            <div className="p-5 space-y-6">
              <div className="flex flex-col md:flex-row gap-5">
                <div className="w-32 h-32 rounded-2xl border overflow-hidden bg-slate-100 flex items-center justify-center">
                  {person.mainPhoto ? <img src={person.mainPhoto} className="w-full h-full object-cover" /> : <span className="text-slate-500">–Ω–µ—Ç —Ñ–æ—Ç–æ</span>}
                </div>

                <div className="flex-1 grid grid-cols-1 md:grid-cols-2 gap-3">
                  <Info label="–ü–æ–ª" value={person.gender === "F" ? "–ñ–µ–Ω—Å–∫–∏–π" : "–ú—É–∂—Å–∫–æ–π"} />
                  <Info label="–ì–æ–¥—ã" value={yearRange(person.birthDate, person.deathDate)} />
                  <Info label="–†–æ–∂–¥–µ–Ω–∏–µ" value={person.birthDate ? new Date(person.birthDate).toLocaleDateString("ru-RU") : "‚Äî"} />
                  <Info label="–°–º–µ—Ä—Ç—å" value={person.deathDate ? new Date(person.deathDate).toLocaleDateString("ru-RU") : "‚Äî"} />
                  {person.description && <div className="md:col-span-2"><Info label="–û–ø–∏—Å–∞–Ω–∏–µ" value={person.description} /></div>}
                </div>
              </div>

              <div className="border-t pt-4 space-y-3">
                <div className="font-semibold">–°–≤—è–∑–∏</div>

                <div>
                  <div className="text-sm text-slate-600 mb-1">–ü–∞—Ä—ã</div>
                  {relatedCouples.length ? (
                    <div className="space-y-2">
                      {relatedCouples.map(c => {
                        const otherId = c.partner1Id === person.id ? c.partner2Id : c.partner1Id;
                        const other = people.find(p => p.id === otherId);
                        return (
                          <div key={c.id} className="border rounded-xl p-3 bg-slate-50 flex items-center justify-between">
                            <div className="flex items-center gap-2">
                              <span>{c.status === "divorced" ? "üíî" : "‚ù§Ô∏è"}</span>
                              <span className="font-medium">{other ? safeName(other) : "‚Äî"}</span>
                              <span className="text-xs text-slate-500">{c.status === "divorced" ? "(—Ä–∞–∑–≤–æ–¥)" : "(–±—Ä–∞–∫)"}</span>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  ) : (
                    <div className="text-sm text-slate-500">–Ω–µ—Ç</div>
                  )}
                </div>

                <div>
                  <div className="text-sm text-slate-600 mb-1">–î–µ—Ç–∏</div>
                  {children.length ? (
                    <div className="flex flex-wrap gap-2">
                      {children.map(ch => (
                        <span key={ch.id} className="px-3 py-1 rounded-full bg-emerald-100 text-emerald-800 text-sm">
                          {safeName(ch)}
                        </span>
                      ))}
                    </div>
                  ) : (
                    <div className="text-sm text-slate-500">–Ω–µ—Ç</div>
                  )}
                </div>
              </div>

              <div className="border-t pt-4">
                <div className="flex items-center justify-between mb-2">
                  <div className="font-semibold">–§–æ—Ç–æ–∞–ª—å–±–æ–º</div>
                  {isAdmin && (
                    <label className="px-3 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 cursor-pointer text-sm">
                      + –¥–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ
                      <input className="hidden" type="file" accept="image/*" onChange={(e) => onAddAlbumPhoto(e.target.files?.[0])} />
                    </label>
                  )}
                </div>

                {person.photos?.length ? (
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                    {person.photos.map((ph, idx) => (
                      <div key={idx} className="relative">
                        <img src={ph} className="w-full h-28 object-cover rounded-xl border" />
                        {isAdmin && (
                          <button
                            onClick={() => onDeleteAlbumPhoto(idx)}
                            className="absolute top-2 right-2 px-2 py-1 text-xs rounded-lg bg-black/70 text-white"
                          >
                            —É–¥–∞–ª–∏—Ç—å
                          </button>
                        )}
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="text-sm text-slate-500">—Ñ–æ—Ç–æ –Ω–µ—Ç</div>
                )}
              </div>

              <div className="border-t pt-4">
                <div className="font-semibold mb-2">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</div>

                <textarea
                  className="w-full border rounded-xl px-3 py-2"
                  rows="3"
                  value={newComment}
                  onChange={(e) => setNewComment(e.target.value)}
                  placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π‚Ä¶"
                />
                <button
                  onClick={onAddComment}
                  className="mt-2 px-3 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 text-sm"
                >
                  –î–æ–±–∞–≤–∏—Ç—å
                </button>

                <div className="mt-4 space-y-2">
                  {comments.length ? comments.map(c => (
                    <div key={c.id} className="border rounded-xl p-3 bg-slate-50">
                      <div className="flex items-start justify-between gap-2">
                        <div>
                          <div className="text-sm font-medium">{c.author}</div>
                          <div className="text-xs text-slate-500">{new Date(c.date).toLocaleString("ru-RU")}</div>
                        </div>
                        {isAdmin && (
                          <button
                            onClick={() => onDeleteComment(c.id)}
                            className="px-2 py-1 rounded-lg bg-rose-100 text-rose-700 hover:bg-rose-200 text-xs"
                          >
                            —É–¥–∞–ª–∏—Ç—å
                          </button>
                        )}
                      </div>
                      <div className="text-sm text-slate-800 mt-2 whitespace-pre-wrap">{c.text}</div>
                    </div>
                  )) : (
                    <div className="text-sm text-slate-500">–ø–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</div>
                  )}
                </div>
              </div>

              <div className="text-xs text-slate-500">
                –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ localStorage: —É –∫–∞–∂–¥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞/–±—Ä–∞—É–∑–µ—Ä–∞ —Å–≤–æ—ë –¥–µ—Ä–µ–≤–æ.
              </div>
            </div>
          </div>
        </div>
      );
    }

    function Field({ label, children, className = "" }) {
      return (
        <div className={className}>
          <div className="text-sm text-slate-700 mb-1">{label}</div>
          {children}
        </div>
      );
    }

    function Info({ label, value }) {
      return (
        <div className="bg-slate-50 border rounded-xl p-3">
          <div className="text-xs text-slate-500">{label}</div>
          <div className="text-sm text-slate-900 whitespace-pre-wrap">{value}</div>
        </div>
      );
    }

    // mount
    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>


