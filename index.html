<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Семейное дерево (просмотр + комментарии, редактирование только админ)</title>

  <!-- React -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- Babel (чтобы работал JSX в одном файле) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-50 text-slate-900">
  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useState } = React;

    /********************
     * НАСТРОЙКИ
     ********************/
    const ADMIN_PASSWORD = "1234"; // <-- поменяй пароль здесь

    const LS_KEYS = {
      people: "ft_people_v1",
      relationships: "ft_relationships_v1",
      comments: "ft_comments_v1",
      adminSession: "ft_is_admin_session_v1" // sessionStorage
    };

    /********************
     * ДАННЫЕ ПО УМОЛЧАНИЮ
     * (замени на свои)
     ********************/
    const DEFAULT_PEOPLE = [
      { id: "p1", firstName: "Иван", lastName: "Иванов", gender: "M", birthDate: "1960-01-01", deathDate: "", notes: "" },
      { id: "p2", firstName: "Анна", lastName: "Иванова", gender: "F", birthDate: "1962-05-15", deathDate: "", notes: "" },
      { id: "p3", firstName: "Пётр", lastName: "Иванов", gender: "M", birthDate: "1990-09-09", deathDate: "", notes: "" },
      { id: "p4", firstName: "Мария", lastName: "Смирнова", gender: "F", birthDate: "1992-11-20", deathDate: "", notes: "" },
      { id: "p5", firstName: "София", lastName: "Иванова", gender: "F", birthDate: "2018-03-02", deathDate: "", notes: "" }
    ];

    // relationship types:
    // - marriage (с датами)
    // - parent-child
    const DEFAULT_RELATIONSHIPS = [
      { id: "r1", type: "marriage", person1Id: "p1", person2Id: "p2", marriageDate: "1985-07-01", divorceDate: "" },
      { id: "r2", type: "parent-child", parentId: "p1", childId: "p3" },
      { id: "r3", type: "parent-child", parentId: "p2", childId: "p3" },

      { id: "r4", type: "marriage", person1Id: "p3", person2Id: "p4", marriageDate: "2016-08-10", divorceDate: "" },
      { id: "r5", type: "parent-child", parentId: "p3", childId: "p5" },
      { id: "r6", type: "parent-child", parentId: "p4", childId: "p5" }
    ];

    const DEFAULT_COMMENTS = [
      // { id, personId, text, author, dateISO }
    ];

    /********************
     * УТИЛИТЫ
     ********************/
    function safeJsonParse(v, fallback) {
      try { return JSON.parse(v); } catch { return fallback; }
    }

    function uid(prefix="id") {
      return prefix + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
    }

    function fmtDate(d) {
      if (!d) return "";
      try {
        const dt = new Date(d);
        if (Number.isNaN(dt.getTime())) return d;
        return dt.toLocaleDateString("ru-RU");
      } catch {
        return d;
      }
    }

    function fullName(p) {
      const ln = (p?.lastName || "").trim();
      const fn = (p?.firstName || "").trim();
      return [ln, fn].filter(Boolean).join(" ").trim() || "(без имени)";
    }

    function genderLabel(g) {
      if (g === "M") return "М";
      if (g === "F") return "Ж";
      return "—";
    }

    function sortByName(a, b) {
      const an = fullName(a).toLowerCase();
      const bn = fullName(b).toLowerCase();
      return an.localeCompare(bn, "ru");
    }

    /********************
     * ОСНОВНОЕ ПРИЛОЖЕНИЕ
     ********************/
    function App() {
      const [people, setPeople] = useState([]);
      const [relationships, setRelationships] = useState([]);
      const [comments, setComments] = useState([]);

      const [selectedPersonId, setSelectedPersonId] = useState(null);

      const [isAdmin, setIsAdmin] = useState(false);
      const [showLogin, setShowLogin] = useState(false);
      const [passwordInput, setPasswordInput] = useState("");

      const [toast, setToast] = useState("");

      // Admin forms
      const [personForm, setPersonForm] = useState({
        id: "",
        firstName: "",
        lastName: "",
        gender: "U",
        birthDate: "",
        deathDate: "",
        notes: ""
      });

      const [marriageForm, setMarriageForm] = useState({
        person1Id: "",
        person2Id: "",
        marriageDate: "",
        divorceDate: ""
      });

      const [pcForm, setPcForm] = useState({
        parentId: "",
        childId: ""
      });

      const selectedPerson = useMemo(() => people.find(p => p.id === selectedPersonId) || null, [people, selectedPersonId]);

      // init load
      useEffect(() => {
        const pRaw = localStorage.getItem(LS_KEYS.people);
        const rRaw = localStorage.getItem(LS_KEYS.relationships);
        const cRaw = localStorage.getItem(LS_KEYS.comments);

        const p = pRaw ? safeJsonParse(pRaw, DEFAULT_PEOPLE) : DEFAULT_PEOPLE;
        const r = rRaw ? safeJsonParse(rRaw, DEFAULT_RELATIONSHIPS) : DEFAULT_RELATIONSHIPS;
        const c = cRaw ? safeJsonParse(cRaw, DEFAULT_COMMENTS) : DEFAULT_COMMENTS;

        setPeople(Array.isArray(p) ? p : DEFAULT_PEOPLE);
        setRelationships(Array.isArray(r) ? r : DEFAULT_RELATIONSHIPS);
        setComments(Array.isArray(c) ? c : DEFAULT_COMMENTS);

        // restore admin session in this tab
        const adminFlag = sessionStorage.getItem(LS_KEYS.adminSession);
        setIsAdmin(adminFlag === "1");
      }, []);

      // persist
      useEffect(() => localStorage.setItem(LS_KEYS.people, JSON.stringify(people)), [people]);
      useEffect(() => localStorage.setItem(LS_KEYS.relationships, JSON.stringify(relationships)), [relationships]);
      useEffect(() => localStorage.setItem(LS_KEYS.comments, JSON.stringify(comments)), [comments]);

      // toast auto-hide
      useEffect(() => {
        if (!toast) return;
        const t = setTimeout(() => setToast(""), 2200);
        return () => clearTimeout(t);
      }, [toast]);

      const peopleById = useMemo(() => {
        const m = new Map();
        for (const p of people) m.set(p.id, p);
        return m;
      }, [people]);

      const marriages = useMemo(
        () => relationships.filter(r => r.type === "marriage"),
        [relationships]
      );

      const parentChildLinks = useMemo(
        () => relationships.filter(r => r.type === "parent-child"),
        [relationships]
      );

      function getSpouses(personId) {
        return marriages
          .filter(r => r.person1Id === personId || r.person2Id === personId)
          .map(r => {
            const otherId = r.person1Id === personId ? r.person2Id : r.person1Id;
            return { rel: r, person: peopleById.get(otherId) || null };
          })
          .filter(x => x.person);
      }

      function getParents(childId) {
        return parentChildLinks
          .filter(r => r.childId === childId)
          .map(r => peopleById.get(r.parentId))
          .filter(Boolean);
      }

      function getChildren(parentId) {
        return parentChildLinks
          .filter(r => r.parentId === parentId)
          .map(r => peopleById.get(r.childId))
          .filter(Boolean);
      }

      function getSiblings(personId) {
        const parents = getParents(personId).map(p => p.id);
        if (parents.length === 0) return [];
        const sibSet = new Map();
        for (const link of parentChildLinks) {
          if (parents.includes(link.parentId) && link.childId !== personId) {
            const sib = peopleById.get(link.childId);
            if (sib) sibSet.set(sib.id, sib);
          }
        }
        return Array.from(sibSet.values());
      }

      // --- Admin auth ---
      function login() {
        if (passwordInput === ADMIN_PASSWORD) {
          setIsAdmin(true);
          sessionStorage.setItem(LS_KEYS.adminSession, "1");
          setShowLogin(false);
          setPasswordInput("");
          setToast("Админ-режим включён");
        } else {
          alert("Неверный пароль");
        }
      }

      function logout() {
        setIsAdmin(false);
        sessionStorage.removeItem(LS_KEYS.adminSession);
        setToast("Админ-режим выключен");
      }

      // --- Comments ---
      const [newCommentText, setNewCommentText] = useState("");
      const [commentAuthor, setCommentAuthor] = useState("");

      function addComment() {
        if (!selectedPerson) return;
        const text = newCommentText.trim();
        if (!text) return;

        const author = (commentAuthor.trim() || (isAdmin ? "Админ" : "Гость")).slice(0, 40);

        setComments(prev => [
          ...prev,
          {
            id: uid("c"),
            personId: selectedPerson.id,
            text,
            author,
            dateISO: new Date().toISOString()
          }
        ]);

        setNewCommentText("");
        setToast("Комментарий добавлен");
      }

      function deleteComment(commentId) {
        if (!isAdmin) return;
        if (!confirm("Удалить комментарий?")) return;
        setComments(prev => prev.filter(c => c.id !== commentId));
        setToast("Комментарий удалён");
      }

      // --- Admin: People CRUD ---
      function startCreatePerson() {
        if (!isAdmin) return;
        setPersonForm({
          id: "",
          firstName: "",
          lastName: "",
          gender: "U",
          birthDate: "",
          deathDate: "",
          notes: ""
        });
      }

      function startEditPerson(p) {
        if (!isAdmin || !p) return;
        setPersonForm({
          id: p.id,
          firstName: p.firstName || "",
          lastName: p.lastName || "",
          gender: p.gender || "U",
          birthDate: p.birthDate || "",
          deathDate: p.deathDate || "",
          notes: p.notes || ""
        });
      }

      function savePerson() {
        if (!isAdmin) return;

        const firstName = (personForm.firstName || "").trim();
        const lastName = (personForm.lastName || "").trim();
        const gender = personForm.gender || "U";

        if (!firstName && !lastName) {
          alert("Укажи имя или фамилию");
          return;
        }

        if (personForm.id) {
          // update
          setPeople(prev => prev.map(p => p.id === personForm.id ? { ...p, ...personForm, firstName, lastName, gender } : p));
          setToast("Человек обновлён");
        } else {
          // create
          const newId = uid("p");
          setPeople(prev => [...prev, { ...personForm, id: newId, firstName, lastName, gender }]);
          setToast("Человек добавлен");
          setSelectedPersonId(newId);
        }

        // keep form as-is, but ensure id is set if newly created:
        if (!personForm.id) setPersonForm(f => ({ ...f, id: "" }));
      }

      function deletePerson(personId) {
        if (!isAdmin) return;
        const p = peopleById.get(personId);
        if (!p) return;
        if (!confirm(`Удалить "${fullName(p)}"? Также удалятся все связи и комментарии.`)) return;

        setPeople(prev => prev.filter(x => x.id !== personId));
        setRelationships(prev => prev.filter(r => {
          if (r.type === "marriage") return r.person1Id !== personId && r.person2Id !== personId;
          if (r.type === "parent-child") return r.parentId !== personId && r.childId !== personId;
          return true;
        }));
        setComments(prev => prev.filter(c => c.personId !== personId));

        if (selectedPersonId === personId) setSelectedPersonId(null);
        setToast("Человек удалён");
      }

      // --- Admin: Relationships ---
      function addMarriage() {
        if (!isAdmin) return;
        const a = marriageForm.person1Id;
        const b = marriageForm.person2Id;
        if (!a || !b || a === b) {
          alert("Выбери двух разных людей");
          return;
        }
        // prevent duplicates
        const exists = marriages.some(r =>
          (r.person1Id === a && r.person2Id === b) || (r.person1Id === b && r.person2Id === a)
        );
        if (exists) {
          alert("Такой брак уже есть");
          return;
        }

        setRelationships(prev => [
          ...prev,
          {
            id: uid("r"),
            type: "marriage",
            person1Id: a,
            person2Id: b,
            marriageDate: marriageForm.marriageDate || "",
            divorceDate: marriageForm.divorceDate || ""
          }
        ]);

        setMarriageForm({ person1Id: "", person2Id: "", marriageDate: "", divorceDate: "" });
        setToast("Брак добавлен");
      }

      function addParentChild() {
        if (!isAdmin) return;
        const parentId = pcForm.parentId;
        const childId = pcForm.childId;
        if (!parentId || !childId || parentId === childId) {
          alert("Выбери родителя и ребёнка (разных)");
          return;
        }

        const exists = parentChildLinks.some(r => r.parentId === parentId && r.childId === childId);
        if (exists) {
          alert("Такая связь уже есть");
          return;
        }

        setRelationships(prev => [...prev, { id: uid("r"), type: "parent-child", parentId, childId }]);
        setPcForm({ parentId: "", childId: "" });
        setToast("Связь родитель-ребёнок добавлена");
      }

      function deleteRelationship(relId) {
        if (!isAdmin) return;
        if (!confirm("Удалить связь?")) return;
        setRelationships(prev => prev.filter(r => r.id !== relId));
        setToast("Связь удалена");
      }

      // --- Export/Import ---
      function exportJson() {
        const payload = { people, relationships, comments, exportedAt: new Date().toISOString() };
        const text = JSON.stringify(payload, null, 2);
        const blob = new Blob([text], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "family-tree-export.json";
        a.click();
        URL.revokeObjectURL(url);
      }

      function importJsonFile(file) {
        if (!isAdmin) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const data = JSON.parse(reader.result);
            if (!data || !Array.isArray(data.people) || !Array.isArray(data.relationships) || !Array.isArray(data.comments)) {
              alert("Файл не похож на экспорт этого приложения");
              return;
            }
            if (!confirm("Заменить текущие данные данными из файла?")) return;
            setPeople(data.people);
            setRelationships(data.relationships);
            setComments(data.comments);
            setSelectedPersonId(null);
            setToast("Импорт выполнен");
          } catch {
            alert("Не удалось прочитать JSON");
          }
        };
        reader.readAsText(file, "utf-8");
      }

      function resetToDefaults() {
        if (!isAdmin) return;
        if (!confirm("Сбросить данные к значениям по умолчанию? (перезапишет localStorage)")) return;
        setPeople(DEFAULT_PEOPLE);
        setRelationships(DEFAULT_RELATIONSHIPS);
        setComments(DEFAULT_COMMENTS);
        setSelectedPersonId(null);
        setToast("Сброшено к умолчанию");
      }

      // --- Lists for UI ---
      const peopleSorted = useMemo(() => [...people].sort(sortByName), [people]);

      const selectedComments = useMemo(() => {
        if (!selectedPerson) return [];
        return comments
          .filter(c => c.personId === selectedPerson.id)
          .slice()
          .sort((a, b) => (a.dateISO || "").localeCompare(b.dateISO || ""));
      }, [comments, selectedPerson]);

      // --- Derive "top" people (no parents) ---
      const rootCandidates = useMemo(() => {
        const hasParent = new Set(parentChildLinks.map(r => r.childId));
        return peopleSorted.filter(p => !hasParent.has(p.id));
      }, [peopleSorted, parentChildLinks]);

      // Render helpers
      function Pill({ children, className="" }) {
        return <span className={"inline-flex items-center rounded-full px-2 py-0.5 text-xs bg-slate-100 border border-slate-200 " + className}>{children}</span>;
      }

      return (
        <div className="min-h-screen">
          {/* Header */}
          <div className="sticky top-0 z-20 bg-white/85 backdrop-blur border-b border-slate-200">
            <div className="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
              <div className="font-semibold text-lg">Семейное дерево</div>
              <div className="text-sm text-slate-600">
                Просмотр + комментарии для гостей, редактирование только админ
              </div>
              <div className="ml-auto flex items-center gap-2">
                {isAdmin ? (
                  <>
                    <Pill className="bg-emerald-50 border-emerald-200 text-emerald-800">Админ</Pill>
                    <button onClick={logout} className="px-3 py-1.5 rounded-lg bg-slate-900 text-white text-sm">Выйти</button>
                  </>
                ) : (
                  <>
                    <Pill>Гость</Pill>
                    <button onClick={() => setShowLogin(true)} className="px-3 py-1.5 rounded-lg bg-indigo-600 text-white text-sm">Войти как админ</button>
                  </>
                )}
              </div>
            </div>
          </div>

          {/* Toast */}
          {toast && (
            <div className="fixed bottom-4 left-1/2 -translate-x-1/2 z-30">
              <div className="px-4 py-2 rounded-xl bg-slate-900 text-white text-sm shadow-lg">{toast}</div>
            </div>
          )}

          {/* Login modal */}
          {showLogin && (
            <div className="fixed inset-0 z-40 bg-black/40 flex items-center justify-center p-4">
              <div className="w-full max-w-sm bg-white rounded-2xl shadow-xl border border-slate-200 p-5">
                <div className="flex items-start gap-3">
                  <div className="font-semibold text-lg">Вход админа</div>
                  <button onClick={() => { setShowLogin(false); setPasswordInput(""); }} className="ml-auto text-slate-500 hover:text-slate-900">✕</button>
                </div>
                <div className="mt-3 text-sm text-slate-600">
                  Пароль нужен только для редактирования. Гости могут читать и писать комментарии.
                </div>
                <input
                  type="password"
                  value={passwordInput}
                  onChange={(e) => setPasswordInput(e.target.value)}
                  onKeyDown={(e) => { if (e.key === "Enter") login(); }}
                  placeholder="Пароль"
                  className="mt-4 w-full border border-slate-300 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-200"
                />
                <button
                  onClick={login}
                  className="mt-3 w-full px-4 py-2 rounded-xl bg-indigo-600 text-white font-medium"
                >
                  Войти
                </button>
              </div>
            </div>
          )}

          {/* Main layout */}
          <div className="max-w-6xl mx-auto px-4 py-5 grid grid-cols-1 lg:grid-cols-12 gap-4">
            {/* Left: people list */}
            <div className="lg:col-span-4 space-y-3">
              <div className="bg-white border border-slate-200 rounded-2xl p-4">
                <div className="flex items-center gap-2">
                  <div className="font-semibold">Люди</div>
                  <Pill>{people.length}</Pill>
                  <div className="ml-auto flex items-center gap-2">
                    {isAdmin && (
                      <button
                        onClick={startCreatePerson}
                        className="px-3 py-1.5 rounded-lg bg-emerald-600 text-white text-sm"
                      >
                        + Добавить
                      </button>
                    )}
                  </div>
                </div>

                <div className="mt-3 max-h-[55vh] overflow-auto pr-1 space-y-2">
                  {peopleSorted.map(p => (
                    <button
                      key={p.id}
                      onClick={() => setSelectedPersonId(p.id)}
                      className={
                        "w-full text-left p-3 rounded-xl border transition " +
                        (selectedPersonId === p.id
                          ? "bg-indigo-50 border-indigo-200"
                          : "bg-white border-slate-200 hover:bg-slate-50")
                      }
                    >
                      <div className="flex items-center gap-2">
                        <div className="font-medium">{fullName(p)}</div>
                        <Pill className="ml-auto">{genderLabel(p.gender)}</Pill>
                      </div>
                      <div className="mt-1 text-xs text-slate-600">
                        {p.birthDate ? `р. ${fmtDate(p.birthDate)}` : "дата рождения не указана"}
                        {p.deathDate ? ` • ум. ${fmtDate(p.deathDate)}` : ""}
                      </div>
                    </button>
                  ))}
                  {peopleSorted.length === 0 && (
                    <div className="text-sm text-slate-600">Пока нет людей.</div>
                  )}
                </div>
              </div>

              {/* Roots quick view */}
              <div className="bg-white border border-slate-200 rounded-2xl p-4">
                <div className="font-semibold">Верхние в дереве (без родителей)</div>
                <div className="mt-2 flex flex-wrap gap-2">
                  {rootCandidates.map(p => (
                    <button
                      key={p.id}
                      onClick={() => setSelectedPersonId(p.id)}
                      className="px-3 py-1.5 rounded-full bg-slate-100 hover:bg-slate-200 text-sm"
                    >
                      {fullName(p)}
                    </button>
                  ))}
                  {rootCandidates.length === 0 && (
                    <div className="text-sm text-slate-600">Не найдено (возможно, у всех есть родители).</div>
                  )}
                </div>
              </div>

              {/* Admin tools */}
              {isAdmin && (
                <div className="bg-white border border-slate-200 rounded-2xl p-4 space-y-3">
                  <div className="font-semibold">Админ: сервис</div>
                  <div className="flex flex-wrap gap-2">
                    <button onClick={exportJson} className="px-3 py-1.5 rounded-lg bg-slate-900 text-white text-sm">
                      Экспорт JSON
                    </button>

                    <label className="px-3 py-1.5 rounded-lg bg-slate-100 border border-slate-200 text-sm cursor-pointer">
                      Импорт JSON
                      <input
                        type="file"
                        accept="application/json"
                        className="hidden"
                        onChange={(e) => {
                          const f = e.target.files?.[0];
                          if (f) importJsonFile(f);
                          e.target.value = "";
                        }}
                      />
                    </label>

                    <button onClick={resetToDefaults} className="px-3 py-1.5 rounded-lg bg-red-600 text-white text-sm">
                      Сброс к умолчанию
                    </button>
                  </div>

                  <div className="text-xs text-slate-600">
                    Экспорт/импорт — самый простой способ переносить данные между устройствами без сервера.
                  </div>
                </div>
              )}
            </div>

            {/* Right: person details */}
            <div className="lg:col-span-8 space-y-4">
              {!selectedPerson ? (
                <div className="bg-white border border-slate-200 rounded-2xl p-6">
                  <div className="text-lg font-semibold">Выбери человека слева</div>
                  <div className="mt-2 text-slate-600">
                    Гости могут оставлять комментарии. Редактирование доступно только в админ-режиме.
                  </div>
                </div>
              ) : (
                <>
                  <div className="bg-white border border-slate-200 rounded-2xl p-5">
                    <div className="flex items-start gap-3">
                      <div>
                        <div className="text-2xl font-semibold">{fullName(selectedPerson)}</div>
                        <div className="mt-1 text-sm text-slate-600">
                          Пол: {genderLabel(selectedPerson.gender)}{" "}
                          {selectedPerson.birthDate ? `• р. ${fmtDate(selectedPerson.birthDate)}` : ""}
                          {selectedPerson.deathDate ? ` • ум. ${fmtDate(selectedPerson.deathDate)}` : ""}
                        </div>
                      </div>

                      <div className="ml-auto flex gap-2">
                        {isAdmin && (
                          <>
                            <button
                              onClick={() => startEditPerson(selectedPerson)}
                              className="px-3 py-1.5 rounded-lg bg-indigo-600 text-white text-sm"
                            >
                              Редактировать
                            </button>
                            <button
                              onClick={() => deletePerson(selectedPerson.id)}
                              className="px-3 py-1.5 rounded-lg bg-red-600 text-white text-sm"
                            >
                              Удалить
                            </button>
                          </>
                        )}
                      </div>
                    </div>

                    {selectedPerson.notes?.trim() && (
                      <div className="mt-4">
                        <div className="text-sm font-semibold">Заметки</div>
                        <div className="mt-1 text-sm text-slate-700 whitespace-pre-wrap">{selectedPerson.notes}</div>
                      </div>
                    )}

                    <div className="mt-5 grid grid-cols-1 md:grid-cols-3 gap-3">
                      <div className="border border-slate-200 rounded-xl p-3">
                        <div className="text-sm font-semibold">Родители</div>
                        <div className="mt-2 space-y-1">
                          {getParents(selectedPerson.id).sort(sortByName).map(p => (
                            <button key={p.id} onClick={() => setSelectedPersonId(p.id)} className="block text-left text-sm text-indigo-700 hover:underline">
                              {fullName(p)}
                            </button>
                          ))}
                          {getParents(selectedPerson.id).length === 0 && <div className="text-sm text-slate-600">Нет данных</div>}
                        </div>
                      </div>

                      <div className="border border-slate-200 rounded-xl p-3">
                        <div className="text-sm font-semibold">Дети</div>
                        <div className="mt-2 space-y-1">
                          {getChildren(selectedPerson.id).sort(sortByName).map(p => (
                            <button key={p.id} onClick={() => setSelectedPersonId(p.id)} className="block text-left text-sm text-indigo-700 hover:underline">
                              {fullName(p)}
                            </button>
                          ))}
                          {getChildren(selectedPerson.id).length === 0 && <div className="text-sm text-slate-600">Нет данных</div>}
                        </div>
                      </div>

                      <div className="border border-slate-200 rounded-xl p-3">
                        <div className="text-sm font-semibold">Пары</div>
                        <div className="mt-2 space-y-2">
                          {getSpouses(selectedPerson.id).map(({ rel, person }) => (
                            <div key={rel.id} className="text-sm">
                              <button onClick={() => setSelectedPersonId(person.id)} className="text-indigo-700 hover:underline">
                                {fullName(person)}
                              </button>
                              <div className="text-xs text-slate-600 mt-0.5">
                                {rel.marriageDate ? `брак: ${fmtDate(rel.marriageDate)}` : "брак: дата не указана"}
                                {rel.divorceDate ? ` • развод: ${fmtDate(rel.divorceDate)}` : ""}
                              </div>
                              {isAdmin && (
                                <div className="mt-1">
                                  <button onClick={() => deleteRelationship(rel.id)} className="text-xs text-red-600 hover:underline">
                                    удалить связь
                                  </button>
                                </div>
                              )}
                            </div>
                          ))}
                          {getSpouses(selectedPerson.id).length === 0 && <div className="text-sm text-slate-600">Нет данных</div>}
                        </div>
                      </div>
                    </div>

                    <div className="mt-4 border border-slate-200 rounded-xl p-3">
                      <div className="text-sm font-semibold">Братья/сёстры (по общим родителям)</div>
                      <div className="mt-2 flex flex-wrap gap-2">
                        {getSiblings(selectedPerson.id).sort(sortByName).map(p => (
                          <button
                            key={p.id}
                            onClick={() => setSelectedPersonId(p.id)}
                            className="px-3 py-1.5 rounded-full bg-slate-100 hover:bg-slate-200 text-sm"
                          >
                            {fullName(p)}
                          </button>
                        ))}
                        {getSiblings(selectedPerson.id).length === 0 && (
                          <div className="text-sm text-slate-600">Нет данных</div>
                        )}
                      </div>
                    </div>
                  </div>

                  {/* Comments */}
                  <div className="bg-white border border-slate-200 rounded-2xl p-5">
                    <div className="flex items-center gap-2">
                      <div className="font-semibold">Комментарии</div>
                      <Pill>{selectedComments.length}</Pill>
                      <div className="ml-auto text-xs text-slate-600">
                        Видно всем • удалять может только админ
                      </div>
                    </div>

                    <div className="mt-3 grid grid-cols-1 md:grid-cols-12 gap-2">
                      <input
                        value={commentAuthor}
                        onChange={(e) => setCommentAuthor(e.target.value)}
                        placeholder="Имя (необязательно)"
                        className="md:col-span-4 border border-slate-300 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-200"
                      />
                      <div className="md:col-span-8 flex gap-2">
                        <input
                          value={newCommentText}
                          onChange={(e) => setNewCommentText(e.target.value)}
                          onKeyDown={(e) => { if (e.key === "Enter" && (e.ctrlKey || e.metaKey)) addComment(); }}
                          placeholder="Комментарий (Ctrl+Enter отправить)"
                          className="flex-1 border border-slate-300 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-200"
                        />
                        <button onClick={addComment} className="px-4 py-2 rounded-xl bg-indigo-600 text-white text-sm font-medium">
                          Отправить
                        </button>
                      </div>
                    </div>

                    <div className="mt-4 space-y-3">
                      {selectedComments.map(c => (
                        <div key={c.id} className="border border-slate-200 rounded-xl p-3">
                          <div className="flex items-center gap-2">
                            <div className="text-sm font-medium">{c.author || "Гость"}</div>
                            <div className="text-xs text-slate-500">{new Date(c.dateISO).toLocaleString("ru-RU")}</div>
                            {isAdmin && (
                              <button
                                onClick={() => deleteComment(c.id)}
                                className="ml-auto text-xs text-red-600 hover:underline"
                              >
                                удалить
                              </button>
                            )}
                          </div>
                          <div className="mt-2 text-sm text-slate-800 whitespace-pre-wrap">{c.text}</div>
                        </div>
                      ))}
                      {selectedComments.length === 0 && (
                        <div className="text-sm text-slate-600">Пока нет комментариев.</div>
                      )}
                    </div>
                  </div>

                  {/* Admin panels */}
                  {isAdmin && (
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                      {/* Person editor */}
                      <div className="bg-white border border-slate-200 rounded-2xl p-5">
                        <div className="flex items-center gap-2">
                          <div className="font-semibold">{personForm.id ? "Редактирование человека" : "Добавить человека"}</div>
                          {personForm.id ? <Pill>edit</Pill> : <Pill>new</Pill>}
                        </div>

                        <div className="mt-3 grid grid-cols-1 md:grid-cols-2 gap-2">
                          <input
                            value={personForm.lastName}
                            onChange={(e) => setPersonForm(f => ({ ...f, lastName: e.target.value }))}
                            placeholder="Фамилия"
                            className="border border-slate-300 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-200"
                          />
                          <input
                            value={personForm.firstName}
                            onChange={(e) => setPersonForm(f => ({ ...f, firstName: e.target.value }))}
                            placeholder="Имя"
                            className="border border-slate-300 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-200"
                          />

                          <select
                            value={personForm.gender}
                            onChange={(e) => setPersonForm(f => ({ ...f, gender: e.target.value }))}
                            className="border border-slate-300 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-200"
                          >
                            <option value="U">Пол: не указан</option>
                            <option value="M">М</option>
                            <option value="F">Ж</option>
                          </select>

                          <input
                            type="date"
                            value={personForm.birthDate}
                            onChange={(e) => setPersonForm(f => ({ ...f, birthDate: e.target.value }))}
                            className="border border-slate-300 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-200"
                            title="Дата рождения"
                          />

                          <input
                            type="date"
                            value={personForm.deathDate}
                            onChange={(e) => setPersonForm(f => ({ ...f, deathDate: e.target.value }))}
                            className="border border-slate-300 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-200"
                            title="Дата смерти (если есть)"
                          />

                          <textarea
                            value={personForm.notes}
                            onChange={(e) => setPersonForm(f => ({ ...f, notes: e.target.value }))}
                            placeholder="Заметки (необязательно)"
                            rows="3"
                            className="md:col-span-2 border border-slate-300 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-200"
                          />
                        </div>

                        <div className="mt-3 flex gap-2">
                          <button onClick={savePerson} className="px-4 py-2 rounded-xl bg-emerald-600 text-white text-sm font-medium">
                            Сохранить
                          </button>
                          <button onClick={startCreatePerson} className="px-4 py-2 rounded-xl bg-slate-100 border border-slate-200 text-sm">
                            Очистить форму
                          </button>
                          {selectedPerson && (
                            <button onClick={() => startEditPerson(selectedPerson)} className="px-4 py-2 rounded-xl bg-indigo-600 text-white text-sm">
                              В форму: выбранного
                            </button>
                          )}
                        </div>

                        <div className="mt-2 text-xs text-slate-600">
                          Совет: сначала добавь людей, потом связи.
                        </div>
                      </div>

                      {/* Relationships editor */}
                      <div className="bg-white border border-slate-200 rounded-2xl p-5 space-y-4">
                        <div>
                          <div className="font-semibold">Связи</div>
                          <div className="mt-2 text-xs text-slate-600">
                            Удаление связей доступно в карточке человека (пары) или в списке ниже (родитель-ребёнок).
                          </div>
                        </div>

                        {/* Marriage */}
                        <div className="border border-slate-200 rounded-xl p-3">
                          <div className="text-sm font-semibold">Добавить брак</div>
                          <div className="mt-2 grid grid-cols-1 md:grid-cols-2 gap-2">
                            <select
                              value={marriageForm.person1Id}
                              onChange={(e) => setMarriageForm(f => ({ ...f, person1Id: e.target.value }))}
                              className="border border-slate-300 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-200"
                            >
                              <option value="">Человек 1</option>
                              {peopleSorted.map(p => <option key={p.id} value={p.id}>{fullName(p)}</option>)}
                            </select>

                            <select
                              value={marriageForm.person2Id}
                              onChange={(e) => setMarriageForm(f => ({ ...f, person2Id: e.target.value }))}
                              className="border border-slate-300 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-200"
                            >
                              <option value="">Человек 2</option>
                              {peopleSorted.map(p => <option key={p.id} value={p.id}>{fullName(p)}</option>)}
                            </select>

                            <input
                              type="date"
                              value={marriageForm.marriageDate}
                              onChange={(e) => setMarriageForm(f => ({ ...f, marriageDate: e.target.value }))}
                              className="border border-slate-300 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-200"
                              title="Дата брака"
                            />

                            <input
                              type="date"
                              value={marriageForm.divorceDate}
                              onChange={(e) => setMarriageForm(f => ({ ...f, divorceDate: e.target.value }))}
                              className="border border-slate-300 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-200"
                              title="Дата развода (если есть)"
                            />
                          </div>
                          <button onClick={addMarriage} className="mt-2 px-4 py-2 rounded-xl bg-emerald-600 text-white text-sm font-medium">
                            Добавить брак
                          </button>
                        </div>

                        {/* Parent-child */}
                        <div className="border border-slate-200 rounded-xl p-3">
                          <div className="text-sm font-semibold">Добавить связь родитель-ребёнок</div>
                          <div className="mt-2 grid grid-cols-1 md:grid-cols-2 gap-2">
                            <select
                              value={pcForm.parentId}
                              onChange={(e) => setPcForm(f => ({ ...f, parentId: e.target.value }))}
                              className="border border-slate-300 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-200"
                            >
                              <option value="">Родитель</option>
                              {peopleSorted.map(p => <option key={p.id} value={p.id}>{fullName(p)}</option>)}
                            </select>

                            <select
                              value={pcForm.childId}
                              onChange={(e) => setPcForm(f => ({ ...f, childId: e.target.value }))}
                              className="border border-slate-300 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-200"
                            >
                              <option value="">Ребёнок</option>
                              {peopleSorted.map(p => <option key={p.id} value={p.id}>{fullName(p)}</option>)}
                            </select>
                          </div>
                          <button onClick={addParentChild} className="mt-2 px-4 py-2 rounded-xl bg-emerald-600 text-white text-sm font-medium">
                            Добавить связь
                          </button>
                        </div>

                        {/* Parent-child list */}
                        <div className="border border-slate-200 rounded-xl p-3">
                          <div className="text-sm font-semibold">Существующие родитель-ребёнок</div>
                          <div className="mt-2 max-h-48 overflow-auto space-y-2 pr-1">
                            {parentChildLinks.map(r => {
                              const parent = peopleById.get(r.parentId);
                              const child = peopleById.get(r.childId);
                              if (!parent || !child) return null;
                              return (
                                <div key={r.id} className="flex items-center gap-2 text-sm">
                                  <button onClick={() => setSelectedPersonId(parent.id)} className="text-indigo-700 hover:underline">{fullName(parent)}</button>
                                  <span className="text-slate-400">→</span>
                                  <button onClick={() => setSelectedPersonId(child.id)} className="text-indigo-700 hover:underline">{fullName(child)}</button>
                                  <button onClick={() => deleteRelationship(r.id)} className="ml-auto text-xs text-red-600 hover:underline">
                                    удалить
                                  </button>
                                </div>
                              );
                            })}
                            {parentChildLinks.length === 0 && <div className="text-sm text-slate-600">Пока нет связей.</div>}
                          </div>
                        </div>
                      </div>
                    </div>
                  )}
                </>
              )}

              {/* Footer note */}
              <div className="text-xs text-slate-500 px-1">
                Данные (люди/связи/комментарии) хранятся в localStorage этого браузера. Для общего доступа всем нужен сервер или облачная база.
              </div>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
