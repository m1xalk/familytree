<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–°–µ–º–µ–π–Ω–æ–µ –¥–µ—Ä–µ–≤–æ (–ø—Ä–æ—Å–º–æ—Ç—Ä + –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω)</title>

  <!-- React -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- Babel (—á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞–ª JSX –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-50 text-slate-900">
  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useState } = React;

    /********************
     * –ù–ê–°–¢–†–û–ô–ö–ò
     ********************/
    const ADMIN_PASSWORD = "1234"; // <-- –ø–æ–º–µ–Ω—è–π –ø–∞—Ä–æ–ª—å –∑–¥–µ—Å—å

    const LS_KEYS = {
      people: "ft_people_v1",
      relationships: "ft_relationships_v1",
      comments: "ft_comments_v1",
      adminSession: "ft_is_admin_session_v1" // sessionStorage
    };

    /********************
     * –î–ê–ù–ù–´–ï –ü–û –£–ú–û–õ–ß–ê–ù–ò–Æ
     * (–∑–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–∏)
     ********************/
    function TreeView({ people, relationships, selectedPersonId, onSelect }) {
  const peopleById = React.useMemo(() => {
    const m = new Map();
    for (const p of people) m.set(p.id, p);
    return m;
  }, [people]);

  const parentLinks = React.useMemo(
    () => relationships.filter(r => r.type === "parent-child"),
    [relationships]
  );

  const childrenOf = React.useCallback((pid) => {
    return parentLinks.filter(r => r.parentId === pid).map(r => r.childId);
  }, [parentLinks]);

  const parentsOf = React.useCallback((cid) => {
    return parentLinks.filter(r => r.childId === cid).map(r => r.parentId);
  }, [parentLinks]);

  const roots = React.useMemo(() => {
    const hasParent = new Set(parentLinks.map(r => r.childId));
    return people.filter(p => !hasParent.has(p.id)).map(p => p.id);
  }, [people, parentLinks]);

  // BFS –ø–æ —É—Ä–æ–≤–Ω—è–º (–ø–æ–∫–æ–ª–µ–Ω–∏—è)
  const levels = React.useMemo(() => {
    const visited = new Set();
    const lvlMap = new Map(); // id -> level
    const q = [];

    for (const rid of roots.length ? roots : people.map(p => p.id)) {
      lvlMap.set(rid, 0);
      q.push(rid);
    }

    while (q.length) {
      const id = q.shift();
      if (visited.has(id)) continue;
      visited.add(id);

      const L = lvlMap.get(id) ?? 0;
      for (const ch of childrenOf(id)) {
        const nextL = L + 1;
        if (!lvlMap.has(ch) || (lvlMap.get(ch) > nextL)) lvlMap.set(ch, nextL);
        q.push(ch);
      }
    }

    // —Å–æ–±—Ä–∞—Ç—å –º–∞—Å—Å–∏–≤ —É—Ä–æ–≤–Ω–µ–π
    const maxL = Math.max(0, ...Array.from(lvlMap.values()));
    const arr = Array.from({ length: maxL + 1 }, () => []);
    for (const p of people) {
      const L = lvlMap.get(p.id);
      if (L === undefined) continue;
      arr[L].push(p.id);
    }
    // —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –≤–Ω—É—Ç—Ä–∏ —É—Ä–æ–≤–Ω—è
    for (const row of arr) {
      row.sort((a, b) => {
        const pa = peopleById.get(a); const pb = peopleById.get(b);
        const an = ((pa?.lastName||"") + " " + (pa?.firstName||"")).toLowerCase();
        const bn = ((pb?.lastName||"") + " " + (pb?.firstName||"")).toLowerCase();
        return an.localeCompare(bn, "ru");
      });
    }
    return arr;
  }, [people, peopleById, roots, childrenOf]);

  // layout
  const NODE_W = 180;
  const NODE_H = 54;
  const GAP_X = 26;
  const GAP_Y = 44;
  const PAD = 30;

  const positions = React.useMemo(() => {
    const pos = new Map();
    levels.forEach((row, yIdx) => {
      row.forEach((id, xIdx) => {
        const x = PAD + xIdx * (NODE_W + GAP_X);
        const y = PAD + yIdx * (NODE_H + GAP_Y);
        pos.set(id, { x, y });
      });
    });
    return pos;
  }, [levels]);

  const size = React.useMemo(() => {
    const rows = levels.length;
    const cols = Math.max(1, ...levels.map(r => r.length));
    return {
      w: PAD * 2 + cols * NODE_W + (cols - 1) * GAP_X,
      h: PAD * 2 + rows * NODE_H + (rows - 1) * GAP_Y
    };
  }, [levels]);

  const lines = React.useMemo(() => {
    const out = [];
    for (const r of parentLinks) {
      const p = positions.get(r.parentId);
      const c = positions.get(r.childId);
      if (!p || !c) continue;
      const x1 = p.x + NODE_W / 2;
      const y1 = p.y + NODE_H;
      const x2 = c.x + NODE_W / 2;
      const y2 = c.y;
      // –ø–æ–ª–∏–ª–∏–Ω–∏—è: –≤–Ω–∏–∑, –ø–æ—Ç–æ–º –∫ —Ä–µ–±–µ–Ω–∫—É
      out.push({ id: r.id, x1, y1, x2, y2 });
    }
    return out;
  }, [parentLinks, positions]);

  const nameOf = (id) => {
    const p = peopleById.get(id);
    if (!p) return "(?)";
    const ln = (p.lastName || "").trim();
    const fn = (p.firstName || "").trim();
    return [ln, fn].filter(Boolean).join(" ").trim() || "(–±–µ–∑ –∏–º–µ–Ω–∏)";
  };

  return (
    <div className="bg-white border border-slate-200 rounded-2xl p-4 overflow-auto">
      <div className="text-sm text-slate-600 mb-2">
        üå≥ –°—Ö–µ–º–∞: —Ä–æ–¥–∏—Ç–µ–ª–∏ —Å–≤–µ—Ä—Ö—É, –¥–µ—Ç–∏ —Å–Ω–∏–∑—É. –ù–∞–∂–º–∏ –Ω–∞ —á–µ–ª–æ–≤–µ–∫–∞, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É.
      </div>

      <svg width={size.w} height={size.h} className="select-none">
        {/* –ª–∏–Ω–∏–∏ */}
        {lines.map(l => (
          <polyline
            key={l.id}
            points={`${l.x1},${l.y1} ${l.x1},${(l.y1+l.y2)/2} ${l.x2},${(l.y1+l.y2)/2} ${l.x2},${l.y2}`}
            fill="none"
            stroke="rgba(100,116,139,0.8)"
            strokeWidth="2"
          />
        ))}

        {/* –Ω–æ–¥—ã */}
        {Array.from(positions.entries()).map(([id, p]) => {
          const isSel = id === selectedPersonId;
          return (
            <g key={id} onClick={() => onSelect(id)} style={{ cursor: "pointer" }}>
              <rect
                x={p.x} y={p.y}
                width={NODE_W} height={NODE_H}
                rx="14"
                fill={isSel ? "rgba(99,102,241,0.14)" : "white"}
                stroke={isSel ? "rgba(99,102,241,0.9)" : "rgba(226,232,240,1)"}
                strokeWidth="2"
              />
              <text
                x={p.x + NODE_W / 2}
                y={p.y + 22}
                textAnchor="middle"
                fontSize="13"
                fill="rgba(15,23,42,1)"
              >
                {nameOf(id).slice(0, 24)}
              </text>
              <text
                x={p.x + NODE_W / 2}
                y={p.y + 42}
                textAnchor="middle"
                fontSize="11"
                fill="rgba(100,116,139,1)"
              >
                {parentsOf(id).length ? `—Ä–æ–¥–∏—Ç–µ–ª–µ–π: ${parentsOf(id).length}` : "–∫–æ—Ä–µ–Ω—å"}
              </text>
            </g>
          );
        })}
      </svg>
    </div>
  );
}

    const DEFAULT_PEOPLE = [
      { id: "p1", firstName: "–ò–≤–∞–Ω", lastName: "–ò–≤–∞–Ω–æ–≤", gender: "M", birthDate: "1960-01-01", deathDate: "", notes: "" },
      { id: "p2", firstName: "–ê–Ω–Ω–∞", lastName: "–ò–≤–∞–Ω–æ–≤–∞", gender: "F", birthDate: "1962-05-15", deathDate: "", notes: "" },
      { id: "p3", firstName: "–ü—ë—Ç—Ä", lastName: "–ò–≤–∞–Ω–æ–≤", gender: "M", birthDate: "1990-09-09", deathDate: "", notes: "" },
      { id: "p4", firstName: "–ú–∞—Ä–∏—è", lastName: "–°–º–∏—Ä–Ω–æ–≤–∞", gender: "F", birthDate: "1992-11-20", deathDate: "", notes: "" },
      { id: "p5", firstName: "–°–æ—Ñ–∏—è", lastName: "–ò–≤–∞–Ω–æ–≤–∞", gender: "F", birthDate: "2018-03-02", deathDate: "", notes: "" }
    ];

    // relationship types:
    // - marriage (—Å –¥–∞—Ç–∞–º–∏)
    // - parent-child
    const DEFAULT_RELATIONSHIPS = [
      { id: "r1", type: "marriage", person1Id: "p1", person2Id: "p2", marriageDate: "1985-07-01", divorceDate: "" },
      { id: "r2", type: "parent-child", parentId: "p1", childId: "p3" },
      { id: "r3", type: "parent-child", parentId: "p2", childId: "p3" },

      { id: "r4", type: "marriage", person1Id: "p3", person2Id: "p4", marriageDate: "2016-08-10", divorceDate: "" },
      { id: "r5", type: "parent-child", parentId: "p3", childId: "p5" },
      { id: "r6", type: "parent-child", parentId: "p4", childId: "p5" }
    ];

    const DEFAULT_COMMENTS = [
      // { id, personId, text, author, dateISO }
    ];

    /********************
     * –£–¢–ò–õ–ò–¢–´
     ********************/
    function safeJsonParse(v, fallback) {
      try { return JSON.parse(v); } catch { return fallback; }
    }

    function uid(prefix="id") {
      return prefix + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
    }

    function fmtDate(d) {
      if (!d) return "";
      try {
        const dt = new Date(d);
        if (Number.isNaN(dt.getTime())) return d;
        return dt.toLocaleDateString("ru-RU");
      } catch {
        return d;
      }
    }

    function fullName(p) {
      const ln = (p?.lastName || "").trim();
      const fn = (p?.firstName || "").trim();
      return [ln, fn].filter(Boolean).join(" ").trim() || "(–±–µ–∑ –∏–º–µ–Ω–∏)";
    }

    function genderLabel(g) {
      if (g === "M") return "–ú";
      if (g === "F") return "–ñ";
      return "‚Äî";
    }

    function sortByName(a, b) {
      const an = fullName(a).toLowerCase();
      const bn = fullName(b).toLowerCase();
      return an.localeCompare(bn, "ru");
    }

    /********************
     * –û–°–ù–û–í–ù–û–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–ï
     ********************/
    function App() {
      const [people, setPeople] = useState([]);
      const [relationships, setRelationships] = useState([]);
      const [comments, setComments] = useState([]);

      const [selectedPersonId, setSelectedPersonId] = useState(null);

      const [isAdmin, setIsAdmin] = useState(false);
      const [showLogin, setShowLogin] = useState(false);
      const [passwordInput, setPasswordInput] = useState("");

      const [toast, setToast] = useState("");

      // Admin forms
      const [personForm, setPersonForm] = useState({
        id: "",
        firstName: "",
        lastName: "",
        gender: "U",
        birthDate: "",
        deathDate: "",
        notes: ""
      });

      const [marriageForm, setMarriageForm] = useState({
        person1Id: "",
        person2Id: "",
        marriageDate: "",
        divorceDate: ""
      });

      const [pcForm, setPcForm] = useState({
        parentId: "",
        childId: ""
      });

      const selectedPerson = useMemo(() => people.find(p => p.id === selectedPersonId) || null, [people, selectedPersonId]);

      // init load
      useEffect(() => {
        const pRaw = localStorage.getItem(LS_KEYS.people);
        const rRaw = localStorage.getItem(LS_KEYS.relationships);
        const cRaw = localStorage.getItem(LS_KEYS.comments);

        const p = pRaw ? safeJsonParse(pRaw, DEFAULT_PEOPLE) : DEFAULT_PEOPLE;
        const r = rRaw ? safeJsonParse(rRaw, DEFAULT_RELATIONSHIPS) : DEFAULT_RELATIONSHIPS;
        const c = cRaw ? safeJsonParse(cRaw, DEFAULT_COMMENTS) : DEFAULT_COMMENTS;

        setPeople(Array.isArray(p) ? p : DEFAULT_PEOPLE);
        setRelationships(Array.isArray(r) ? r : DEFAULT_RELATIONSHIPS);
        setComments(Array.isArray(c) ? c : DEFAULT_COMMENTS);

        // restore admin session in this tab
        const adminFlag = sessionStorage.getItem(LS_KEYS.adminSession);
        setIsAdmin(adminFlag === "1");
      }, []);

      // persist
      useEffect(() => localStorage.setItem(LS_KEYS.people, JSON.stringify(people)), [people]);
      useEffect(() => localStorage.setItem(LS_KEYS.relationships, JSON.stringify(relationships)), [relationships]);
      useEffect(() => localStorage.setItem(LS_KEYS.comments, JSON.stringify(comments)), [comments]);

      // toast auto-hide
      useEffect(() => {
        if (!toast) return;
        const t = setTimeout(() => setToast(""), 2200);
        return () => clearTimeout(t);
      }, [toast]);

      const peopleById = useMemo(() => {
        const m = new Map();
        for (const p of people) m.set(p.id, p);
        return m;
      }, [people]);

      const marriages = useMemo(
        () => relationships.filter(r => r.type === "marriage"),
        [relationships]
      );

      const parentChildLinks = useMemo(
        () => relationships.filter(r => r.type === "parent-child"),
        [relationships]
      );

      function getSpouses(personId) {
        return marriages
          .filter(r => r.person1Id === personId || r.person2Id === personId)
          .map(r => {
            const otherId = r.person1Id === personId ? r.person2Id : r.person1Id;
            return { rel: r, person: peopleById.get(otherId) || null };
          })
          .filter(x => x.person);
      }

      function getParents(childId) {
        return parentChildLinks
          .filter(r => r.childId === childId)
          .map(r => peopleById.get(r.parentId))
          .filter(Boolean);
      }

      function getChildren(parentId) {
        return parentChildLinks
          .filter(r => r.parentId === parentId)
          .map(r => peopleById.get(r.childId))
          .filter(Boolean);
      }

      function getSiblings(personId) {
        const parents = getParents(personId).map(p => p.id);
        if (parents.length === 0) return [];
        const sibSet = new Map();
        for (const link of parentChildLinks) {
          if (parents.includes(link.parentId) && link.childId !== personId) {
            const sib = peopleById.get(link.childId);
            if (sib) sibSet.set(sib.id, sib);
          }
        }
        return Array.from(sibSet.values());
      }

      // --- Admin auth ---
      function login() {
        if (passwordInput === ADMIN_PASSWORD) {
          setIsAdmin(true);
          sessionStorage.setItem(LS_KEYS.adminSession, "1");
          setShowLogin(false);
          setPasswordInput("");
          setToast("–ê–¥–º–∏–Ω-—Ä–µ–∂–∏–º –≤–∫–ª—é—á—ë–Ω");
        } else {
          alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å");
        }
      }

      function logout() {
        setIsAdmin(false);
        sessionStorage.removeItem(LS_KEYS.adminSession);
        setToast("–ê–¥–º–∏–Ω-—Ä–µ–∂–∏–º –≤—ã–∫–ª—é—á–µ–Ω");
      }

      // --- Comments ---
      const [newCommentText, setNewCommentText] = useState("");
      const [commentAuthor, setCommentAuthor] = useState("");

      function addComment() {
        if (!selectedPerson) return;
        const text = newCommentText.trim();
        if (!text) return;

        const author = (commentAuthor.trim() || (isAdmin ? "–ê–¥–º–∏–Ω" : "–ì–æ—Å—Ç—å")).slice(0, 40);

        setComments(prev => [
          ...prev,
          {
            id: uid("c"),
            personId: selectedPerson.id,
            text,
            author,
            dateISO: new Date().toISOString()
          }
        ]);

        setNewCommentText("");
        setToast("–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–æ–±–∞–≤–ª–µ–Ω");
      }

      function deleteComment(commentId) {
        if (!isAdmin) return;
        if (!confirm("–£–¥–∞–ª–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π?")) return;
        setComments(prev => prev.filter(c => c.id !== commentId));
        setToast("–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —É–¥–∞–ª—ë–Ω");
      }

      // --- Admin: People CRUD ---
      function startCreatePerson() {
        if (!isAdmin) return;
        setPersonForm({
          id: "",
          firstName: "",
          lastName: "",
          gender: "U",
          birthDate: "",
          deathDate: "",
          notes: ""
        });
      }

      function startEditPerson(p) {
        if (!isAdmin || !p) return;
        setPersonForm({
          id: p.id,
          firstName: p.firstName || "",
          lastName: p.lastName || "",
          gender: p.gender || "U",
          birthDate: p.birthDate || "",
          deathDate: p.deathDate || "",
          notes: p.notes || ""
        });
      }

      function savePerson() {
        if (!isAdmin) return;

        const firstName = (personForm.firstName || "").trim();
        const lastName = (personForm.lastName || "").trim();
        const gender = personForm.gender || "U";

        if (!firstName && !lastName) {
          alert("–£–∫–∞–∂–∏ –∏–º—è –∏–ª–∏ —Ñ–∞–º–∏–ª–∏—é");
          return;
        }

        if (personForm.id) {
          // update
          setPeople(prev => prev.map(p => p.id === personForm.id ? { ...p, ...personForm, firstName, lastName, gender } : p));
          setToast("–ß–µ–ª–æ–≤–µ–∫ –æ–±–Ω–æ–≤–ª—ë–Ω");
        } else {
          // create
          const newId = uid("p");
          setPeople(prev => [...prev, { ...personForm, id: newId, firstName, lastName, gender }]);
          setToast("–ß–µ–ª–æ–≤–µ–∫ –¥–æ–±–∞–≤–ª–µ–Ω");
          setSelectedPersonId(newId);
        }

        // keep form as-is, but ensure id is set if newly created:
        if (!personForm.id) setPersonForm(f => ({ ...f, id: "" }));
      }

      function deletePerson(personId) {
        if (!isAdmin) return;
        const p = peopleById.get(personId);
        if (!p) return;
        if (!confirm(`–£–¥–∞–ª–∏—Ç—å "${fullName(p)}"? –¢–∞–∫–∂–µ —É–¥–∞–ª—è—Ç—Å—è –≤—Å–µ —Å–≤—è–∑–∏ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏.`)) return;

        setPeople(prev => prev.filter(x => x.id !== personId));
        setRelationships(prev => prev.filter(r => {
          if (r.type === "marriage") return r.person1Id !== personId && r.person2Id !== personId;
          if (r.type === "parent-child") return r.parentId !== personId && r.childId !== personId;
          return true;
        }));
        setComments(prev => prev.filter(c => c.personId !== personId));

        if (selectedPersonId === personId) setSelectedPersonId(null);
        setToast("–ß–µ–ª–æ–≤–µ–∫ —É–¥–∞–ª—ë–Ω");
      }

      // --- Admin: Relationships ---
      function addMarriage() {
        if (!isAdmin) return;
        const a = marriageForm.person1Id;
        const b = marriageForm.person2Id;
        if (!a || !b || a === b) {
          alert("–í—ã–±–µ—Ä–∏ –¥–≤—É—Ö —Ä–∞–∑–Ω—ã—Ö –ª—é–¥–µ–π");
          return;
        }
        // prevent duplicates
        const exists = marriages.some(r =>
          (r.person1Id === a && r.person2Id === b) || (r.person1Id === b && r.person2Id === a)
        );
        if (exists) {
          alert("–¢–∞–∫–æ–π –±—Ä–∞–∫ —É–∂–µ –µ—Å—Ç—å");
          return;
        }

        setRelationships(prev => [
          ...prev,
          {
            id: uid("r"),
            type: "marriage",
            person1Id: a,
            person2Id: b,
            marriageDate: marriageForm.marriageDate || "",
            divorceDate: marriageForm.divorceDate || ""
          }
        ]);

        setMarriageForm({ person1Id: "", person2Id: "", marriageDate: "", divorceDate: "" });
        setToast("–ë—Ä–∞–∫ –¥–æ–±–∞–≤–ª–µ–Ω");
      }

      function addParentChild() {
        if (!isAdmin) return;
        const parentId = pcForm.parentId;
        const childId = pcForm.childId;
        if (!parentId || !childId || parentId === childId) {
          alert("–í—ã–±–µ—Ä–∏ —Ä–æ–¥–∏—Ç–µ–ª—è –∏ —Ä–µ–±—ë–Ω–∫–∞ (—Ä–∞–∑–Ω—ã—Ö)");
          return;
        }

        const exists = parentChildLinks.some(r => r.parentId === parentId && r.childId === childId);
        if (exists) {
          alert("–¢–∞–∫–∞—è —Å–≤—è–∑—å —É–∂–µ –µ—Å—Ç—å");
          return;
        }

        setRelationships(prev => [...prev, { id: uid("r"), type: "parent-child", parentId, childId }]);
        setPcForm({ parentId: "", childId: "" });
        setToast("–°–≤—è–∑—å —Ä–æ–¥–∏—Ç–µ–ª—å-—Ä–µ–±—ë–Ω–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω–∞");
      }

      function deleteRelationship(relId) {
        if (!isAdmin) return;
        if (!confirm("–£–¥–∞–ª–∏—Ç—å —Å–≤—è–∑—å?")) return;
        setRelationships(prev => prev.filter(r => r.id !== relId));
        setToast("–°–≤—è–∑—å —É–¥–∞–ª–µ–Ω–∞");
      }

      // --- Export/Import ---
      function exportJson() {
        const payload = { people, relationships, comments, exportedAt: new Date().toISOString() };
        const text = JSON.stringify(payload, null, 2);
        const blob = new Blob([text], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "family-tree-export.json";
        a.click();
        URL.revokeObjectURL(url);
      }

      function importJsonFile(file) {
        if (!isAdmin) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const data = JSON.parse(reader.result);
            if (!data || !Array.isArray(data.people) || !Array.isArray(data.relationships) || !Array.isArray(data.comments)) {
              alert("–§–∞–π–ª –Ω–µ –ø–æ—Ö–æ–∂ –Ω–∞ —ç–∫—Å–ø–æ—Ä—Ç —ç—Ç–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è");
              return;
            }
            if (!confirm("–ó–∞–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ —Ñ–∞–π–ª–∞?")) return;
            setPeople(data.people);
            setRelationships(data.relationships);
            setComments(data.comments);
            setSelectedPersonId(null);
            setToast("–ò–º–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω");
          } catch {
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å JSON");
          }
        };
        reader.readAsText(file, "utf-8");
      }

      function resetToDefaults() {
        if (!isAdmin) return;
        if (!confirm("–°–±—Ä–æ—Å–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∫ –∑–Ω–∞—á–µ–Ω–∏—è–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é? (–ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç localStorage)")) return;
        setPeople(DEFAULT_PEOPLE);
        setRelationships(DEFAULT_RELATIONSHIPS);
        setComments(DEFAULT_COMMENTS);
        setSelectedPersonId(null);
        setToast("–°–±—Ä–æ—à–µ–Ω–æ –∫ —É–º–æ–ª—á–∞–Ω–∏—é");
      }

      // --- Lists for UI ---
      const peopleSorted = useMemo(() => [...people].sort(sortByName), [people]);

      const selectedComments = useMemo(() => {
        if (!selectedPerson) return [];
        return comments
          .filter(c => c.personId === selectedPerson.id)
          .slice()
          .sort((a, b) => (a.dateISO || "").localeCompare(b.dateISO || ""));
      }, [comments, selectedPerson]);

      // --- Derive "top" people (no parents) ---
      const rootCandidates = useMemo(() => {
        const hasParent = new Set(parentChildLinks.map(r => r.childId));
        return peopleSorted.filter(p => !hasParent.has(p.id));
      }, [peopleSorted, parentChildLinks]);

      // Render helpers
      function Pill({ children, className="" }) {
        return <span className={"inline-flex items-center rounded-full px-2 py-0.5 text-xs bg-slate-100 border border-slate-200 " + className}>{children}</span>;
      }

      return (
        <div className="min-h-screen">
          {/* Header */}
          <div className="sticky top-0 z-20 bg-white/85 backdrop-blur border-b border-slate-200">
            <div className="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
              <div className="font-semibold text-lg">–°–µ–º–µ–π–Ω–æ–µ –¥–µ—Ä–µ–≤–æ</div>
              <div className="text-sm text-slate-600">
                –ü—Ä–æ—Å–º–æ—Ç—Ä + –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –¥–ª—è –≥–æ—Å—Ç–µ–π, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω
              </div>
              <div className="ml-auto flex items-center gap-2">
                {isAdmin ? (
                  <>
                    <Pill className="bg-emerald-50 border-emerald-200 text-emerald-800">–ê–¥–º–∏–Ω</Pill>
                    <button onClick={logout} className="px-3 py-1.5 rounded-lg bg-slate-900 text-white text-sm">–í—ã–π—Ç–∏</button>
                  </>
                ) : (
                  <>
                    <Pill>–ì–æ—Å—Ç—å</Pill>
                    <button onClick={() => setShowLogin(true)} className="px-3 py-1.5 rounded-lg bg-indigo-600 text-white text-sm">–í–æ–π—Ç–∏ –∫–∞–∫ –∞–¥–º–∏–Ω</button>
                  </>
                )}
              </div>
            </div>
          </div>

          {/* Toast */}
          {toast && (
            <div className="fixed bottom-4 left-1/2 -translate-x-1/2 z-30">
              <div className="px-4 py-2 rounded-xl bg-slate-900 text-white text-sm shadow-lg">{toast}</div>
            </div>
          )}

          {/* Login modal */}
          {showLogin && (
            <div className="fixed inset-0 z-40 bg-black/40 flex items-center justify-center p-4">
              <div className="w-full max-w-sm bg-white rounded-2xl shadow-xl border border-slate-200 p-5">
                <div className="flex items-start gap-3">
                  <div className="font-semibold text-lg">–í—Ö–æ–¥ –∞–¥–º–∏–Ω–∞</div>
                  <button onClick={() => { setShowLogin(false); setPasswordInput(""); }} className="ml-auto text-slate-500 hover:text-slate-900">‚úï</button>
                </div>
                <div className="mt-3 text-sm text-slate-600">
                  –ü–∞—Ä–æ–ª—å –Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è. –ì–æ—Å—Ç–∏ –º–æ–≥—É—Ç —á–∏—Ç–∞—Ç—å –∏ –ø–∏—Å–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏.
                </div>
                <input
                  type="password"
                  value={passwordInput}
                  onChange={(e) => setPasswordInput(e.target.value)}
                  onKeyDown={(e) => { if (e.key === "Enter") login(); }}
                  placeholder="–ü–∞—Ä–æ–ª—å"
                  className="mt-4 w-full border border-slate-300 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-200"
                />
                <button
                  onClick={login}
                  className="mt-3 w-full px-4 py-2 rounded-xl bg-indigo-600 text-white font-medium"
                >
                  –í–æ–π—Ç–∏
                </button>
              </div>
            </div>
          )}

          {/* Main layout */}
          <div className="max-w-6xl mx-auto px-4 py-5 grid grid-cols-1 lg:grid-cols-12 gap-4">
            {/* Left: people list */}
            <div className="lg:col-span-4 space-y-3">
              <div className="bg-white border border-slate-200 rounded-2xl p-4">
                <div className="flex items-center gap-2">
                  <div className="font-semibold">–õ—é–¥–∏</div>
                  <Pill>{people.length}</Pill>
                  <div className="ml-auto flex items-center gap-2">
                    {isAdmin && (
                      <button
                        onClick={startCreatePerson}
                        className="px-3 py-1.5 rounded-lg bg-emerald-600 text-white text-sm"
                      >
                        + –î–æ–±–∞–≤–∏—Ç—å
                      </button>
                    )}
                  </div>
                </div>

                <div className="mt-3 max-h-[55vh] overflow-auto pr-1 space-y-2">
                  {peopleSorted.map(p => (
                    <button
                      key={p.id}
                      onClick={() => setSelectedPersonId(p.id)}
                      className={
                        "w-full text-left p-3 rounded-xl border transition " +
                        (selectedPersonId === p.id
                          ? "bg-indigo-50 border-indigo-200"
                          : "bg-white border-slate-200 hover:bg-slate-50")
                      }
                    >
                      <div className="flex items-center gap-2">
                        <div className="font-medium">{fullName(p)}</div>
                        <Pill className="ml-auto">{genderLabel(p.gender)}</Pill>
                      </div>
                      <div className="mt-1 text-xs text-slate-600">
                        {p.birthDate ? `—Ä. ${fmtDate(p.birthDate)}` : "–¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω–∞"}
                        {p.deathDate ? ` ‚Ä¢ —É–º. ${fmtDate(p.deathDate)}` : ""}
                      </div>
                    </button>
                  ))}
                  {peopleSorted.length === 0 && (
                    <div className="text-sm text-slate-600">–ü–æ–∫–∞ –Ω–µ—Ç –ª—é–¥–µ–π.</div>
                  )}
                </div>
              </div>

              {/* Roots quick view */}
              <div className="bg-white border border-slate-200 rounded-2xl p-4">
                <div className="font-semibold">–í–µ—Ä—Ö–Ω–∏–µ –≤ –¥–µ—Ä–µ–≤–µ (–±–µ–∑ —Ä–æ–¥–∏—Ç–µ–ª–µ–π)</div>
                <div className="mt-2 flex flex-wrap gap-2">
                  {rootCandidates.map(p => (
                    <button
                      key={p.id}
                      onClick={() => setSelectedPersonId(p.id)}
                      className="px-3 py-1.5 rounded-full bg-slate-100 hover:bg-slate-200 text-sm"
                    >
                      {fullName(p)}
                    </button>
                  ))}
                  {rootCandidates.length === 0 && (
                    <div className="text-sm text-slate-600">–ù–µ –Ω–∞–π–¥–µ–Ω–æ (–≤–æ–∑–º–æ–∂–Ω–æ, —É –≤—Å–µ—Ö –µ—Å—Ç—å —Ä–æ–¥–∏—Ç–µ–ª–∏).</div>
                  )}
                </div>
              </div>

              {/* Admin tools */}
              {isAdmin && (
                <div className="bg-white border border-slate-200 rounded-2xl p-4 space-y-3">
                  <div className="font-semibold">–ê–¥–º–∏–Ω: —Å–µ—Ä–≤–∏—Å</div>
                  <div className="flex flex-wrap gap-2">
                    <button onClick={exportJson} className="px-3 py-1.5 rounded-lg bg-slate-900 text-white text-sm">
                      –≠–∫—Å–ø–æ—Ä—Ç JSON
                    </button>

                    <label className="px-3 py-1.5 rounded-lg bg-slate-100 border border-slate-200 text-sm cursor-pointer">
                      –ò–º–ø–æ—Ä—Ç JSON
                      <input
                        type="file"
                        accept="application/json"
                        className="hidden"
                        onChange={(e) => {
                          const f = e.target.files?.[0];
                          if (f) importJsonFile(f);
                          e.target.value = "";
                        }}
                      />
                    </label>

                    <button onClick={resetToDefaults} className="px-3 py-1.5 rounded-lg bg-red-600 text-white text-sm">
                      –°–±—Ä–æ—Å –∫ —É–º–æ–ª—á–∞–Ω–∏—é
                    </button>
                  </div>

                  <div className="text-xs text-slate-600">
                    –≠–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç ‚Äî —Å–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ –±–µ–∑ —Å–µ—Ä–≤–µ—Ä–∞.
                  </div>
                </div>
              )}
            </div>

            {/* Right: person details */}
            <div className="lg:col-span-8 space-y-4">
              {!selectedPerson ? (
                <div className="bg-white border border-slate-200 rounded-2xl p-6">
                  <div className="text-lg font-semibold">–í—ã–±–µ—Ä–∏ —á–µ–ª–æ–≤–µ–∫–∞ —Å–ª–µ–≤–∞</div>
                  <div className="mt-2 text-slate-600">
                    –ì–æ—Å—Ç–∏ –º–æ–≥—É—Ç –æ—Å—Ç–∞–≤–ª—è—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏. –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –≤ –∞–¥–º–∏–Ω-—Ä–µ–∂–∏–º–µ.
                  </div>
                </div>
              ) : (
                <>
                  <div className="bg-white border border-slate-200 rounded-2xl p-5">
                    <div className="flex items-start gap-3">
                      <div>
                        <div className="text-2xl font-semibold">{fullName(selectedPerson)}</div>
                        <div className="mt-1 text-sm text-slate-600">
                          –ü–æ–ª: {genderLabel(selectedPerson.gender)}{" "}
                          {selectedPerson.birthDate ? `‚Ä¢ —Ä. ${fmtDate(selectedPerson.birthDate)}` : ""}
                          {selectedPerson.deathDate ? ` ‚Ä¢ —É–º. ${fmtDate(selectedPerson.deathDate)}` : ""}
                        </div>
                      </div>

                      <div className="ml-auto flex gap-2">
                        {isAdmin && (
                          <>
                            <button
                              onClick={() => startEditPerson(selectedPerson)}
                              className="px-3 py-1.5 rounded-lg bg-indigo-600 text-white text-sm"
                            >
                              –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                            </button>
                            <button
                              onClick={() => deletePerson(selectedPerson.id)}
                              className="px-3 py-1.5 rounded-lg bg-red-600 text-white text-sm"
                            >
                              –£–¥–∞–ª–∏—Ç—å
                            </button>
                          </>
                        )}
                      </div>
                    </div>

                    {selectedPerson.notes?.trim() && (
                      <div className="mt-4">
                        <div className="text-sm font-semibold">–ó–∞–º–µ—Ç–∫–∏</div>
                        <div className="mt-1 text-sm text-slate-700 whitespace-pre-wrap">{selectedPerson.notes}</div>
                      </div>
                    )}

                    <div className="mt-5 grid grid-cols-1 md:grid-cols-3 gap-3">
                      <div className="border border-slate-200 rounded-xl p-3">
                        <div className="text-sm font-semibold">–†–æ–¥–∏—Ç–µ–ª–∏</div>
                        <div className="mt-2 space-y-1">
                          {getParents(selectedPerson.id).sort(sortByName).map(p => (
                            <button key={p.id} onClick={() => setSelectedPersonId(p.id)} className="block text-left text-sm text-indigo-700 hover:underline">
                              {fullName(p)}
                            </button>
                          ))}
                          {getParents(selectedPerson.id).length === 0 && <div className="text-sm text-slate-600">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>}
                        </div>
                      </div>

                      <div className="border border-slate-200 rounded-xl p-3">
                        <div className="text-sm font-semibold">–î–µ—Ç–∏</div>
                        <div className="mt-2 space-y-1">
                          {getChildren(selectedPerson.id).sort(sortByName).map(p => (
                            <button key={p.id} onClick={() => setSelectedPersonId(p.id)} className="block text-left text-sm text-indigo-700 hover:underline">
                              {fullName(p)}
                            </button>
                          ))}
                          {getChildren(selectedPerson.id).length === 0 && <div className="text-sm text-slate-600">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>}
                        </div>
                      </div>

                      <div className="border border-slate-200 rounded-xl p-3">
                        <div className="text-sm font-semibold">–ü–∞—Ä—ã</div>
                        <div className="mt-2 space-y-2">
                          {getSpouses(selectedPerson.id).map(({ rel, person }) => (
                            <div key={rel.id} className="text-sm">
                              <button onClick={() => setSelectedPersonId(person.id)} className="text-indigo-700 hover:underline">
                                {fullName(person)}
                              </button>
                              <div className="text-xs text-slate-600 mt-0.5">
                                {rel.marriageDate ? `–±—Ä–∞–∫: ${fmtDate(rel.marriageDate)}` : "–±—Ä–∞–∫: –¥–∞—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞"}
                                {rel.divorceDate ? ` ‚Ä¢ —Ä–∞–∑–≤–æ–¥: ${fmtDate(rel.divorceDate)}` : ""}
                              </div>
                              {isAdmin && (
                                <div className="mt-1">
                                  <button onClick={() => deleteRelationship(rel.id)} className="text-xs text-red-600 hover:underline">
                                    —É–¥–∞–ª–∏—Ç—å —Å–≤—è–∑—å
                                  </button>
                                </div>
                              )}
                            </div>
                          ))}
                          {getSpouses(selectedPerson.id).length === 0 && <div className="text-sm text-slate-600">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>}
                        </div>
                      </div>
                    </div>

                    <div className="mt-4 border border-slate-200 rounded-xl p-3">
                      <div className="text-sm font-semibold">–ë—Ä–∞—Ç—å—è/—Å—ë—Å—Ç—Ä—ã (–ø–æ –æ–±—â–∏–º —Ä–æ–¥–∏—Ç–µ–ª—è–º)</div>
                      <div className="mt-2 flex flex-wrap gap-2">
                        {getSiblings(selectedPerson.id).sort(sortByName).map(p => (
                          <button
                            key={p.id}
                            onClick={() => setSelectedPersonId(p.id)}
                            className="px-3 py-1.5 rounded-full bg-slate-100 hover:bg-slate-200 text-sm"
                          >
                            {fullName(p)}
                          </button>
                        ))}
                        {getSiblings(selectedPerson.id).length === 0 && (
                          <div className="text-sm text-slate-600">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
                        )}
                      </div>
                    </div>
                  </div>

                  {/* Comments */}
                  <div className="bg-white border border-slate-200 rounded-2xl p-5">
                    <div className="flex items-center gap-2">
                      <div className="font-semibold">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</div>
                      <Pill>{selectedComments.length}</Pill>
                      <div className="ml-auto text-xs text-slate-600">
                        –í–∏–¥–Ω–æ –≤—Å–µ–º ‚Ä¢ —É–¥–∞–ª—è—Ç—å –º–æ–∂–µ—Ç —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω
                      </div>
                    </div>

                    <div className="mt-3 grid grid-cols-1 md:grid-cols-12 gap-2">
                      <input
                        value={commentAuthor}
                        onChange={(e) => setCommentAuthor(e.target.value)}
                        placeholder="–ò–º—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"
                        className="md:col-span-4 border border-slate-300 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-200"
                      />
                      <div className="md:col-span-8 flex gap-2">
                        <input
                          value={newCommentText}
                          onChange={(e) => setNewCommentText(e.target.value)}
                          onKeyDown={(e) => { if (e.key === "Enter" && (e.ctrlKey || e.metaKey)) addComment(); }}
                          placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (Ctrl+Enter –æ—Ç–ø—Ä–∞–≤–∏—Ç—å)"
                          className="flex-1 border border-slate-300 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-200"
                        />
                        <button onClick={addComment} className="px-4 py-2 rounded-xl bg-indigo-600 text-white text-sm font-medium">
                          –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                        </button>
                      </div>
                    </div>

                    <div className="mt-4 space-y-3">
                      {selectedComments.map(c => (
                        <div key={c.id} className="border border-slate-200 rounded-xl p-3">
                          <div className="flex items-center gap-2">
                            <div className="text-sm font-medium">{c.author || "–ì–æ—Å—Ç—å"}</div>
                            <div className="text-xs text-slate-500">{new Date(c.dateISO).toLocaleString("ru-RU")}</div>
                            {isAdmin && (
                              <button
                                onClick={() => deleteComment(c.id)}
                                className="ml-auto text-xs text-red-600 hover:underline"
                              >
                                —É–¥–∞–ª–∏—Ç—å
                              </button>
                            )}
                          </div>
                          <div className="mt-2 text-sm text-slate-800 whitespace-pre-wrap">{c.text}</div>
                        </div>
                      ))}
                      {selectedComments.length === 0 && (
                        <div className="text-sm text-slate-600">–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.</div>
                      )}
                    </div>
                  </div>

                  {/* Admin panels */}
                  {isAdmin && (
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                      {/* Person editor */}
                      <div className="bg-white border border-slate-200 rounded-2xl p-5">
                        <div className="flex items-center gap-2">
                          <div className="font-semibold">{personForm.id ? "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ–ª–æ–≤–µ–∫–∞" : "–î–æ–±–∞–≤–∏—Ç—å —á–µ–ª–æ–≤–µ–∫–∞"}</div>
                          {personForm.id ? <Pill>edit</Pill> : <Pill>new</Pill>}
                        </div>

                        <div className="mt-3 grid grid-cols-1 md:grid-cols-2 gap-2">
                          <input
                            value={personForm.lastName}
                            onChange={(e) => setPersonForm(f => ({ ...f, lastName: e.target.value }))}
                            placeholder="–§–∞–º–∏–ª–∏—è"
                            className="border border-slate-300 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-200"
                          />
                          <input
                            value={personForm.firstName}
                            onChange={(e) => setPersonForm(f => ({ ...f, firstName: e.target.value }))}
                            placeholder="–ò–º—è"
                            className="border border-slate-300 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-200"
                          />

                          <select
                            value={personForm.gender}
                            onChange={(e) => setPersonForm(f => ({ ...f, gender: e.target.value }))}
                            className="border border-slate-300 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-200"
                          >
                            <option value="U">–ü–æ–ª: –Ω–µ —É–∫–∞–∑–∞–Ω</option>
                            <option value="M">–ú</option>
                            <option value="F">–ñ</option>
                          </select>

                          <input
                            type="date"
                            value={personForm.birthDate}
                            onChange={(e) => setPersonForm(f => ({ ...f, birthDate: e.target.value }))}
                            className="border border-slate-300 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-200"
                            title="–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è"
                          />

                          <input
                            type="date"
                            value={personForm.deathDate}
                            onChange={(e) => setPersonForm(f => ({ ...f, deathDate: e.target.value }))}
                            className="border border-slate-300 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-200"
                            title="–î–∞—Ç–∞ —Å–º–µ—Ä—Ç–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)"
                          />

                          <textarea
                            value={personForm.notes}
                            onChange={(e) => setPersonForm(f => ({ ...f, notes: e.target.value }))}
                            placeholder="–ó–∞–º–µ—Ç–∫–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"
                            rows="3"
                            className="md:col-span-2 border border-slate-300 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-200"
                          />
                        </div>

                        <div className="mt-3 flex gap-2">
                          <button onClick={savePerson} className="px-4 py-2 rounded-xl bg-emerald-600 text-white text-sm font-medium">
                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                          </button>
                          <button onClick={startCreatePerson} className="px-4 py-2 rounded-xl bg-slate-100 border border-slate-200 text-sm">
                            –û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É
                          </button>
                          {selectedPerson && (
                            <button onClick={() => startEditPerson(selectedPerson)} className="px-4 py-2 rounded-xl bg-indigo-600 text-white text-sm">
                              –í —Ñ–æ—Ä–º—É: –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ
                            </button>
                          )}
                        </div>

                        <div className="mt-2 text-xs text-slate-600">
                          –°–æ–≤–µ—Ç: —Å–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å –ª—é–¥–µ–π, –ø–æ—Ç–æ–º —Å–≤—è–∑–∏.
                        </div>
                      </div>

                      {/* Relationships editor */}
                      <div className="bg-white border border-slate-200 rounded-2xl p-5 space-y-4">
                        <div>
                          <div className="font-semibold">–°–≤—è–∑–∏</div>
                          <div className="mt-2 text-xs text-slate-600">
                            –£–¥–∞–ª–µ–Ω–∏–µ —Å–≤—è–∑–µ–π –¥–æ—Å—Ç—É–ø–Ω–æ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ —á–µ–ª–æ–≤–µ–∫–∞ (–ø–∞—Ä—ã) –∏–ª–∏ –≤ —Å–ø–∏—Å–∫–µ –Ω–∏–∂–µ (—Ä–æ–¥–∏—Ç–µ–ª—å-—Ä–µ–±—ë–Ω–æ–∫).
                          </div>
                        </div>

                        {/* Marriage */}
                        <div className="border border-slate-200 rounded-xl p-3">
                          <div className="text-sm font-semibold">–î–æ–±–∞–≤–∏—Ç—å –±—Ä–∞–∫</div>
                          <div className="mt-2 grid grid-cols-1 md:grid-cols-2 gap-2">
                            <select
                              value={marriageForm.person1Id}
                              onChange={(e) => setMarriageForm(f => ({ ...f, person1Id: e.target.value }))}
                              className="border border-slate-300 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-200"
                            >
                              <option value="">–ß–µ–ª–æ–≤–µ–∫ 1</option>
                              {peopleSorted.map(p => <option key={p.id} value={p.id}>{fullName(p)}</option>)}
                            </select>

                            <select
                              value={marriageForm.person2Id}
                              onChange={(e) => setMarriageForm(f => ({ ...f, person2Id: e.target.value }))}
                              className="border border-slate-300 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-200"
                            >
                              <option value="">–ß–µ–ª–æ–≤–µ–∫ 2</option>
                              {peopleSorted.map(p => <option key={p.id} value={p.id}>{fullName(p)}</option>)}
                            </select>

                            <input
                              type="date"
                              value={marriageForm.marriageDate}
                              onChange={(e) => setMarriageForm(f => ({ ...f, marriageDate: e.target.value }))}
                              className="border border-slate-300 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-200"
                              title="–î–∞—Ç–∞ –±—Ä–∞–∫–∞"
                            />

                            <input
                              type="date"
                              value={marriageForm.divorceDate}
                              onChange={(e) => setMarriageForm(f => ({ ...f, divorceDate: e.target.value }))}
                              className="border border-slate-300 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-200"
                              title="–î–∞—Ç–∞ —Ä–∞–∑–≤–æ–¥–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)"
                            />
                          </div>
                          <button onClick={addMarriage} className="mt-2 px-4 py-2 rounded-xl bg-emerald-600 text-white text-sm font-medium">
                            –î–æ–±–∞–≤–∏—Ç—å –±—Ä–∞–∫
                          </button>
                        </div>

                        {/* Parent-child */}
                        <div className="border border-slate-200 rounded-xl p-3">
                          <div className="text-sm font-semibold">–î–æ–±–∞–≤–∏—Ç—å —Å–≤—è–∑—å —Ä–æ–¥–∏—Ç–µ–ª—å-—Ä–µ–±—ë–Ω–æ–∫</div>
                          <div className="mt-2 grid grid-cols-1 md:grid-cols-2 gap-2">
                            <select
                              value={pcForm.parentId}
                              onChange={(e) => setPcForm(f => ({ ...f, parentId: e.target.value }))}
                              className="border border-slate-300 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-200"
                            >
                              <option value="">–†–æ–¥–∏—Ç–µ–ª—å</option>
                              {peopleSorted.map(p => <option key={p.id} value={p.id}>{fullName(p)}</option>)}
                            </select>

                            <select
                              value={pcForm.childId}
                              onChange={(e) => setPcForm(f => ({ ...f, childId: e.target.value }))}
                              className="border border-slate-300 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-200"
                            >
                              <option value="">–†–µ–±—ë–Ω–æ–∫</option>
                              {peopleSorted.map(p => <option key={p.id} value={p.id}>{fullName(p)}</option>)}
                            </select>
                          </div>
                          <button onClick={addParentChild} className="mt-2 px-4 py-2 rounded-xl bg-emerald-600 text-white text-sm font-medium">
                            –î–æ–±–∞–≤–∏—Ç—å —Å–≤—è–∑—å
                          </button>
                        </div>

                        {/* Parent-child list */}
                        <div className="border border-slate-200 rounded-xl p-3">
                          <div className="text-sm font-semibold">–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ä–æ–¥–∏—Ç–µ–ª—å-—Ä–µ–±—ë–Ω–æ–∫</div>
                          <div className="mt-2 max-h-48 overflow-auto space-y-2 pr-1">
                            {parentChildLinks.map(r => {
                              const parent = peopleById.get(r.parentId);
                              const child = peopleById.get(r.childId);
                              if (!parent || !child) return null;
                              return (
                                <div key={r.id} className="flex items-center gap-2 text-sm">
                                  <button onClick={() => setSelectedPersonId(parent.id)} className="text-indigo-700 hover:underline">{fullName(parent)}</button>
                                  <span className="text-slate-400">‚Üí</span>
                                  <button onClick={() => setSelectedPersonId(child.id)} className="text-indigo-700 hover:underline">{fullName(child)}</button>
                                  <button onClick={() => deleteRelationship(r.id)} className="ml-auto text-xs text-red-600 hover:underline">
                                    —É–¥–∞–ª–∏—Ç—å
                                  </button>
                                </div>
                              );
                            })}
                            {parentChildLinks.length === 0 && <div className="text-sm text-slate-600">–ü–æ–∫–∞ –Ω–µ—Ç —Å–≤—è–∑–µ–π.</div>}
                          </div>
                        </div>
                      </div>
                    </div>
                  )}
                </>
              )}

              {/* Footer note */}
              <div className="text-xs text-slate-500 px-1">
                –î–∞–Ω–Ω—ã–µ (–ª—é–¥–∏/—Å–≤—è–∑–∏/–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏) —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ localStorage —ç—Ç–æ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞. –î–ª—è –æ–±—â–µ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –≤—Å–µ–º –Ω—É–∂–µ–Ω —Å–µ—Ä–≤–µ—Ä –∏–ª–∏ –æ–±–ª–∞—á–Ω–∞—è –±–∞–∑–∞.
              </div>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>

