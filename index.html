<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–†–æ–¥–æ—Å–ª–æ–≤–Ω–æ–µ –¥–µ—Ä–µ–≤–æ (–ì—Ä–∞—Ñ + –î–µ—Ä–µ–≤–æ)</title>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script src="https://cdn.tailwindcss.com"></script>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

  <style>
    /* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ç–∞—Ä–æ–≥–æ –î–µ—Ä–µ–≤–∞ */
    .rootTree { padding-top: 0; margin-top: 0; }
    .tree { padding: 12px; overflow: auto; }
    .tree ul { padding-top: 24px; position: relative; transition: all 0.5s; display: flex; justify-content: center; }
    .tree li { float: left; text-align: center; list-style-type: none; position: relative; padding: 24px 6px 0 6px; transition: all 0.5s; }
    .tree li::before, .tree li::after {
      content: ''; position: absolute; top: 0; right: 50%; border-top: 2px solid #ccc;
      width: 50%; height: 24px;
    }
    .tree li::after { right: auto; left: 50%; border-left: 2px solid #ccc; }
    .tree li:only-child::after, .tree li:only-child::before { display: none; }
    .tree li:only-child { padding-top: 0; }
    .tree li:first-child::before, .tree li:last-child::after { border: 0 none; }
    .tree li:last-child::before { border-right: 2px solid #ccc; border-radius: 0 5px 0 0; }
    .tree li:first-child::after { border-radius: 5px 0 0 0; }
    .tree ul ul::before {
      content: ''; position: absolute; top: 0; left: 50%; border-left: 2px solid #ccc;
      width: 0; height: 24px;
    }
    
    /* –°–∫—Ä–æ–ª–ª–±–∞—Ä—ã */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #999; }
  </style>
</head>
<body class="bg-slate-100 text-slate-900 h-screen flex flex-col overflow-hidden">

  <div id="root" class="h-full flex flex-col"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef, useCallback, useLayoutEffect } = React;

    // --- FIREBASE CONFIG (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏) ---
    const firebaseConfig = {
      apiKey: "API_KEY",
      authDomain: "PROJECT_ID.firebaseapp.com",
      projectId: "PROJECT_ID",
      storageBucket: "PROJECT_ID.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (–∑–∞–≥–ª—É—à–∫–∞, —á—Ç–æ–±—ã –Ω–µ –ø–∞–¥–∞–ª–æ, –µ—Å–ª–∏ –Ω–µ—Ç –∫–ª—é—á–µ–π)
    if (firebaseConfig.apiKey !== "API_KEY") {
      firebase.initializeApp(firebaseConfig);
    } else {
      console.warn("Firebase config not set. Using local state only.");
    }
    // const db = firebase.firestore(); // —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –µ—Å–ª–∏ –µ—Å—Ç—å –∫–æ–Ω—Ñ–∏–≥

    // --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ---
    function generateId() {
      return Math.random().toString(36).substr(2, 9);
    }

    // --- –ö–û–ú–ü–û–ù–ï–ù–¢: GraphView (–°–ï–¢–ö–ê –ü–û–ö–û–õ–ï–ù–ò–ô –ë–ï–ó –î–£–ë–õ–ï–ô) ---
    const FamilyGraph = ({ people, couples, onEdit, onAddRelative }) => {
      const [generations, setGenerations] = useState([]);
      const [lines, setLines] = useState([]);
      const containerRef = useRef(null);
      const [dims, setDims] = useState({ w: 2000, h: 2000 });

      // 1. –†–∞—Å—á–µ—Ç –ø–æ–∫–æ–ª–µ–Ω–∏–π
      useEffect(() => {
        if (!people.length) {
            setGenerations([]);
            return;
        }

        // –ö–∞—Ä—Ç–∞: childId -> [parent1Id, parent2Id]
        const childToParents = {};
        couples.forEach(c => {
          (c.childrenIds || []).forEach(childId => {
             if(!childToParents[childId]) childToParents[childId] = [];
             childToParents[childId].push(c.partner1Id, c.partner2Id);
          });
        });

        const genMap = {}; // id -> generationIndex

        // –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –≤—ã—á–∏—Å–ª—è–µ–º –ø–æ–∫–æ–ª–µ–Ω–∏–µ
        const getGen = (id, visited = []) => {
          if (visited.includes(id)) return 0; // –∑–∞—â–∏—Ç–∞ –æ—Ç —Ü–∏–∫–ª–æ–≤
          if (genMap[id] !== undefined) return genMap[id];
          
          const parents = childToParents[id] || [];
          if (parents.length === 0) {
            genMap[id] = 0;
            return 0;
          }

          let maxParentGen = -1;
          parents.forEach(pid => {
             // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ç–∞–∫–æ–π —Ä–æ–¥–∏—Ç–µ–ª—å –≤–æ–æ–±—â–µ
             if (people.find(p => p.id === pid)) {
               const g = getGen(pid, [...visited, id]);
               if (g > maxParentGen) maxParentGen = g;
             }
          });
          
          // –ü–æ–∫–æ–ª–µ–Ω–∏–µ —Ä–µ–±–µ–Ω–∫–∞ = (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –ø–æ–∫–æ–ª–µ–Ω–∏–µ —Ä–æ–¥–∏—Ç–µ–ª–µ–π) + 1
          const myGen = maxParentGen + 1;
          genMap[id] = myGen;
          return myGen;
        };

        people.forEach(p => getGen(p.id));

        // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è (—Å–¥–≤–∏–≥–∞–µ–º, —á—Ç–æ–±—ã –º–∏–Ω –±—ã–ª–æ 0)
        const vals = Object.values(genMap);
        const minGen = vals.length ? Math.min(...vals) : 0;
        
        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ª—é–¥–µ–π –ø–æ –º–∞—Å—Å–∏–≤–∞–º –ø–æ–∫–æ–ª–µ–Ω–∏–π
        const genGroups = {};
        people.forEach(p => {
          const rawGen = genMap[p.id] !== undefined ? genMap[p.id] : 0;
          const finalGen = rawGen - minGen;
          if (!genGroups[finalGen]) genGroups[finalGen] = [];
          genGroups[finalGen].push(p);
        });

        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –≤–Ω—É—Ç—Ä–∏ –ø–æ–∫–æ–ª–µ–Ω–∏—è: –ø—ã—Ç–∞–µ–º—Å—è –¥–µ—Ä–∂–∞—Ç—å —Å—É–ø—Ä—É–≥–æ–≤ —Ä—è–¥–æ–º
        const sortedGens = Object.keys(genGroups).sort((a,b) => a-b).map(key => {
           let group = genGroups[key];
           const sortedGroup = [];
           const visited = new Set();
           
           group.forEach(p => {
             if (visited.has(p.id)) return;
             sortedGroup.push(p);
             visited.add(p.id);
             
             // –ò—â–µ–º –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ —ç—Ç–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞
             couples.forEach(c => {
               let partnerId = null;
               if (c.partner1Id === p.id) partnerId = c.partner2Id;
               else if (c.partner2Id === p.id) partnerId = c.partner1Id;
               
               if (partnerId && !visited.has(partnerId)) {
                 const partner = group.find(gp => gp.id === partnerId);
                 if (partner) {
                   sortedGroup.push(partner);
                   visited.add(partnerId);
                 }
               }
             });
           });
           return sortedGroup;
        });

        setGenerations(sortedGens);
      }, [people, couples]);

      // 2. –†–∞—Å—á–µ—Ç SVG –ª–∏–Ω–∏–π
      const calculateLines = useCallback(() => {
        if (!containerRef.current) return;
        
        const newLines = [];
        const containerRect = containerRef.current.getBoundingClientRect();
        
        // –ß—Ç–æ–±—ã SVG –ø–æ–∫—Ä—ã–≤–∞–ª –≤—Å—é –æ–±–ª–∞—Å—Ç—å –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
        const scrollWidth = containerRef.current.scrollWidth;
        const scrollHeight = containerRef.current.scrollHeight;
        setDims({ w: scrollWidth, h: scrollHeight });

        // –§—É–Ω–∫—Ü–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —Ü–µ–Ω—Ç—Ä–∞ –Ω–æ–¥—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        const getPos = (id) => {
           const el = document.getElementById(`node-${id}`);
           if (!el) return null;
           const rect = el.getBoundingClientRect();
           
           // –£—á–∏—Ç—ã–≤–∞–µ–º —Å–∫—Ä–æ–ª–ª –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
           const scrollLeft = containerRef.current.scrollLeft;
           const scrollTop = containerRef.current.scrollTop;

           // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (—Å —É—á–µ—Ç–æ–º –ø—Ä–æ–∫—Ä—É—Ç–∫–∏)
           const left = rect.left - containerRect.left + scrollLeft;
           const top = rect.top - containerRect.top + scrollTop;
           
           return {
             x: left + rect.width / 2,
             y: top + rect.height / 2,
             top: top,
             bottom: top + rect.height,
             left: left,
             right: left + rect.width
           };
        };

        // –†–∏—Å—É–µ–º –ª–∏–Ω–∏–∏
        couples.forEach(c => {
           const p1 = getPos(c.partner1Id);
           const p2 = getPos(c.partner2Id);
           
           // –ï—Å–ª–∏ –æ–±–∞ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ –Ω–∞ —ç–∫—Ä–∞–Ω–µ
           if (p1 && p2) {
             // 1. –õ–∏–Ω–∏—è –±—Ä–∞–∫–∞ (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –∏–ª–∏ –∏–∑–æ–≥–Ω—É—Ç–∞—è)
             const midX = (p1.x + p2.x) / 2;
             const midY = (p1.y + p2.y) / 2;
             
             // –ü—Ä–æ—Å—Ç–∞—è –ª–∏–Ω–∏—è –º–µ–∂–¥—É —Ü–µ–Ω—Ç—Ä–∞–º–∏
             newLines.push({
               id: `couple-${c.id}`,
               path: `M ${p1.x} ${p1.y} L ${p2.x} ${p2.y}`,
               color: '#f59e0b', // amber-500
               width: 3
             });

             // –¢–æ—á–∫–∞ –æ—Ç—Å—á–µ—Ç–∞ –¥–ª—è –¥–µ—Ç–µ–π - —Å–µ—Ä–µ–¥–∏–Ω–∞ –ª–∏–Ω–∏–∏ –±—Ä–∞–∫–∞
             const startChildrenX = midX;
             const startChildrenY = midY; 

             // 2. –õ–∏–Ω–∏–∏ –∫ –¥–µ—Ç—è–º
             if (c.childrenIds && c.childrenIds.length > 0) {
               c.childrenIds.forEach(childId => {
                 const childPos = getPos(childId);
                 if (childPos) {
                   // –ö—Ä–∏–≤–∞—è –ë–µ–∑—å–µ: –æ—Ç (—Å–µ—Ä–µ–¥–∏–Ω–∞ —Ä–æ–¥–∏—Ç–µ–ª–µ–π) –≤–Ω–∏–∑ –¥–æ (–≤–µ—Ä—Ö —Ä–µ–±–µ–Ω–∫–∞)
                   // –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Ç–æ—á–∫–∏ —Å–æ–∑–¥–∞—é—Ç S-–æ–±—Ä–∞–∑–Ω—ã–π –∏–∑–≥–∏–±
                   const verticalGap = childPos.top - startChildrenY;
                   
                   newLines.push({
                     id: `link-${c.id}-${childId}`,
                     path: `M ${startChildrenX} ${startChildrenY} 
                            C ${startChildrenX} ${startChildrenY + verticalGap/2}, 
                              ${childPos.x} ${childPos.top - verticalGap/2}, 
                              ${childPos.x} ${childPos.top}`,
                     color: '#94a3b8', // slate-400
                     width: 2
                   });
                 }
               });
             }
           }
        });

        setLines(newLines);
      }, [generations, couples]);

      // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –ª–∏–Ω–∏–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∏ —Ä–µ—Å–∞–π–∑–µ
      useLayoutEffect(() => {
        calculateLines();
        window.addEventListener('resize', calculateLines);
        // –ù–µ–±–æ–ª—å—à–æ–π —Ç–∞–π–º-–∞—É—Ç, —á—Ç–æ–±—ã –¥–∞—Ç—å DOM –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å—Å—è
        const t = setTimeout(calculateLines, 100);
        return () => {
            window.removeEventListener('resize', calculateLines);
            clearTimeout(t);
        }
      }, [calculateLines]);

      return (
        <div 
            className="relative bg-slate-50 flex-1 overflow-auto border-t border-slate-200" 
            ref={containerRef}
            style={{ minHeight: '600px' }}
        >
          {/* –°–ª–æ–π –ª–∏–Ω–∏–π SVG */}
          <svg 
            className="absolute top-0 left-0 pointer-events-none z-0" 
            style={{ width: dims.w, height: dims.h }}
          >
             {lines.map(line => (
               <path 
                 key={line.id} 
                 d={line.path} 
                 stroke={line.color} 
                 strokeWidth={line.width} 
                 fill="none" 
                 strokeLinecap="round"
               />
             ))}
          </svg>

          {/* –°–ª–æ–π –∫–∞—Ä—Ç–æ—á–µ–∫ (–°–µ—Ç–∫–∞) */}
          <div className="flex flex-col gap-24 py-16 px-8 relative z-10 w-max mx-auto min-w-full items-center">
            {generations.map((gen, gIdx) => (
              <div key={gIdx} className="flex flex-row gap-12 justify-center">
                 {gen.map(person => (
                   <div 
                     id={`node-${person.id}`}
                     key={person.id}
                     className="bg-white border-2 border-slate-300 rounded-xl p-3 shadow-md w-40 text-center flex flex-col items-center relative hover:border-blue-500 hover:shadow-lg transition-all cursor-pointer group"
                     onClick={() => onEdit(person)}
                   >
                     {/* –§–æ—Ç–æ */}
                     <div className="w-16 h-16 rounded-full bg-slate-100 mb-2 overflow-hidden border border-slate-200 flex items-center justify-center">
                        {person.photoUrl ? (
                           <img src={person.photoUrl} className="w-full h-full object-cover" alt="" />
                        ) : (
                           <span className="text-2xl">üë§</span>
                        )}
                     </div>
                     {/* –ò–º—è */}
                     <div className="text-sm font-bold text-slate-800 leading-tight">
                       {person.firstName}
                     </div>
                     <div className="text-xs text-slate-500 leading-tight mb-2">
                       {person.lastName}
                     </div>
                     
                     {/* –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–≤—è–∑–∏ (–ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏) */}
                     <button 
                        onClick={(e) => { e.stopPropagation(); onAddRelative(person); }}
                        className="opacity-0 group-hover:opacity-100 absolute -bottom-3 bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs shadow-sm hover:scale-110 transition-all"
                        title="–î–æ–±–∞–≤–∏—Ç—å —Å–≤—è–∑—å"
                     >
                        +
                     </button>
                   </div>
                 ))}
              </div>
            ))}
          </div>
        </div>
      );
    };

    // --- –û–°–ù–û–í–ù–û–ô –ö–û–ú–ü–û–ù–ï–ù–¢ APP ---

    function App() {
      // –î–∞–Ω–Ω—ã–µ
      const [people, setPeople] = useState([
        { id: 'p1', firstName: '–ò–≤–∞–Ω', lastName: '–ò–≤–∞–Ω–æ–≤', gender: 'male', photoUrl: '' },
        { id: 'p2', firstName: '–ú–∞—Ä–∏—è', lastName: '–ò–≤–∞–Ω–æ–≤–∞', gender: 'female', photoUrl: '' },
        { id: 'p3', firstName: '–ü–µ—Ç—Ä', lastName: '–ü–µ—Ç—Ä–æ–≤', gender: 'male', photoUrl: '' },
        { id: 'p4', firstName: '–ê–Ω–Ω–∞', lastName: '–ü–µ—Ç—Ä–æ–≤–∞', gender: 'female', photoUrl: '' },
        { id: 'p5', firstName: '–ê–ª–µ–∫—Å–µ–π', lastName: '–ò–≤–∞–Ω–æ–≤', gender: 'male', photoUrl: '' }, // –°—ã–Ω –ò–≤–∞–Ω–æ–≤—ã—Ö
        { id: 'p6', firstName: '–ï–ª–µ–Ω–∞', lastName: '–ü–µ—Ç—Ä–æ–≤–∞', gender: 'female', photoUrl: '' }, // –î–æ—á—å –ü–µ—Ç—Ä–æ–≤—ã—Ö
        { id: 'p7', firstName: '–î–º–∏—Ç—Ä–∏–π', lastName: '–ò–≤–∞–Ω–æ–≤', gender: 'male', photoUrl: '' }  // –í–Ω—É–∫ (—Å—ã–Ω –ê–ª–µ–∫—Å–µ—è –∏ –ï–ª–µ–Ω—ã)
      ]);

      const [couples, setCouples] = useState([
        { id: 'c1', partner1Id: 'p1', partner2Id: 'p2', childrenIds: ['p5'] }, // –ò–≤–∞–Ω–æ–≤—ã -> –ê–ª–µ–∫—Å–µ–π
        { id: 'c2', partner1Id: 'p3', partner2Id: 'p4', childrenIds: ['p6'] }, // –ü–µ—Ç—Ä–æ–≤—ã -> –ï–ª–µ–Ω–∞
        { id: 'c3', partner1Id: 'p5', partner2Id: 'p6', childrenIds: ['p7'] }  // –ê–ª–µ–∫—Å–µ–π + –ï–ª–µ–Ω–∞ -> –î–º–∏—Ç—Ä–∏–π
      ]);

      // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ—Ä–Ω–µ–π (–¥–ª—è —Ä–µ–∂–∏–º–∞ –î–µ—Ä–µ–≤–æ)
      const [rootIds, setRootIds] = useState([]); 

      // –°–æ—Å—Ç–æ—è–Ω–∏–µ UI
      const [viewMode, setViewMode] = useState('tree'); // 'tree' | 'graph'
      const [isModalOpen, setIsModalOpen] = useState(false);
      const [modalMode, setModalMode] = useState('add'); // 'add', 'edit', 'addRel'
      const [selectedPerson, setSelectedPerson] = useState(null);
      const [isRootsModalOpen, setIsRootsModalOpen] = useState(false);

      // –§–æ—Ä–º–∞
      const [formData, setFormData] = useState({
        firstName: '', lastName: '', gender: 'male', photoUrl: '', birthDate: '', deathDate: '', bio: ''
      });
      const [relData, setRelData] = useState({ type: 'partner' }); // type: 'partner' | 'child' | 'parent'

      // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ LocalStorage (—É–ø—Ä–æ—â–µ–Ω–æ)
      useEffect(() => {
        const savedP = localStorage.getItem('ft_people');
        const savedC = localStorage.getItem('ft_couples');
        const savedR = localStorage.getItem('ft_roots');
        if (savedP) setPeople(JSON.parse(savedP));
        if (savedC) setCouples(JSON.parse(savedC));
        if (savedR) setRootIds(JSON.parse(savedR));
      }, []);

      useEffect(() => {
        localStorage.setItem('ft_people', JSON.stringify(people));
        localStorage.setItem('ft_couples', JSON.stringify(couples));
        localStorage.setItem('ft_roots', JSON.stringify(rootIds));
      }, [people, couples, rootIds]);

      // --- –õ–û–ì–ò–ö–ê –î–ê–ù–ù–´–• ---

      const handleAddPerson = () => {
        setFormData({ firstName: '', lastName: '', gender: 'male', photoUrl: '', birthDate: '', deathDate: '', bio: '' });
        setModalMode('add');
        setIsModalOpen(true);
      };

      const handleEditPerson = (person) => {
        setSelectedPerson(person);
        setFormData({ ...person });
        setModalMode('edit');
        setIsModalOpen(true);
      };

      const handleAddRelative = (person) => {
        setSelectedPerson(person);
        setFormData({ firstName: '', lastName: '', gender: 'male', photoUrl: '', birthDate: '', deathDate: '', bio: '' });
        setRelData({ type: 'partner' }); // default
        setModalMode('addRel');
        setIsModalOpen(true);
      };

      const savePerson = () => {
        if (modalMode === 'add') {
          const newPerson = { id: generateId(), ...formData };
          setPeople([...people, newPerson]);
        } 
        else if (modalMode === 'edit') {
          setPeople(people.map(p => p.id === selectedPerson.id ? { ...p, ...formData } : p));
        }
        else if (modalMode === 'addRel') {
          // –õ–æ–≥–∏–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫–∞
          const newPerson = { id: generateId(), ...formData };
          const updatedPeople = [...people, newPerson];
          const updatedCouples = [...couples];

          if (relData.type === 'partner') {
            // –°–æ–∑–¥–∞–µ–º –ø–∞—Ä—É
            updatedCouples.push({
               id: generateId(),
               partner1Id: selectedPerson.id,
               partner2Id: newPerson.id,
               childrenIds: []
            });
          } else if (relData.type === 'child') {
            // –ò—â–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ø–∞—Ä—É —Ç–µ–∫—É—â–µ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞ –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º
            // (–£–ø—Ä–æ—â–µ–Ω–Ω–æ: –±–µ—Ä–µ–º –ø–µ—Ä–≤—É—é –ø–æ–ø–∞–≤—à—É—é—Å—è –ø–∞—Ä—É, –≥–¥–µ –æ–Ω –µ—Å—Ç—å, –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º "–æ–¥–∏–Ω–æ–∫—É—é")
            let couple = updatedCouples.find(c => c.partner1Id === selectedPerson.id || c.partner2Id === selectedPerson.id);
            if (couple) {
               couple.childrenIds = [...(couple.childrenIds || []), newPerson.id];
            } else {
               updatedCouples.push({
                 id: generateId(),
                 partner1Id: selectedPerson.id,
                 partner2Id: null, // –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–∞—Ä—Ç–Ω–µ—Ä
                 childrenIds: [newPerson.id]
               });
            }
          } else if (relData.type === 'parent') {
             // –°–æ–∑–¥–∞–µ–º –ø–∞—Ä—É —Ä–æ–¥–∏—Ç–µ–ª–µ–π, –¥–æ–±–∞–≤–ª—è–µ–º —Ç—É–¥–∞ —Ç–µ–∫—É—â–µ–≥–æ –∫–∞–∫ —Ä–µ–±–µ–Ω–∫–∞
             updatedCouples.push({
               id: generateId(),
               partner1Id: newPerson.id,
               partner2Id: null, 
               childrenIds: [selectedPerson.id]
             });
          }

          setPeople(updatedPeople);
          setCouples(updatedCouples);
        }
        setIsModalOpen(false);
      };

      const handleDeletePerson = () => {
        if (!selectedPerson) return;
        if (!confirm(`–£–¥–∞–ª–∏—Ç—å ${selectedPerson.firstName}?`)) return;
        
        // –£–¥–∞–ª—è–µ–º —á–µ–ª–æ–≤–µ–∫–∞
        setPeople(people.filter(p => p.id !== selectedPerson.id));
        // –£–¥–∞–ª—è–µ–º –ø–∞—Ä—ã –≥–¥–µ –æ–Ω –ø–∞—Ä—Ç–Ω–µ—Ä
        // (–ú–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å: –µ—Å–ª–∏ —É–¥–∞–ª—è–µ–º –ø–∞—Ä—Ç–Ω–µ—Ä–∞, –ø–∞—Ä—É –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–ª—è—Ç—å —Å null)
        const newCouples = couples.filter(c => c.partner1Id !== selectedPerson.id && c.partner2Id !== selectedPerson.id);
        
        // –£–¥–∞–ª—è–µ–º –µ–≥–æ –∏–∑ –¥–µ—Ç–µ–π –≤–æ –≤—Å–µ—Ö –ø–∞—Ä–∞—Ö
        newCouples.forEach(c => {
           if(c.childrenIds) c.childrenIds = c.childrenIds.filter(id => id !== selectedPerson.id);
        });
        
        setCouples(newCouples);
        setIsModalOpen(false);
      };
      
      const resetData = () => {
         if(confirm("–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∫ –¥–µ–º–æ-–ø—Ä–∏–º–µ—Ä—É?")) {
            localStorage.clear();
            window.location.reload();
         }
      };

      // --- –†–ï–ù–î–ï–† –î–ï–†–ï–í–ê (–†–ï–ö–£–†–°–ò–í–ù–´–ô) ---
      // –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ "–î–µ—Ä–µ–≤–æ"
      const TreeNode = ({ person }) => {
        if (!person) return null;

        // –ù–∞—Ö–æ–¥–∏–º –ø–∞—Ä—ã, –≥–¥–µ —ç—Ç–æ—Ç —á–µ–ª–æ–≤–µ–∫ - –æ–¥–∏–Ω –∏–∑ –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤
        const myCouples = couples.filter(c => c.partner1Id === person.id || c.partner2Id === person.id);

        return (
          <li>
            <div className="inline-block relative">
               <div 
                 className="bg-white border border-slate-300 rounded-lg p-3 shadow hover:shadow-md cursor-pointer min-w-[120px]"
                 onClick={() => handleEditPerson(person)}
               >
                 <div className="font-bold">{person.firstName}</div>
                 <div className="text-xs text-slate-500">{person.lastName}</div>
                 <div className="absolute -top-2 -right-2 bg-blue-100 text-blue-600 rounded-full w-5 h-5 flex items-center justify-center text-xs cursor-pointer hover:bg-blue-200"
                      onClick={(e) => { e.stopPropagation(); handleAddRelative(person); }}>+</div>
               </div>
            </div>

            {/* –ï—Å–ª–∏ –µ—Å—Ç—å —Å—É–ø—Ä—É–≥(–∏) –∏ –¥–µ—Ç–∏ */}
            {myCouples.length > 0 && (
               <div className="flex justify-center pt-4">
                 {myCouples.map(c => {
                    const partnerId = c.partner1Id === person.id ? c.partner2Id : c.partner1Id;
                    const partner = people.find(p => p.id === partnerId);
                    const children = (c.childrenIds || []).map(id => people.find(p => p.id === id)).filter(Boolean);

                    return (
                      <div key={c.id} className="mx-4 border-t-2 border-slate-300 pt-2 relative">
                         {/* –ü–∞—Ä—Ç–Ω–µ—Ä */}
                         {partner && (
                           <div 
                             className="bg-white border border-amber-300 rounded-lg p-2 shadow mb-4 inline-block mx-auto"
                             onClick={() => handleEditPerson(partner)}
                           >
                              <span className="text-xs text-amber-600">‚ù§</span> {partner.firstName}
                           </div>
                         )}
                         
                         {/* –î–µ—Ç–∏ */}
                         {children.length > 0 && (
                           <ul>
                             {children.map(child => <TreeNode key={child.id} person={child} />)}
                           </ul>
                         )}
                      </div>
                    );
                 })}
               </div>
            )}
          </li>
        );
      };

      // –í—ã–±–æ—Ä –∫–æ—Ä–Ω–µ–π –¥–ª—è –î–µ—Ä–µ–≤–∞
      const getRootPeople = () => {
         if (rootIds.length > 0) {
            return rootIds.map(id => people.find(p => p.id === id)).filter(Boolean);
         }
         // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏: —Ç–µ, –∫—Ç–æ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –Ω–∏—á—å–∏–º —Ä–µ–±–µ–Ω–∫–æ–º
         const allChildren = new Set();
         couples.forEach(c => (c.childrenIds || []).forEach(id => allChildren.add(id)));
         return people.filter(p => !allChildren.has(p.id));
      };

      // --- –ò–ù–¢–ï–†–§–ï–ô–° ---

      return (
        <div className="flex flex-col h-full">
          {/* –•–µ–¥–µ—Ä */}
          <header className="bg-white shadow px-6 py-3 flex justify-between items-center z-20 relative">
            <h1 className="text-xl font-bold text-slate-700 flex items-center gap-2">
              üå≥ –°–µ–º–µ–π–Ω–æ–µ –î—Ä–µ–≤–æ
            </h1>
            <div className="flex gap-2">
              <button onClick={handleAddPerson} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition">
                + –î–æ–±–∞–≤–∏—Ç—å —á–µ–ª–æ–≤–µ–∫–∞
              </button>
              <button onClick={() => setIsRootsModalOpen(true)} className="bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-2 rounded-lg text-sm transition" title="–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–æ—Ä–Ω–∏ –¥–µ—Ä–µ–≤–∞">
                ‚öôÔ∏è –ö–æ—Ä–Ω–∏
              </button>
              <button onClick={resetData} className="bg-red-50 hover:bg-red-100 text-red-600 px-3 py-2 rounded-lg text-sm transition">
                –°–±—Ä–æ—Å
              </button>
            </div>
          </header>

          {/* –ü–∞–Ω–µ–ª—å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ */}
          <div className="bg-slate-50 border-b border-slate-200 px-6 py-2 flex justify-center gap-4 z-20 relative">
             <button 
                onClick={() => setViewMode('tree')}
                className={`px-6 py-1.5 rounded-full text-sm font-medium transition-all ${viewMode === 'tree' ? 'bg-white shadow text-blue-600 ring-1 ring-slate-200' : 'text-slate-500 hover:text-slate-700'}`}
             >
               üå≥ –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–µ –¥–µ—Ä–µ–≤–æ
             </button>
             <button 
                onClick={() => setViewMode('graph')}
                className={`px-6 py-1.5 rounded-full text-sm font-medium transition-all ${viewMode === 'graph' ? 'bg-white shadow text-amber-600 ring-1 ring-slate-200' : 'text-slate-500 hover:text-slate-700'}`}
             >
               üï∏Ô∏è –û–±—â–∏–π –≥—Ä–∞—Ñ (–°–µ—Ç–∫–∞)
             </button>
          </div>

          {/* –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å */}
          <main className="flex-1 relative bg-slate-100 overflow-hidden flex flex-col">
            {viewMode === 'tree' ? (
               <div className="tree w-full h-full overflow-auto cursor-grab active:cursor-grabbing p-8">
                 <ul>
                   {getRootPeople().map(p => <TreeNode key={p.id} person={p} />)}
                 </ul>
               </div>
            ) : (
               <FamilyGraph 
                  people={people} 
                  couples={couples} 
                  onEdit={handleEditPerson}
                  onAddRelative={handleAddRelative}
               />
            )}
          </main>

          {/* –ú–û–î–ê–õ–ö–ê –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø/–î–û–ë–ê–í–õ–ï–ù–ò–Ø */}
          {isModalOpen && (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
              <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-[fadeIn_0.2s]">
                <div className="bg-slate-50 px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                  <h3 className="font-bold text-lg text-slate-800">
                    {modalMode === 'add' ? '–ù–æ–≤—ã–π —á–µ–ª–æ–≤–µ–∫' : modalMode === 'edit' ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ' : '–î–æ–±–∞–≤–∏—Ç—å —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫–∞'}
                  </h3>
                  <button onClick={() => setIsModalOpen(false)} className="text-slate-400 hover:text-slate-600">‚úï</button>
                </div>
                
                <div className="p-6 space-y-4">
                   {modalMode === 'addRel' && selectedPerson && (
                     <div className="bg-blue-50 text-blue-800 p-3 rounded-lg text-sm mb-4">
                       –î–æ–±–∞–≤–ª—è–µ–º —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫–∞ –¥–ª—è: <strong>{selectedPerson.firstName} {selectedPerson.lastName}</strong>
                       <div className="mt-2 flex gap-2">
                         <label className="flex items-center gap-1 cursor-pointer">
                           <input type="radio" name="relType" checked={relData.type === 'partner'} onChange={() => setRelData({...relData, type: 'partner'})} />
                           –ü–∞—Ä—Ç–Ω–µ—Ä
                         </label>
                         <label className="flex items-center gap-1 cursor-pointer">
                           <input type="radio" name="relType" checked={relData.type === 'child'} onChange={() => setRelData({...relData, type: 'child'})} />
                           –†–µ–±–µ–Ω–æ–∫
                         </label>
                         <label className="flex items-center gap-1 cursor-pointer">
                           <input type="radio" name="relType" checked={relData.type === 'parent'} onChange={() => setRelData({...relData, type: 'parent'})} />
                           –†–æ–¥–∏—Ç–µ–ª—å
                         </label>
                       </div>
                     </div>
                   )}

                   <div className="grid grid-cols-2 gap-4">
                     <div>
                       <label className="block text-xs font-semibold text-slate-500 mb-1">–ò–º—è</label>
                       <input 
                         className="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none"
                         value={formData.firstName} onChange={e => setFormData({...formData, firstName: e.target.value})}
                       />
                     </div>
                     <div>
                       <label className="block text-xs font-semibold text-slate-500 mb-1">–§–∞–º–∏–ª–∏—è</label>
                       <input 
                         className="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none"
                         value={formData.lastName} onChange={e => setFormData({...formData, lastName: e.target.value})}
                       />
                     </div>
                   </div>

                   <div>
                     <label className="block text-xs font-semibold text-slate-500 mb-1">–ü–æ–ª</label>
                     <select 
                        className="w-full border border-slate-300 rounded-lg px-3 py-2"
                        value={formData.gender} onChange={e => setFormData({...formData, gender: e.target.value})}
                     >
                       <option value="male">–ú—É–∂—Å–∫–æ–π</option>
                       <option value="female">–ñ–µ–Ω—Å–∫–∏–π</option>
                     </select>
                   </div>

                   <div>
                     <label className="block text-xs font-semibold text-slate-500 mb-1">–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ</label>
                     <input 
                       className="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none text-sm"
                       placeholder="https://..."
                       value={formData.photoUrl} onChange={e => setFormData({...formData, photoUrl: e.target.value})}
                     />
                   </div>
                </div>

                <div className="bg-slate-50 px-6 py-4 flex gap-3">
                  {modalMode === 'edit' && (
                    <button onClick={handleDeletePerson} className="px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg text-sm font-medium transition">
                      –£–¥–∞–ª–∏—Ç—å
                    </button>
                  )}
                  <div className="flex-1"></div>
                  <button onClick={() => setIsModalOpen(false)} className="px-4 py-2 text-slate-600 hover:bg-slate-200 rounded-lg text-sm font-medium transition">
                    –û—Ç–º–µ–Ω–∞
                  </button>
                  <button onClick={savePerson} className="px-6 py-2 bg-blue-600 text-white hover:bg-blue-700 rounded-lg text-sm font-medium shadow transition">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* –ú–û–î–ê–õ–ö–ê –í–´–ë–û–†–ê –ö–û–†–ù–ï–ô (–î–ª—è –¥–µ—Ä–µ–≤–∞) */}
          {isRootsModalOpen && (
             <RootsModal 
               isOpen={isRootsModalOpen} 
               onClose={() => setIsRootsModalOpen(false)}
               people={people}
               couples={couples}
               currentRoots={rootIds}
               onSave={(newRoots) => { setRootIds(newRoots); setIsRootsModalOpen(false); }}
             />
          )}

        </div>
      );
    }

    // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –º–æ–¥–∞–ª–∫–∏ –∫–æ—Ä–Ω–µ–π (–≤—ã–Ω–µ—Å–µ–Ω –æ—Ç–¥–µ–ª—å–Ω–æ –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏)
    const RootsModal = ({ isOpen, onClose, people, couples, currentRoots, onSave }) => {
       const [selected, setSelected] = useState(currentRoots);

       // –ù–∞—Ö–æ–¥–∏–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∫–æ—Ä–Ω–∏ –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–∫–∏
       const autoRoots = useMemo(() => {
          const allChildren = new Set();
          couples.forEach(c => (c.childrenIds || []).forEach(id => allChildren.add(id)));
          return people.filter(p => !allChildren.has(p.id));
       }, [people, couples]);

       const toggle = (id) => {
         if (selected.includes(id)) setSelected(selected.filter(x => x !== id));
         else setSelected([...selected, id]);
       };

       return (
         <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
           <div className="bg-white rounded-2xl shadow-xl w-full max-w-lg flex flex-col max-h-[80vh]">
             <div className="p-4 border-b">
               <h3 className="font-bold text-lg">–í—ã–±–æ—Ä –∫–æ—Ä–Ω–µ–π (–¥–ª—è –≤–∏–¥–∞ –î–µ—Ä–µ–≤–æ)</h3>
             </div>
             <div className="p-4 overflow-auto flex-1">
               <p className="text-sm text-slate-500 mb-4">–û—Ç–º–µ—Ç—å—Ç–µ –ª—é–¥–µ–π, —Å –∫–æ—Ç–æ—Ä—ã—Ö –±—É–¥—É—Ç –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è –≤–µ—Ç–∫–∏ –≤ —Ä–µ–∂–∏–º–µ "–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–µ –¥–µ—Ä–µ–≤–æ". –í —Ä–µ–∂–∏–º–µ "–ì—Ä–∞—Ñ" —ç—Ç–æ –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ.</p>
               <div className="space-y-2">
                 {people.map(p => {
                    const isAuto = autoRoots.find(ar => ar.id === p.id);
                    return (
                      <label key={p.id} className="flex items-center gap-3 p-2 hover:bg-slate-50 rounded cursor-pointer border border-transparent hover:border-slate-200">
                        <input type="checkbox" checked={selected.includes(p.id)} onChange={() => toggle(p.id)} className="w-5 h-5 text-blue-600 rounded" />
                        <div>
                           <div className="font-medium">{p.firstName} {p.lastName}</div>
                           {isAuto && <div className="text-xs text-green-600">–ê–≤—Ç–æ-–∫–æ—Ä–µ–Ω—å (–Ω–µ—Ç —Ä–æ–¥–∏—Ç–µ–ª–µ–π –≤ –±–∞–∑–µ)</div>}
                        </div>
                      </label>
                    );
                 })}
               </div>
             </div>
             <div className="p-4 border-t flex justify-end gap-2">
               <button onClick={onClose} className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg">–û—Ç–º–µ–Ω–∞</button>
               <button onClick={() => onSave(selected)} className="px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 rounded-lg">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
             </div>
           </div>
         </div>
       );
    };

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
